<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Resume - AI-Powered ATS Resume Builder</title>
<!-- PDF Export Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;line-height:1.6}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{text-align:center;padding:30px 0;border-bottom:1px solid #222}
h1{font-size:2.5em;background:linear-gradient(135deg,#6366f1,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.subtitle{color:#888;font-size:1.1em}
.tabs{display:flex;gap:10px;margin:30px 0;flex-wrap:wrap}
.tab{padding:12px 24px;background:#1a1a1a;border:1px solid #333;border-radius:8px;cursor:pointer;transition:all 0.2s}
.tab:hover{border-color:#6366f1}
.tab.active{background:#6366f1;border-color:#6366f1;color:#fff}
.tab-badge{background:#ef4444;color:#fff;font-size:0.7em;padding:2px 6px;border-radius:10px;margin-left:6px}
.panel{display:none;background:#111;border:1px solid #222;border-radius:12px;padding:30px}
.panel.active{display:block}
h2{font-size:1.5em;margin-bottom:20px;color:#fff}
h3{font-size:1.2em;margin:20px 0 15px;color:#a5a5a5}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#888;font-size:0.9em}
input,textarea,select{width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:1em}
input:focus,textarea:focus,select:focus{outline:none;border-color:#6366f1}
textarea{min-height:120px;resize:vertical;font-family:inherit}
button{padding:12px 24px;background:#6366f1;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:1em;transition:all 0.2s}
button:hover{background:#5558e3}
button:disabled{opacity:0.5;cursor:not-allowed}
button.secondary{background:#333}
button.secondary:hover{background:#444}
button.danger{background:#ef4444}
button.danger:hover{background:#dc2626}
button.success{background:#10b981}
button.success:hover{background:#059669}
button.small{padding:6px 12px;font-size:0.85em}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:15px}
.card{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px}
.card h4{margin-bottom:15px;color:#fff}
.card.highlight{border-color:#6366f1;background:linear-gradient(135deg,#1a1a2e,#16213e)}
.item{background:#222;border-radius:8px;padding:15px;margin-bottom:10px;position:relative}
.item-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.item-title{font-weight:600;color:#fff}
.item-subtitle{color:#888;font-size:0.9em}
.item-actions{display:flex;gap:8px}
.item-actions button{padding:5px 10px;font-size:0.8em}
.bullets{margin-top:10px}
.bullet{display:flex;gap:10px;margin-bottom:8px;align-items:start}
.bullet-dot{color:#6366f1;margin-top:2px}
.add-btn{width:100%;padding:15px;background:#1a1a1a;border:2px dashed #333;border-radius:8px;color:#888;cursor:pointer;transition:all 0.2s}
.add-btn:hover{border-color:#6366f1;color:#6366f1}
.tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.tag{background:#333;padding:6px 12px;border-radius:20px;font-size:0.85em;display:flex;align-items:center;gap:6px}
.tag-remove{cursor:pointer;color:#888}
.tag-remove:hover{color:#ef4444}
.tech-tag{background:linear-gradient(135deg,#1e3a5f,#1a1a2e);padding:4px 10px;border-radius:12px;font-size:0.8em;color:#60a5fa;border:1px solid #2563eb33;white-space:nowrap}
.feature-chip{background:#1a1a2e;padding:6px 12px;border-radius:8px;font-size:0.85em;color:#a5b4fc;border:1px solid #4f46e533;line-height:1.4}
.ai-badge{background:linear-gradient(135deg,#8b5cf6,#6366f1);padding:3px 10px;border-radius:12px;font-size:0.7em;color:#fff;font-weight:500;white-space:nowrap}
.tag-input{display:flex;gap:10px;margin-top:10px}
.tag-input input{flex:1}
.tag-input button{white-space:nowrap}
.resources-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.resource-card{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px}
.resource-card h4{color:#6366f1;margin-bottom:10px}
.resource-list{list-style:none}
.resource-list li{padding:8px 0;border-bottom:1px solid #222;color:#aaa}
.resource-list li:last-child{border-bottom:none}
.generate-section{text-align:center;padding:40px}
.generate-section h2{margin-bottom:20px}
.generate-btn{font-size:1.2em;padding:16px 40px;background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.generate-btn:hover{opacity:0.9}
.output-section{margin-top:30px}
.score-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #333;border-radius:12px;padding:30px;text-align:center;margin-bottom:20px}
.score{font-size:4em;font-weight:700;background:linear-gradient(135deg,#00ff88,#00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.score-label{color:#888;margin-top:10px}
.keywords{margin-top:20px}
.keyword-match{display:inline-block;background:#00ff8820;color:#00ff88;padding:4px 10px;border-radius:15px;font-size:12px;margin:3px}
.keyword-missing{display:inline-block;background:#ff6b6b20;color:#ff6b6b;padding:4px 10px;border-radius:15px;font-size:12px;margin:3px}
.resume-output{background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:30px;white-space:pre-wrap;font-family:'Courier New',monospace;line-height:1.8}
.copy-btn{position:absolute;top:15px;right:15px}
.loading{display:none;text-align:center;padding:40px}
.loading.active{display:block}
.spinner{width:50px;height:50px;border:4px solid #333;border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#111;border:1px solid #333;border-radius:12px;padding:30px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-close{background:none;border:none;color:#888;font-size:1.5em;cursor:pointer}
.status{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
.status.success{display:block;background:rgba(0,255,136,0.1);border:1px solid #00ff88;color:#00ff88}
.status.error{display:block;background:rgba(255,107,107,0.1);border:1px solid #ff6b6b;color:#ff6b6b}

/* Dashboard Styles */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #333;border-radius:12px;padding:25px;text-align:center}
.stat-value{font-size:3em;font-weight:700;color:#6366f1}
.stat-label{color:#888;margin-top:5px;font-size:0.9em}
.stat-card.success .stat-value{color:#10b981}
.stat-card.warning .stat-value{color:#f59e0b}
.stat-card.danger .stat-value{color:#ef4444}
.activity-list{max-height:400px;overflow-y:auto}
.activity-item{display:flex;align-items:center;gap:15px;padding:15px;border-bottom:1px solid #222}
.activity-icon{width:40px;height:40px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:1.2em}
.activity-content{flex:1}
.activity-title{color:#fff;font-weight:500}
.activity-meta{color:#666;font-size:0.85em}

/* Resume Library Styles */
.library-filters{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.library-filters select{width:auto;min-width:150px}
.resume-list{display:grid;gap:15px}
.resume-card{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;cursor:pointer;transition:all 0.2s}
.resume-card:hover{border-color:#6366f1;transform:translateY(-2px)}
.resume-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.resume-company{font-weight:600;color:#fff;font-size:1.1em}
.resume-title{color:#888;font-size:0.95em}
.resume-score{font-size:1.5em;font-weight:700}
.resume-score.high{color:#10b981}
.resume-score.medium{color:#f59e0b}
.resume-score.low{color:#ef4444}
.resume-meta{display:flex;gap:15px;margin-top:10px;color:#666;font-size:0.85em}
.status-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:0.8em;font-weight:500}
.status-badge.generated{background:#333;color:#888}
.status-badge.applied{background:rgba(99,102,241,0.2);color:#6366f1}
.status-badge.interviewing{background:rgba(245,158,11,0.2);color:#f59e0b}
.status-badge.offered{background:rgba(16,185,129,0.2);color:#10b981}
.status-badge.rejected{background:rgba(239,68,68,0.2);color:#ef4444}
.status-badge.withdrawn{background:rgba(107,114,128,0.2);color:#6b7280}

/* Batch Processing Styles */
.batch-jobs{display:grid;gap:20px}
.batch-job{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;position:relative}
.batch-job-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.batch-job-number{background:#6366f1;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
.remove-job{background:#333;border:none;color:#888;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1.2em}
.remove-job:hover{background:#ef4444;color:#fff}
.batch-results{margin-top:30px}
.comparison-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #6366f1;border-radius:12px;padding:25px;margin-bottom:20px}
.ranking-list{display:grid;gap:10px}
.ranking-item{display:flex;align-items:center;gap:15px;background:#222;padding:15px;border-radius:8px}
.ranking-position{font-size:1.5em;font-weight:700;color:#6366f1;width:40px}
.ranking-details{flex:1}
.ranking-company{font-weight:600;color:#fff}
.ranking-title{color:#888;font-size:0.9em}

/* Mobile Responsive */
@media(max-width:768px){
  .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
  .tabs{justify-content:center}
  .tab{padding:10px 16px;font-size:0.9em}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .modal-content{width:95%;padding:20px}
}
</style>
</head>
<body>
<div class="container">
<header>
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h1>Claude Resume</h1>
<p class="subtitle">AI-Powered ATS Resume Builder - Tailored for Every Job</p>
</div>
<div id="authSection">
<button onclick="loginWithGoogle()" class="secondary" style="display:flex;align-items:center;gap:10px">
<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Sign in with Google
</button>
</div>
</div>
<div id="userInfo" style="display:none;text-align:right;margin-top:10px">
<span id="userName" style="color:#888"></span>
<button onclick="logout()" class="secondary" style="margin-left:10px;padding:6px 12px;font-size:0.85em">Logout</button>
</div>
</header>

<div class="tabs">
<div class="tab active" data-tab="dashboard">Dashboard</div>
<div class="tab" data-tab="profile">Profile</div>
<div class="tab" data-tab="experience">Experience</div>
<div class="tab" data-tab="skills">Skills</div>
<div class="tab" data-tab="projects">Projects</div>
<div class="tab" data-tab="generate">Generate</div>
<div class="tab" data-tab="batch">Batch Jobs</div>
<div class="tab" data-tab="library">Library<span class="tab-badge" id="libraryBadge" style="display:none">0</span></div>
<div class="tab" data-tab="resources">Best Practices</div>
</div>

<!-- Dashboard Panel -->
<div class="panel active" id="dashboard">
<h2>Dashboard</h2>

<div class="stats-grid" id="dashboardStats">
<div class="stat-card">
<div class="stat-value" id="statTotal">0</div>
<div class="stat-label">Total Resumes</div>
</div>
<div class="stat-card success">
<div class="stat-value" id="statAvgScore">0%</div>
<div class="stat-label">Avg Match Score</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statApplied">0</div>
<div class="stat-label">Applied</div>
</div>
<div class="stat-card warning">
<div class="stat-value" id="statInterviewing">0</div>
<div class="stat-label">Interviewing</div>
</div>
<div class="stat-card success">
<div class="stat-value" id="statOffered">0</div>
<div class="stat-label">Offers</div>
</div>
</div>

<div class="grid-2">
<div class="card">
<h4>Quick Actions</h4>
<div style="display:grid;gap:10px;margin-top:15px">
<button onclick="switchTab('generate')" style="text-align:left;padding:15px">
<strong>Generate New Resume</strong><br>
<span style="color:#888;font-size:0.9em">Tailor your resume for a specific job</span>
</button>
<button onclick="switchTab('batch')" class="secondary" style="text-align:left;padding:15px">
<strong>Batch Process Jobs</strong><br>
<span style="color:#888;font-size:0.9em">Compare fit across multiple positions</span>
</button>
<button onclick="switchTab('library')" class="secondary" style="text-align:left;padding:15px">
<strong>View Resume Library</strong><br>
<span style="color:#888;font-size:0.9em">Manage saved resumes and track applications</span>
</button>
</div>
</div>

<div class="card">
<h4>Recent Activity</h4>
<div class="activity-list" id="recentActivity">
<div style="color:#666;padding:20px;text-align:center">
<p>No recent activity</p>
<p style="font-size:0.9em;margin-top:10px">Generate your first tailored resume to get started</p>
</div>
</div>
</div>
</div>

<div class="card" style="margin-top:20px">
<h4>Profile Completeness</h4>
<div id="profileCompleteness" style="margin-top:15px">
<div style="display:flex;justify-content:space-between;margin-bottom:8px">
<span>Profile completion</span>
<span id="completenessPercent">0%</span>
</div>
<div style="background:#333;height:8px;border-radius:4px;overflow:hidden">
<div id="completenessBar" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);height:100%;width:0%;transition:width 0.3s"></div>
</div>
<div id="completenessHints" style="margin-top:15px;color:#888;font-size:0.9em"></div>
</div>
</div>
</div>

<!-- Profile Panel -->
<div class="panel" id="profile">

<!-- Import Section -->
<div class="card" style="margin-bottom:30px;background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#8b5cf6;margin-bottom:15px">Import Your Data</h4>

<div class="grid" style="margin-bottom:20px">
<div>
<label style="color:#0077b5;font-weight:600">LinkedIn Data Export</label>
<p style="color:#888;font-size:0.85em;margin:5px 0 10px">
<strong>Important:</strong> You need the <em>full</em> export, not the basic one.<br>
1. LinkedIn ‚Üí Settings ‚Üí Data Privacy ‚Üí Get a copy of your data<br>
2. Select "<strong>Download larger data archive</strong>" (takes 10min-24hrs)<br>
3. Upload the ZIP when you receive the email
</p>
<input type="file" id="linkedinZip" accept=".zip" onchange="parseLinkedInZip(this.files[0])" style="display:none">
<button onclick="document.getElementById('linkedinZip').click()" class="secondary" style="width:100%">
Upload LinkedIn ZIP
</button>
</div>
<div>
<label style="color:#6366f1;font-weight:600">Paste Resume Text</label>
<p style="color:#888;font-size:0.85em;margin:5px 0 10px">Copy/paste from any document</p>
<button onclick="document.getElementById('resumeTextModal').classList.add('active')" class="secondary" style="width:100%">
Paste Resume Text
</button>
</div>
</div>
<div id="importStatus" style="color:#00ff88;font-size:0.9em"></div>
</div>

<!-- Resume Text Modal -->
<div class="modal" id="resumeTextModal">
<div class="modal-content">
<div class="modal-header">
<h3>Paste Resume Text</h3>
<button class="modal-close" onclick="document.getElementById('resumeTextModal').classList.remove('active')">&times;</button>
</div>
<textarea id="importResume" rows="12" placeholder="Paste your resume text here..."></textarea>
<div style="margin-top:15px;display:flex;gap:10px">
<button onclick="parseResumeWithAI()">Parse with AI</button>
<span id="parseStatus" style="color:#888;line-height:45px"></span>
</div>
</div>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0">Personal Information</h2>
<span id="saveStatus" style="color:#00ff88;font-size:0.9em"></span>
</div>
<div class="grid">
<div class="form-group">
<label>Full Name</label>
<input type="text" id="fullName" placeholder="John Doe">
</div>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" placeholder="john@example.com">
</div>
<div class="form-group">
<label>Phone</label>
<input type="tel" id="phone" placeholder="+1 (555) 123-4567">
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="location" placeholder="New York, NY">
</div>
<div class="form-group">
<label>LinkedIn URL</label>
<input type="url" id="linkedin" placeholder="https://linkedin.com/in/johndoe">
</div>
<div class="form-group">
<label>GitHub URL</label>
<input type="url" id="github" placeholder="https://github.com/johndoe">
</div>
<div class="form-group">
<label>Portfolio/Website</label>
<input type="url" id="portfolio" placeholder="https://johndoe.com">
</div>
</div>
<div class="form-group">
<label>Professional Summary (Master version - will be tailored per job)</label>
<textarea id="summary" placeholder="Experienced software engineer with 5+ years..."></textarea>
</div>
<button onclick="saveProfile()">Save Profile</button>
</div>

<!-- Experience Panel -->
<div class="panel" id="experience">
<h2>Work Experience</h2>
<div id="experienceList"></div>
<div class="add-btn" onclick="openModal('experience')">+ Add Work Experience</div>

<h2 style="margin-top:40px">Education</h2>
<div id="educationList"></div>
<div class="add-btn" onclick="openModal('education')">+ Add Education</div>

<h2 style="margin-top:40px">Certifications</h2>
<div id="certsList"></div>
<div class="add-btn" onclick="openModal('cert')">+ Add Certification</div>
</div>

<!-- Skills Panel -->
<div class="panel" id="skills">
<div class="grid">
<div class="card">
<h4>Technical Skills</h4>
<div id="technicalSkills" class="tags"></div>
<div class="tag-input">
<input type="text" id="techSkillInput" placeholder="e.g., Python, React, AWS">
<button onclick="addSkill('technical')">Add</button>
</div>
</div>
<div class="card">
<h4>Soft Skills</h4>
<div id="softSkills" class="tags"></div>
<div class="tag-input">
<input type="text" id="softSkillInput" placeholder="e.g., Leadership, Communication">
<button onclick="addSkill('soft')">Add</button>
</div>
</div>
<div class="card">
<h4>Tools & Technologies</h4>
<div id="tools" class="tags"></div>
<div class="tag-input">
<input type="text" id="toolInput" placeholder="e.g., Git, Docker, Jira">
<button onclick="addSkill('tools')">Add</button>
</div>
</div>
<div class="card">
<h4>Interests & Hobbies</h4>
<p style="color:#888;font-size:0.9em;margin-bottom:10px">Personal touches that make you memorable</p>
<div id="interests" class="tags"></div>
<div class="tag-input">
<input type="text" id="interestInput" placeholder="e.g., Open source, Rock climbing">
<button onclick="addSkill('interests')">Add</button>
</div>
</div>
</div>
</div>

<!-- Projects Panel -->
<div class="panel" id="projects">
<h2>Projects & Portfolio</h2>
<p style="color:#888;margin-bottom:20px">Add projects that showcase your skills. These will be matched against job requirements and included in your tailored resume and cover letter.</p>

<div id="projectsList"></div>
<div class="add-btn" onclick="openModal('project')">+ Add Project</div>

<div class="card" style="margin-top:30px;background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#8b5cf6;margin-bottom:15px">Import from GitHub</h4>
<p style="color:#888;font-size:0.9em;margin-bottom:15px">Enter your GitHub username to browse and import your public repositories. <span style="color:#f59e0b">Note: These are public repos - anyone can view them on GitHub.</span></p>
<div class="form-group">
<label>GitHub Username or Profile URL</label>
<div style="display:flex;gap:10px">
<input type="text" id="githubUsername" placeholder="username or https://github.com/username" style="flex:1">
<button onclick="fetchGitHubRepos()" class="secondary">Fetch Repos</button>
</div>
</div>
<span id="githubFetchStatus" style="color:#888;font-size:0.9em"></span>
<div id="githubReposList" style="margin-top:15px;max-height:400px;overflow-y:auto"></div>
</div>
</div>

<!-- Project Modal -->
<div class="modal" id="projectModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="projectModalTitle">Add Project</h3>
<button class="modal-close" onclick="closeModal('project')">&times;</button>
</div>
<input type="hidden" id="projectEditIndex" value="-1">
<div class="form-group">
<label>Project Name</label>
<input type="text" id="projectName" placeholder="E-commerce Platform">
</div>
<div class="form-group">
<label>Short Description</label>
<input type="text" id="projectShortDesc" placeholder="Full-stack e-commerce solution with payment processing">
</div>
<div class="form-group">
<label>Technologies Used (comma-separated)</label>
<input type="text" id="projectTech" placeholder="React, Node.js, PostgreSQL, Stripe API">
</div>
<div class="grid-2">
<div class="form-group">
<label>GitHub/Repo URL</label>
<input type="url" id="projectUrl" placeholder="https://github.com/you/project">
</div>
<div class="form-group">
<label>Live Demo URL</label>
<input type="url" id="projectLiveUrl" placeholder="https://yourproject.com">
</div>
</div>
<div class="form-group">
<label>Key Features & Achievements (one per line)</label>
<textarea id="projectFeatures" rows="5" placeholder="Built real-time inventory management system
Integrated Stripe payments processing $50K+ monthly
Achieved 99.9% uptime with automated CI/CD pipeline
Reduced page load time by 60% through optimization"></textarea>
</div>
<div class="form-group">
<label>Detailed Description / README (optional - helps AI understand the project)</label>
<textarea id="projectReadme" rows="6" placeholder="Paste README content or detailed project description..."></textarea>
<div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">
<button type="button" onclick="aiExtractFromReadme()" class="secondary" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
  <span id="aiExtractBtnText">Extract with AI</span>
</button>
<span id="extractStatus" style="font-size:0.85em;color:#888"></span>
</div>
</div>
<div class="form-group" style="display:flex;align-items:center;gap:10px">
<input type="checkbox" id="projectAiAssisted" style="width:auto;margin:0">
<label for="projectAiAssisted" style="margin:0;cursor:pointer">Built with AI assistance (adds badge)</label>
</div>
<button onclick="saveProject()">Save Project</button>
</div>
</div>

<!-- Generate Panel -->
<div class="panel" id="generate">
<h2>Generate Tailored Resume</h2>

<!-- Job URL Import -->
<div class="form-group">
<label>Import from Job URL</label>
<div style="display:flex;gap:10px">
<input type="url" id="jobUrl" placeholder="https://job-boards.greenhouse.io/company/jobs/123..." style="flex:1">
<button onclick="fetchJobFromUrl()" class="secondary" id="fetchJobBtn">Fetch Job</button>
</div>
<small style="color:#888;margin-top:5px;display:block">Supports Greenhouse, Lever, Ashby, and most job boards</small>
</div>

<div style="display:flex;align-items:center;gap:15px;margin:15px 0;color:#666">
<div style="flex:1;height:1px;background:#333"></div>
<span>or paste manually</span>
<div style="flex:1;height:1px;background:#333"></div>
</div>

<div class="form-group">
<label>Job Description</label>
<textarea id="jobDescription" rows="10" placeholder="Paste the full job description here..."></textarea>
</div>
<div class="grid-2">
<div class="form-group">
<label>Company Name (optional)</label>
<input type="text" id="jobCompany" placeholder="e.g., Google">
</div>
<div class="form-group">
<label>Target Role (optional override)</label>
<input type="text" id="targetRole" placeholder="e.g., Senior Software Engineer">
</div>
</div>
<div class="form-group">
<label style="display:flex;justify-content:space-between;align-items:center">
<span>Additional Instructions (optional)</span>
<button type="button" class="secondary small" onclick="saveInstructionPreset()" style="font-size:11px;padding:4px 10px">Save as Preset</button>
</label>
<div id="instructionPresets" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px"></div>
<textarea id="additionalInstructions" rows="3" placeholder="e.g., Emphasize leadership experience, downplay older roles..."></textarea>
<small style="color:#666;margin-top:5px;display:block">Click presets above to add them. Combine multiple for different job types.</small>
</div>
<div class="form-group">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="generateCoverLetter" style="width:auto">
<span>Also generate a cover letter (uses your experience + relevant projects)</span>
</label>
</div>
<div class="generate-section">
<button class="generate-btn" onclick="generateResume()">Generate ATS-Optimized Resume</button>
</div>
<div class="loading" id="loading">
<div class="spinner"></div>
<p>Analyzing job description and tailoring your resume...</p>
</div>
<div class="output-section" id="output" style="display:none">

<!-- Score Card -->
<div class="score-card">
<div class="score" id="atsScore">--</div>
<div class="score-label">ATS Match Score</div>
<div class="keywords" id="keywordAnalysis"></div>
</div>

<!-- Save to Library Button -->
<div style="text-align:center;margin-bottom:20px">
<button onclick="saveCurrentResume()" class="success" id="saveToLibraryBtn">Save to Library</button>
</div>

<!-- Relevance Rankings -->
<div class="card" style="margin-bottom:20px">
<h4 style="color:#8b5cf6;margin-bottom:15px">Experience Relevance Rankings</h4>
<div id="relevanceRankings" style="white-space:pre-wrap;color:#aaa"></div>
</div>

<!-- Tailored Summary -->
<div class="card" style="margin-bottom:20px">
<h4 style="color:#6366f1;margin-bottom:15px">Tailored Professional Summary</h4>
<div id="tailoredSummary" style="font-style:italic;color:#ddd"></div>
</div>

<!-- Side-by-Side Comparison -->
<div class="card" style="margin-bottom:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#ec4899;margin:0">What Changed</h4>
<button class="secondary small" onclick="toggleComparison()" id="toggleComparisonBtn">Show Details</button>
</div>

<div id="comparisonSummary" style="color:#aaa;margin-bottom:15px">
<!-- Quick stats shown by default -->
</div>

<div id="comparisonDetails" style="display:none">
<!-- Summary Comparison -->
<div style="margin-bottom:25px">
<h5 style="color:#a855f7;margin-bottom:10px;font-size:14px">Professional Summary</h5>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div style="background:#1a1a2e;padding:15px;border-radius:8px;border-left:3px solid #666">
<div style="color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase">Original</div>
<div id="originalSummary" style="color:#aaa;font-size:13px;line-height:1.6"></div>
</div>
<div style="background:#1a2e1a;padding:15px;border-radius:8px;border-left:3px solid #00ff88">
<div style="color:#00ff88;font-size:11px;margin-bottom:8px;text-transform:uppercase">Tailored</div>
<div id="newSummary" style="color:#ddd;font-size:13px;line-height:1.6"></div>
</div>
</div>
</div>

<!-- Experience Comparison -->
<div id="experienceComparison">
<h5 style="color:#a855f7;margin-bottom:10px;font-size:14px">Experience Bullets</h5>
<div id="experienceComparisonList"></div>
</div>
</div>
</div>

<!-- Resume Output -->
<div class="card" style="margin-bottom:20px;position:relative">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#00ff88;margin:0">ATS-Optimized Resume</h4>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="secondary small" onclick="copyResume()">Copy</button>
<button class="secondary small" onclick="downloadPDF()" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Download PDF</button>
<button class="secondary small" onclick="exportToGoogleDocs()" id="googleDocsBtn" style="background:linear-gradient(135deg,#4285F4,#1a73e8)">Export to Google Docs</button>
</div>
</div>
<div class="resume-output" id="resumeOutput"></div>
</div>

<!-- Recruiter Assessment -->
<div class="card" style="background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#f59e0b;margin-bottom:15px">Recruiter Assessment</h4>
<div id="recruiterAssessment" style="white-space:pre-wrap;line-height:1.8"></div>
</div>

<!-- Cover Letter Output -->
<div class="card" style="margin-top:20px;display:none" id="coverLetterSection">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#10b981;margin:0">Cover Letter</h4>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="secondary small" onclick="copyCoverLetter()">Copy</button>
<button class="secondary small" onclick="downloadCoverLetterPDF()" style="background:linear-gradient(135deg,#10b981,#059669)">Download PDF</button>
</div>
</div>
<div id="coverLetterOutput" style="white-space:pre-wrap;line-height:1.8;color:#ddd"></div>
</div>

</div>
</div>

<!-- Batch Processing Panel -->
<div class="panel" id="batch">
<h2>Batch Process Multiple Jobs</h2>
<p style="color:#888;margin-bottom:20px">Compare your fit across multiple positions simultaneously (up to 5 jobs)</p>

<div class="batch-jobs" id="batchJobsList">
<div class="batch-job" data-index="0">
<div class="batch-job-header">
<div class="batch-job-number">1</div>
<button class="remove-job" onclick="removeBatchJob(0)" style="display:none">&times;</button>
</div>
<div class="grid-2">
<div class="form-group">
<label>Company Name</label>
<input type="text" class="batch-company" placeholder="e.g., Google">
</div>
<div class="form-group">
<label>Job Title</label>
<input type="text" class="batch-title" placeholder="e.g., Software Engineer">
</div>
</div>
<div class="form-group">
<label>Job URL (optional)</label>
<input type="url" class="batch-url" placeholder="https://...">
</div>
<div class="form-group">
<label>Job Description</label>
<textarea class="batch-jd" rows="6" placeholder="Paste the job description here..."></textarea>
</div>
</div>
</div>

<button onclick="addBatchJob()" class="secondary" style="width:100%;margin-top:10px" id="addJobBtn">+ Add Another Job</button>

<div class="generate-section" style="margin-top:20px">
<button class="generate-btn" onclick="processBatchJobs()">Process All Jobs</button>
</div>

<div class="loading" id="batchLoading">
<div class="spinner"></div>
<p>Processing all jobs in parallel...</p>
</div>

<div class="batch-results" id="batchResults" style="display:none">
<div class="comparison-card">
<h3 style="color:#fff;margin-bottom:15px">Comparison Summary</h3>
<p id="batchSummary" style="color:#aaa"></p>
<div id="batchRecommendation" style="margin-top:15px;padding:15px;background:#222;border-radius:8px"></div>
</div>

<h3 style="margin-bottom:15px">Rankings (Best Fit First)</h3>
<div class="ranking-list" id="batchRankings"></div>

<h3 style="margin-top:30px;margin-bottom:15px">Detailed Results</h3>
<div id="batchDetailedResults"></div>
</div>
</div>

<!-- Resume Library Panel -->
<div class="panel" id="library">
<h2>Resume Library</h2>

<div class="library-filters">
<select id="libraryStatusFilter" onchange="loadLibrary()">
<option value="all">All Statuses</option>
<option value="generated">Generated</option>
<option value="applied">Applied</option>
<option value="interviewing">Interviewing</option>
<option value="offered">Offered</option>
<option value="rejected">Rejected</option>
<option value="withdrawn">Withdrawn</option>
</select>
<button onclick="loadLibrary()" class="secondary small">Refresh</button>
</div>

<div id="libraryContent">
<div class="resume-list" id="resumeList">
<div style="color:#666;padding:40px;text-align:center">
<p>No saved resumes yet</p>
<p style="font-size:0.9em;margin-top:10px">Generate and save resumes to build your library</p>
</div>
</div>
</div>
</div>

<!-- Resume Detail Modal -->
<div class="modal" id="resumeDetailModal">
<div class="modal-content" style="max-width:900px">
<div class="modal-header">
<h3 id="resumeDetailTitle">Resume Details</h3>
<button class="modal-close" onclick="closeResumeDetail()">&times;</button>
</div>
<div id="resumeDetailContent"></div>
</div>
</div>

<!-- Resources Panel -->
<div class="panel" id="resources">
<h2>ATS Best Practices & Resources</h2>
<div class="resources-grid">
<div class="resource-card">
<h4>Resume Format</h4>
<ul class="resource-list">
<li>Use standard section headers (Experience, Education, Skills)</li>
<li>Stick to common fonts (Arial, Calibri, Times New Roman)</li>
<li>Avoid tables, graphics, and complex formatting</li>
<li>Use .docx or .pdf format</li>
<li>Keep to 1-2 pages maximum</li>
</ul>
</div>
<div class="resource-card">
<h4>Keywords Strategy</h4>
<ul class="resource-list">
<li>Mirror exact phrases from job description</li>
<li>Include both acronyms and full terms (SQL, Structured Query Language)</li>
<li>Use industry-standard job titles</li>
<li>Include required certifications by name</li>
</ul>
</div>
<div class="resource-card">
<h4>Power Action Verbs</h4>
<ul class="resource-list">
<li><strong>Led</strong> - Led team of 5 engineers...</li>
<li><strong>Developed</strong> - Developed microservices...</li>
<li><strong>Increased</strong> - Increased revenue by 40%...</li>
<li><strong>Reduced</strong> - Reduced costs by $50K...</li>
<li><strong>Implemented</strong> - Implemented CI/CD pipeline...</li>
</ul>
</div>
<div class="resource-card">
<h4>Metrics That Matter</h4>
<ul class="resource-list">
<li>Revenue impact ($, %)</li>
<li>Time saved (hours, days)</li>
<li>Team size managed</li>
<li>User/customer numbers</li>
<li>Performance improvements (%)</li>
</ul>
</div>
</div>
</div>
</div>

<!-- Experience Modal -->
<div class="modal" id="experienceModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="expModalTitle">Add Work Experience</h3>
<button class="modal-close" onclick="closeModal('experience')">&times;</button>
</div>
<input type="hidden" id="expEditIndex" value="-1">
<div class="form-group">
<label>Job Title</label>
<input type="text" id="expTitle" placeholder="Software Engineer">
</div>
<div class="form-group">
<label>Company</label>
<input type="text" id="expCompany" placeholder="Google">
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="expLocation" placeholder="Mountain View, CA">
</div>
<div class="grid">
<div class="form-group">
<label>Start Date</label>
<input type="month" id="expStart">
</div>
<div class="form-group">
<label>End Date (leave empty for current)</label>
<input type="month" id="expEnd">
</div>
</div>
<div class="form-group">
<label>Bullet Points (one per line - rough notes OK, AI will enhance)</label>
<textarea id="expBullets" rows="6" placeholder="managed team of developers
built new features for the app
helped reduce bugs and improve performance
worked with clients on requirements"></textarea>
<div style="display:flex;gap:20px;margin-top:8px;margin-bottom:8px;flex-wrap:wrap">
  <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;color:#a5b4fc;font-size:0.9em">
    <input type="radio" name="enhanceMode" value="cleanup" style="margin-top:3px">
    <span><strong>Clean Up</strong><br><span style="color:#888;font-size:0.85em">Fix grammar, keep structure</span></span>
  </label>
  <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;color:#a5b4fc;font-size:0.9em">
    <input type="radio" name="enhanceMode" value="supercharge" checked style="margin-top:3px">
    <span><strong>Supercharge</strong><br><span style="color:#888;font-size:0.85em">Rewrite for impact, can add metrics</span></span>
  </label>
</div>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
<button type="button" onclick="enhanceExpBullets()" class="secondary" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
  <span id="enhanceBtnText">Enhance with AI</span>
</button>
<span id="enhanceStatus" style="font-size:0.85em;color:#888"></span>
</div>
<div id="enhancePreview" style="display:none;margin-top:15px;background:#1a1a2e;border-radius:8px;padding:15px;border:1px solid #8b5cf633">
<div style="color:#8b5cf6;font-weight:500;margin-bottom:10px">Enhanced Preview:</div>
<div id="enhancePreviewContent" style="color:#a5b4fc;font-size:0.9em;line-height:1.6"></div>
<div style="display:flex;gap:10px;margin-top:15px">
<button type="button" onclick="applyEnhanced()" style="background:#10b981">Apply Changes</button>
<button type="button" onclick="cancelEnhanced()" class="secondary">Keep Original</button>
</div>
</div>
</div>
<button onclick="saveExperience()">Save Experience</button>
</div>
</div>

<!-- Education Modal -->
<div class="modal" id="educationModal">
<div class="modal-content">
<div class="modal-header">
<h3>Add Education</h3>
<button class="modal-close" onclick="closeModal('education')">&times;</button>
</div>
<div class="form-group">
<label>Degree</label>
<input type="text" id="eduDegree" placeholder="Bachelor of Science in Computer Science">
</div>
<div class="form-group">
<label>Institution</label>
<input type="text" id="eduSchool" placeholder="University of California, Berkeley">
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="eduLocation" placeholder="Berkeley, CA">
</div>
<div class="grid">
<div class="form-group">
<label>Start Year</label>
<input type="number" id="eduStart" placeholder="2016">
</div>
<div class="form-group">
<label>End Year</label>
<input type="number" id="eduEnd" placeholder="2020">
</div>
</div>
<div class="form-group">
<label>GPA (optional)</label>
<input type="text" id="eduGPA" placeholder="3.8/4.0">
</div>
<div class="form-group">
<label>Relevant Coursework / Honors (optional)</label>
<textarea id="eduExtras" rows="3" placeholder="Dean's List, Data Structures, Machine Learning..."></textarea>
</div>
<button onclick="saveEducation()">Save Education</button>
</div>
</div>

<!-- Certification Modal -->
<div class="modal" id="certModal">
<div class="modal-content">
<div class="modal-header">
<h3>Add Certification</h3>
<button class="modal-close" onclick="closeModal('cert')">&times;</button>
</div>
<div class="form-group">
<label>Certification Name</label>
<input type="text" id="certName" placeholder="AWS Solutions Architect">
</div>
<div class="form-group">
<label>Issuing Organization</label>
<input type="text" id="certOrg" placeholder="Amazon Web Services">
</div>
<div class="form-group">
<label>Date Obtained</label>
<input type="month" id="certDate">
</div>
<div class="form-group">
<label>Credential ID (optional)</label>
<input type="text" id="certId" placeholder="ABC123XYZ">
</div>
<button onclick="saveCert()">Save Certification</button>
</div>
</div>

<script>
// State
const state = {
  profile: JSON.parse(localStorage.getItem('resumeProfile') || '{}'),
  experience: JSON.parse(localStorage.getItem('resumeExperience') || '[]'),
  education: JSON.parse(localStorage.getItem('resumeEducation') || '[]'),
  certs: JSON.parse(localStorage.getItem('resumeCerts') || '[]'),
  skills: JSON.parse(localStorage.getItem('resumeSkills') || '{"technical":[],"soft":[],"tools":[],"interests":[]}'),
  projects: JSON.parse(localStorage.getItem('resumeProjects') || '[]'),
  instructionPresets: JSON.parse(localStorage.getItem('instructionPresets') || '[]'),
  lastGenerated: null,
  libraryStats: null
};

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    switchTab(tab.dataset.tab);
  });
});

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(tabName).classList.add('active');

  // Load data for specific tabs
  if (tabName === 'dashboard') {
    updateDashboard();
  } else if (tabName === 'library') {
    loadLibrary();
  }
}

// Dashboard functions
async function updateDashboard() {
  updateProfileCompleteness();

  if (!currentUser) {
    document.getElementById('statTotal').textContent = '0';
    document.getElementById('statAvgScore').textContent = '0%';
    document.getElementById('statApplied').textContent = '0';
    document.getElementById('statInterviewing').textContent = '0';
    document.getElementById('statOffered').textContent = '0';
    return;
  }

  try {
    const res = await fetch('/api/resumes/list?email=' + encodeURIComponent(currentUser.email));
    if (res.ok) {
      const data = await res.json();
      state.libraryStats = data.stats;

      document.getElementById('statTotal').textContent = data.stats.total || 0;
      document.getElementById('statAvgScore').textContent = (data.stats.avgScore || 0) + '%';
      document.getElementById('statApplied').textContent = data.stats.applied || 0;
      document.getElementById('statInterviewing').textContent = data.stats.interviewing || 0;
      document.getElementById('statOffered').textContent = data.stats.offered || 0;

      // Update library badge
      const badge = document.getElementById('libraryBadge');
      if (data.stats.total > 0) {
        badge.textContent = data.stats.total;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }

      // Update recent activity
      updateRecentActivity(data.resumes.slice(0, 5));
    }
  } catch (e) {
    console.error('Failed to load stats:', e);
  }
}

function updateRecentActivity(resumes) {
  const container = document.getElementById('recentActivity');

  if (!resumes || resumes.length === 0) {
    container.innerHTML = `
      <div style="color:#666;padding:20px;text-align:center">
        <p>No recent activity</p>
        <p style="font-size:0.9em;margin-top:10px">Generate your first tailored resume to get started</p>
      </div>
    `;
    return;
  }

  container.innerHTML = resumes.map(r => `
    <div class="activity-item">
      <div class="activity-icon">${getStatusIcon(r.status)}</div>
      <div class="activity-content">
        <div class="activity-title">${r.company} - ${r.title}</div>
        <div class="activity-meta">
          <span class="status-badge ${r.status}">${r.status}</span>
          <span style="margin-left:10px">${formatDate(r.updatedAt || r.createdAt)}</span>
          <span style="margin-left:10px;color:${r.score >= 70 ? '#10b981' : r.score >= 50 ? '#f59e0b' : '#ef4444'}">${r.score}% match</span>
        </div>
      </div>
    </div>
  `).join('');
}

function getStatusIcon(status) {
  const icons = {
    generated: 'üìÑ',
    applied: 'üì§',
    interviewing: 'üé§',
    offered: 'üéâ',
    rejected: '‚ùå',
    withdrawn: '‚Ü©Ô∏è'
  };
  return icons[status] || 'üìÑ';
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

function updateProfileCompleteness() {
  const checks = [
    { name: 'Full Name', value: state.profile.fullName },
    { name: 'Email', value: state.profile.email },
    { name: 'Phone', value: state.profile.phone },
    { name: 'Location', value: state.profile.location },
    { name: 'Summary', value: state.profile.summary },
    { name: 'Work Experience', value: state.experience.length > 0 },
    { name: 'Education', value: state.education.length > 0 },
    { name: 'Technical Skills', value: state.skills.technical?.length > 0 }
  ];

  const completed = checks.filter(c => c.value).length;
  const percent = Math.round((completed / checks.length) * 100);

  document.getElementById('completenessPercent').textContent = percent + '%';
  document.getElementById('completenessBar').style.width = percent + '%';

  const missing = checks.filter(c => !c.value).map(c => c.name);
  if (missing.length > 0) {
    document.getElementById('completenessHints').innerHTML = `
      <strong>Missing:</strong> ${missing.join(', ')}
    `;
  } else {
    document.getElementById('completenessHints').innerHTML = `
      <span style="color:#10b981">Profile complete! You're ready to generate tailored resumes.</span>
    `;
  }
}

// Load saved data into forms
function loadProfile() {
  if (state.profile.fullName) document.getElementById('fullName').value = state.profile.fullName;
  if (state.profile.email) document.getElementById('email').value = state.profile.email;
  if (state.profile.phone) document.getElementById('phone').value = state.profile.phone;
  if (state.profile.location) document.getElementById('location').value = state.profile.location;
  if (state.profile.linkedin) document.getElementById('linkedin').value = state.profile.linkedin;
  if (state.profile.github) document.getElementById('github').value = state.profile.github;
  if (state.profile.portfolio) document.getElementById('portfolio').value = state.profile.portfolio;
  if (state.profile.summary) document.getElementById('summary').value = state.profile.summary;
}

function saveProfile() {
  state.profile = {
    fullName: document.getElementById('fullName').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    location: document.getElementById('location').value,
    linkedin: document.getElementById('linkedin').value,
    github: document.getElementById('github').value,
    portfolio: document.getElementById('portfolio').value,
    summary: document.getElementById('summary').value
  };
  localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
  saveUserData();
  alert('Profile saved!');
}

// Modal functions
function openModal(type) {
  if (type === 'experience') {
    document.getElementById('expModalTitle').textContent = 'Add Work Experience';
    document.getElementById('expEditIndex').value = '-1';
  }
  document.getElementById(type + 'Modal').classList.add('active');
}

function closeModal(type) {
  document.getElementById(type + 'Modal').classList.remove('active');
  // Clear form
  if (type === 'experience') {
    ['expTitle', 'expCompany', 'expLocation', 'expStart', 'expEnd', 'expBullets'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('expEditIndex').value = '-1';
  }
}

// Experience functions
function renderExperience() {
  const list = document.getElementById('experienceList');
  list.innerHTML = state.experience.map((exp, i) => `
    <div class="item">
      <div class="item-header">
        <div>
          <div class="item-title">${exp.title} at ${exp.company}</div>
          <div class="item-subtitle">${exp.location} | ${exp.start} - ${exp.end || 'Present'}</div>
        </div>
        <div class="item-actions">
          <button class="secondary" onclick="editExperience(${i})">Edit</button>
          <button class="danger" onclick="deleteExperience(${i})">Delete</button>
        </div>
      </div>
      <div class="bullets">
        ${exp.bullets.map(b => `<div class="bullet"><span class="bullet-dot">‚Ä¢</span><span>${b}</span></div>`).join('')}
      </div>
    </div>
  `).join('');
}

function editExperience(i) {
  const exp = state.experience[i];
  document.getElementById('expModalTitle').textContent = 'Edit Work Experience';
  document.getElementById('expEditIndex').value = i;
  document.getElementById('expTitle').value = exp.title;
  document.getElementById('expCompany').value = exp.company;
  document.getElementById('expLocation').value = exp.location || '';
  document.getElementById('expStart').value = exp.start;
  document.getElementById('expEnd').value = exp.end || '';
  document.getElementById('expBullets').value = exp.bullets.join('\n');
  openModal('experience');
}

let pendingEnhancedBullets = null;

async function enhanceExpBullets() {
  const bullets = document.getElementById('expBullets').value;
  const title = document.getElementById('expTitle').value;
  const company = document.getElementById('expCompany').value;
  const status = document.getElementById('enhanceStatus');
  const btn = document.getElementById('enhanceBtnText');
  const preview = document.getElementById('enhancePreview');

  if (!bullets.trim()) {
    status.textContent = 'Add some bullet points first';
    status.style.color = '#ef4444';
    return;
  }

  btn.textContent = 'Enhancing...';
  status.textContent = '';
  preview.style.display = 'none';

  try {
    const enhanceMode = document.querySelector('input[name="enhanceMode"]:checked').value;
    const response = await fetch('/api/parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'enhance', bullets, title, company, enhanceMode })
    });

    const text = await response.text();
    if (!text) {
      throw new Error('Server returned empty response. Try again.');
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      throw new Error('Invalid response from server: ' + text.substring(0, 100));
    }

    if (!response.ok) {
      throw new Error(data.error || 'Enhancement failed');
    }

    pendingEnhancedBullets = data.bullets;
    document.getElementById('enhancePreviewContent').innerHTML = data.bullets.map(b => `‚Ä¢ ${b}`).join('<br>');
    preview.style.display = 'block';
    status.textContent = 'Review the enhanced version below';
    status.style.color = '#8b5cf6';

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  } finally {
    btn.textContent = 'Enhance with AI';
  }
}

function applyEnhanced() {
  if (pendingEnhancedBullets) {
    document.getElementById('expBullets').value = pendingEnhancedBullets.join('\n');
    document.getElementById('enhanceStatus').textContent = 'Applied!';
    document.getElementById('enhanceStatus').style.color = '#10b981';
  }
  document.getElementById('enhancePreview').style.display = 'none';
  pendingEnhancedBullets = null;
}

function cancelEnhanced() {
  document.getElementById('enhancePreview').style.display = 'none';
  document.getElementById('enhanceStatus').textContent = 'Kept original';
  document.getElementById('enhanceStatus').style.color = '#888';
  pendingEnhancedBullets = null;
}

function saveExperience() {
  const exp = {
    title: document.getElementById('expTitle').value,
    company: document.getElementById('expCompany').value,
    location: document.getElementById('expLocation').value,
    start: document.getElementById('expStart').value,
    end: document.getElementById('expEnd').value,
    bullets: document.getElementById('expBullets').value.split('\n').filter(b => b.trim())
  };

  const editIndex = parseInt(document.getElementById('expEditIndex').value);
  if (editIndex >= 0) {
    state.experience[editIndex] = exp;
  } else {
    state.experience.push(exp);
  }

  localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
  closeModal('experience');
  renderExperience();
  saveUserData();
}

function deleteExperience(i) {
  if (confirm('Delete this experience?')) {
    state.experience.splice(i, 1);
    localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
    renderExperience();
    saveUserData();
  }
}

// Education functions
function renderEducation() {
  const list = document.getElementById('educationList');
  list.innerHTML = state.education.map((edu, i) => `
    <div class="item">
      <div class="item-header">
        <div>
          <div class="item-title">${edu.degree}</div>
          <div class="item-subtitle">${edu.school} | ${edu.start} - ${edu.end}${edu.gpa ? ' | GPA: ' + edu.gpa : ''}</div>
        </div>
        <div class="item-actions">
          <button class="danger" onclick="deleteEducation(${i})">Delete</button>
        </div>
      </div>
      ${edu.extras ? `<div style="color:#888;margin-top:10px">${edu.extras}</div>` : ''}
    </div>
  `).join('');
}

function saveEducation() {
  const edu = {
    degree: document.getElementById('eduDegree').value,
    school: document.getElementById('eduSchool').value,
    location: document.getElementById('eduLocation').value,
    start: document.getElementById('eduStart').value,
    end: document.getElementById('eduEnd').value,
    gpa: document.getElementById('eduGPA').value,
    extras: document.getElementById('eduExtras').value
  };
  state.education.push(edu);
  localStorage.setItem('resumeEducation', JSON.stringify(state.education));
  closeModal('education');
  renderEducation();
  saveUserData();
  ['eduDegree', 'eduSchool', 'eduLocation', 'eduStart', 'eduEnd', 'eduGPA', 'eduExtras'].forEach(id => document.getElementById(id).value = '');
}

function deleteEducation(i) {
  if (confirm('Delete this education?')) {
    state.education.splice(i, 1);
    localStorage.setItem('resumeEducation', JSON.stringify(state.education));
    renderEducation();
    saveUserData();
  }
}

// Certification functions
function renderCerts() {
  const list = document.getElementById('certsList');
  list.innerHTML = state.certs.map((cert, i) => `
    <div class="item">
      <div class="item-header">
        <div>
          <div class="item-title">${cert.name}</div>
          <div class="item-subtitle">${cert.org} | ${cert.date}${cert.id ? ' | ID: ' + cert.id : ''}</div>
        </div>
        <div class="item-actions">
          <button class="danger" onclick="deleteCert(${i})">Delete</button>
        </div>
      </div>
    </div>
  `).join('');
}

function saveCert() {
  const cert = {
    name: document.getElementById('certName').value,
    org: document.getElementById('certOrg').value,
    date: document.getElementById('certDate').value,
    id: document.getElementById('certId').value
  };
  state.certs.push(cert);
  localStorage.setItem('resumeCerts', JSON.stringify(state.certs));
  closeModal('cert');
  renderCerts();
  saveUserData();
  ['certName', 'certOrg', 'certDate', 'certId'].forEach(id => document.getElementById(id).value = '');
}

function deleteCert(i) {
  if (confirm('Delete this certification?')) {
    state.certs.splice(i, 1);
    localStorage.setItem('resumeCerts', JSON.stringify(state.certs));
    renderCerts();
    saveUserData();
  }
}

// Skills functions
function renderSkills() {
  ['technical', 'soft', 'tools', 'interests'].forEach(type => {
    const container = document.getElementById(type === 'technical' ? 'technicalSkills' : type === 'soft' ? 'softSkills' : type);
    const skills = state.skills[type] || [];
    container.innerHTML = skills.map((s, i) => `
      <span class="tag">${s}<span class="tag-remove" onclick="removeSkill('${type}', ${i})">&times;</span></span>
    `).join('');
  });
}

function addSkill(type) {
  const inputId = type === 'technical' ? 'techSkillInput' : type === 'soft' ? 'softSkillInput' : type === 'tools' ? 'toolInput' : 'interestInput';
  const input = document.getElementById(inputId);
  const value = input.value.trim();
  if (value) {
    if (!state.skills[type]) state.skills[type] = [];
    state.skills[type].push(value);
    localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
    renderSkills();
    input.value = '';
    saveUserData();
  }
}

function removeSkill(type, i) {
  state.skills[type].splice(i, 1);
  localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
  renderSkills();
  saveUserData();
}

// Enter key for skill inputs
['techSkillInput', 'softSkillInput', 'toolInput', 'interestInput'].forEach(id => {
  document.getElementById(id).addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const type = id === 'techSkillInput' ? 'technical' : id === 'softSkillInput' ? 'soft' : id === 'toolInput' ? 'tools' : 'interests';
      addSkill(type);
    }
  });
});

// Project functions
function renderProjects() {
  const list = document.getElementById('projectsList');
  list.innerHTML = state.projects.map((proj, i) => `
    <div class="item">
      <div class="item-header">
        <div style="flex:1">
          <div class="item-title" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            ${proj.name}
            ${proj.aiAssisted ? '<span class="ai-badge">Built with AI</span>' : ''}
          </div>
          <div class="item-subtitle">${proj.shortDesc || ''}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
            ${proj.tech ? proj.tech.split(',').map(t => `<span class="tech-tag">${t.trim()}</span>`).join('') : ''}
          </div>
        </div>
        <div class="item-actions">
          <button class="secondary" onclick="editProject(${i})">Edit</button>
          <button class="danger" onclick="deleteProject(${i})">Delete</button>
        </div>
      </div>
      ${proj.features && proj.features.length ? `
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
          ${proj.features.map(f => `<span class="feature-chip">${f}</span>`).join('')}
        </div>
      ` : ''}
      <div style="display:flex;gap:15px;margin-top:10px;flex-wrap:wrap;align-items:center">
        ${proj.url ? `<a href="${proj.url}" target="_blank" style="color:#fff;font-size:0.9em;display:flex;align-items:center;gap:5px">${proj.url.includes('github') ? '<svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg> GitHub' : 'üìÅ Repo'}</a>` : ''}
        ${proj.liveUrl ? `<a href="${proj.liveUrl}" target="_blank" style="color:#10b981;font-size:0.9em;display:flex;align-items:center;gap:5px"><svg height="14" width="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> Live</a>` : ''}
      </div>
    </div>
  `).join('') || '<p style="color:#666;padding:20px;text-align:center">No projects added yet</p>';
}

function editProject(i) {
  const proj = state.projects[i];
  document.getElementById('projectModalTitle').textContent = 'Edit Project';
  document.getElementById('projectEditIndex').value = i;
  document.getElementById('projectName').value = proj.name || '';
  document.getElementById('projectShortDesc').value = proj.shortDesc || '';
  document.getElementById('projectTech').value = proj.tech || '';
  document.getElementById('projectUrl').value = proj.url || '';
  document.getElementById('projectLiveUrl').value = proj.liveUrl || '';
  document.getElementById('projectFeatures').value = (proj.features || []).join('\n');
  document.getElementById('projectReadme').value = proj.readme || '';
  document.getElementById('projectAiAssisted').checked = proj.aiAssisted || false;
  openModal('project');
}

function saveProject() {
  const proj = {
    name: document.getElementById('projectName').value,
    shortDesc: document.getElementById('projectShortDesc').value,
    tech: document.getElementById('projectTech').value,
    url: document.getElementById('projectUrl').value,
    liveUrl: document.getElementById('projectLiveUrl').value,
    features: document.getElementById('projectFeatures').value.split('\n').filter(f => f.trim()),
    readme: document.getElementById('projectReadme').value,
    aiAssisted: document.getElementById('projectAiAssisted').checked
  };

  const editIndex = parseInt(document.getElementById('projectEditIndex').value);
  if (editIndex >= 0) {
    state.projects[editIndex] = proj;
  } else {
    state.projects.push(proj);
  }

  localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
  closeModal('project');
  renderProjects();
  saveUserData();

  // Clear form
  ['projectName', 'projectShortDesc', 'projectTech', 'projectUrl', 'projectLiveUrl', 'projectFeatures', 'projectReadme'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('projectEditIndex').value = '-1';
  document.getElementById('projectAiAssisted').checked = false;
}

async function aiExtractFromReadme() {
  const readme = document.getElementById('projectReadme').value;
  const status = document.getElementById('extractStatus');
  const btn = document.getElementById('aiExtractBtnText');

  if (!readme.trim()) {
    status.textContent = 'Paste a README first';
    status.style.color = '#ef4444';
    return;
  }

  btn.textContent = 'Extracting...';
  status.textContent = '';

  try {
    const response = await fetch('/api/parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'extract', readme })
    });

    const text = await response.text();
    if (!text) {
      throw new Error('Server returned empty response. Try again.');
    }

    let extracted;
    try {
      extracted = JSON.parse(text);
    } catch (parseErr) {
      throw new Error('Invalid response from server: ' + text.substring(0, 100));
    }

    if (!response.ok) {
      const debugInfo = extracted.debug ? ` | Debug: ${JSON.stringify(extracted.debug)}` : '';
      throw new Error((extracted.error || 'AI extraction failed') + debugInfo);
    }

    // Populate short description if empty
    const shortDescField = document.getElementById('projectShortDesc');
    if (!shortDescField.value.trim() && extracted.shortDesc) {
      shortDescField.value = extracted.shortDesc;
    }

    // Populate features
    const featuresField = document.getElementById('projectFeatures');
    const existingFeatures = featuresField.value.split('\n').filter(f => f.trim());
    const newFeatures = [...new Set([...existingFeatures, ...extracted.features])];
    featuresField.value = newFeatures.join('\n');

    // Populate tech
    const techField = document.getElementById('projectTech');
    const existingTech = techField.value.split(',').map(t => t.trim()).filter(t => t);
    const newTech = [...new Set([...existingTech, ...extracted.technologies])];
    techField.value = newTech.join(', ');

    const parts = [];
    if (extracted.shortDesc) parts.push('description');
    if (extracted.features.length) parts.push(`${extracted.features.length} features`);
    if (extracted.technologies.length) parts.push(`${extracted.technologies.length} technologies`);

    status.textContent = `Extracted ${parts.join(', ')}!`;
    status.style.color = '#10b981';

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  } finally {
    btn.textContent = 'Extract with AI';
  }
}

function deleteProject(i) {
  if (confirm('Delete this project?')) {
    state.projects.splice(i, 1);
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
    renderProjects();
    saveUserData();
  }
}

function extractFromReadme(readme) {
  const features = [];
  const technologies = [];
  const lines = readme.split('\n');
  let currentSection = null;

  // Sections to extract features from
  const featureSections = /^#{1,3}\s*(features|key features|highlights|what it does|what is|core features|main features)/i;
  // Sections to extract technologies from
  const techSections = /^#{1,3}\s*(tech stack|technologies|built with|stack|why this stack)/i;
  // Sections to skip entirely
  const skipSections = /^#{1,3}\s*(roadmap|development roadmap|ui layout|layout|installation|setup|getting started|contributing|license|acknowledgments|credits|todo|future|planned|usage|example|api|bom|bill of materials|templates|configuration|config|how it works|formula|variance|production|sandbox|escalation|detailed)/i;

  // Pattern to detect code/formula-like content (not real features)
  const codePattern = /(\‚Üí|‚Üí|=>|=\s*\d|√ó|\*\s*\d|ceil\(|floor\(|Math\.|^\d+\s*(oz|ml|g|kg|lb|towels?|applications?)|\$\{|function |const |let |var |import |export |class |handleof\.it|sampling\.|\.com|\.io|http)/i;

  // Pattern for feature-like content (has a dash separator with description)
  const featureWithDescPattern = /^(.+?)\s*[-‚Äì‚Äî]\s*(.+)$/;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    // Check for section headers
    if (/^#{1,3}\s+/.test(line)) {
      if (featureSections.test(line)) {
        currentSection = 'features';
      } else if (techSections.test(line)) {
        currentSection = 'tech';
      } else if (skipSections.test(line)) {
        currentSection = 'skip';
      } else {
        // Check for numbered feature headers like "1. Task Management"
        const numberedHeader = line.match(/^#{1,3}\s*\d+\.\s*(.+)/);
        if (numberedHeader && currentSection === 'features') {
          const headerFeature = numberedHeader[1].trim();
          if (headerFeature.length > 3 && headerFeature.length < 50 && !codePattern.test(headerFeature)) {
            features.push(headerFeature);
          }
        }
        // Don't change section for sub-headers within features
        if (currentSection !== 'features') {
          currentSection = null;
        }
      }
      continue;
    }

    // Skip if in a skip section
    if (currentSection === 'skip') continue;

    // Extract bullet points (- or * at start of line)
    const bulletMatch = line.match(/^[-*]\s+(.+)/);
    if (bulletMatch) {
      let item = bulletMatch[1].trim();
      // Clean up markdown formatting
      item = item.replace(/\*\*([^*]+)\*\*/g, '$1'); // Remove bold
      item = item.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1'); // Clean links
      item = item.replace(/`([^`]+)`/g, '$1'); // Remove code backticks

      // Skip if it looks like code, formula, or technical spec
      if (codePattern.test(item)) continue;

      // Check if it's a "Feature - Description" format
      const featureDescMatch = item.match(featureWithDescPattern);
      if (featureDescMatch && currentSection === 'features') {
        const featureName = featureDescMatch[1].trim();
        const featureDesc = featureDescMatch[2].trim();
        if (featureName.length > 2 && featureDesc.length > 5) {
          features.push(`${featureName} - ${featureDesc}`);
          continue;
        }
      }

      if (currentSection === 'tech' && item.length > 1 && item.length < 100) {
        technologies.push(item);
      } else if (currentSection === 'features' && item.length > 10 && item.length < 200) {
        features.push(item);
      } else if (!currentSection && item.length > 20 && item.length < 200 && features.length < 4) {
        // Only add uncategorized bullets if they look like real features
        if (!/^(install|clone|run|npm|yarn|cd |git |mkdir|pip |python |docker |curl |wget )/i.test(item)) {
          features.push(item);
        }
      }
    }
  }

  return {
    features: [...new Set(features)].slice(0, 8),
    technologies: [...new Set(technologies)].slice(0, 15)
  };
}

async function fetchGitHubRepos() {
  const input = document.getElementById('githubUsername').value.trim();
  const status = document.getElementById('githubFetchStatus');
  const listEl = document.getElementById('githubReposList');

  if (!input) {
    status.textContent = 'Please enter a GitHub username';
    status.style.color = '#ef4444';
    return;
  }

  // Extract username from URL or use as-is
  let username = input;
  const urlMatch = input.match(/github\.com\/([^\/]+)/);
  if (urlMatch) username = urlMatch[1];

  status.textContent = 'Fetching repositories...';
  status.style.color = '#888';
  listEl.innerHTML = '';

  try {
    const res = await fetch(`https://api.github.com/users/${username}/repos?per_page=100&sort=updated`);
    if (!res.ok) throw new Error('User not found');
    const repos = await res.json();

    if (repos.length === 0) {
      status.textContent = 'No public repositories found';
      return;
    }

    status.textContent = `Found ${repos.length} public repositories`;
    status.style.color = '#10b981';

    // Check which repos are already imported
    const importedUrls = new Set(state.projects.map(p => p.url));

    listEl.innerHTML = repos.map(repo => {
      const isImported = importedUrls.has(repo.html_url);
      return `
        <div class="github-repo-item" style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#1a1a1a;border-radius:8px;margin-bottom:8px">
          <div style="flex:1;min-width:0">
            <div style="font-weight:500;color:#fff">${repo.name}</div>
            <div style="font-size:0.85em;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${repo.description || 'No description'}</div>
            <div style="font-size:0.8em;color:#666;margin-top:4px">
              ${repo.language ? `<span style="color:#60a5fa">${repo.language}</span> ¬∑ ` : ''}
              ‚≠ê ${repo.stargazers_count} ¬∑ Updated ${new Date(repo.updated_at).toLocaleDateString()}
            </div>
          </div>
          <button
            onclick="importGitHubRepo('${username}', '${repo.name}')"
            class="${isImported ? '' : 'secondary'}"
            style="margin-left:10px;white-space:nowrap${isImported ? ';background:#333;color:#666;cursor:default' : ''}"
            ${isImported ? 'disabled' : ''}
          >${isImported ? 'Imported' : 'Import'}</button>
        </div>
      `;
    }).join('');

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  }
}

async function importGitHubRepo(owner, repoName) {
  // Find and update the button
  const buttons = document.querySelectorAll('.github-repo-item button');
  let btn = null;
  buttons.forEach(b => {
    if (b.onclick && b.onclick.toString().includes(repoName)) {
      btn = b;
    }
  });

  // Find button by checking parent content
  const items = document.querySelectorAll('.github-repo-item');
  items.forEach(item => {
    if (item.textContent.includes(repoName)) {
      btn = item.querySelector('button');
    }
  });

  if (btn) {
    btn.textContent = 'Importing...';
    btn.disabled = true;
  }

  try {
    // Fetch repo info
    const repoRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}`);
    if (!repoRes.ok) throw new Error('Repository not found');
    const repoData = await repoRes.json();

    // Try to fetch README
    let readme = '';
    let extractedFeatures = [];
    let extractedTech = [];
    try {
      const readmeRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}/readme`);
      if (readmeRes.ok) {
        const readmeData = await readmeRes.json();
        const binaryString = atob(readmeData.content.replace(/\n/g, ''));
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        readme = new TextDecoder('utf-8').decode(bytes);
        const extracted = extractFromReadme(readme);
        extractedFeatures = extracted.features;
        extractedTech = extracted.technologies;
      }
    } catch (e) {}

    // Fetch languages
    let apiLanguages = [];
    try {
      const langRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}/languages`);
      if (langRes.ok) {
        const languages = await langRes.json();
        apiLanguages = Object.keys(languages);
      }
    } catch (e) {}

    const allTech = [...new Set([...apiLanguages, ...extractedTech])];

    const proj = {
      name: repoData.name,
      shortDesc: repoData.description || '',
      tech: allTech.join(', '),
      url: repoData.html_url,
      features: extractedFeatures,
      readme: readme
    };

    state.projects.push(proj);
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
    renderProjects();
    saveUserData();

    if (btn) {
      btn.textContent = 'Imported';
      btn.className = '';
      btn.style.background = '#333';
      btn.style.color = '#666';
    }

  } catch (e) {
    if (btn) {
      btn.textContent = 'Error';
      btn.style.background = '#ef4444';
    }
    console.error('Import error:', e);
  }
}

async function importFromGitHub() {
  const url = document.getElementById('githubRepoUrl')?.value?.trim();
  const status = document.getElementById('githubImportStatus');
  if (!status) return;

  if (!url) {
    status.textContent = 'Please enter a GitHub URL';
    status.style.color = '#ef4444';
    return;
  }

  // Extract owner/repo from URL
  const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
  if (!match) {
    status.textContent = 'Invalid GitHub URL';
    status.style.color = '#ef4444';
    return;
  }

  const [, owner, repo] = match;
  status.textContent = 'Fetching repository...';
  status.style.color = '#888';

  try {
    // Fetch repo info
    const repoRes = await fetch(`https://api.github.com/repos/${owner}/${repo.replace('.git', '')}`);
    if (!repoRes.ok) throw new Error('Repository not found or is private');
    const repoData = await repoRes.json();

    // Try to fetch README
    let readme = '';
    let extractedFeatures = [];
    let extractedTech = [];
    try {
      const readmeRes = await fetch(`https://api.github.com/repos/${owner}/${repo.replace('.git', '')}/readme`);
      if (readmeRes.ok) {
        const readmeData = await readmeRes.json();
        // Properly decode base64 with UTF-8 support (fixes emoji/special char issues)
        const binaryString = atob(readmeData.content.replace(/\n/g, ''));
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        readme = new TextDecoder('utf-8').decode(bytes);

        // Extract features and technologies from README
        const extracted = extractFromReadme(readme);
        extractedFeatures = extracted.features;
        extractedTech = extracted.technologies;
      }
    } catch (e) {
      // README not found, that's okay
    }

    // Fetch languages from GitHub API
    let apiLanguages = [];
    try {
      const langRes = await fetch(`https://api.github.com/repos/${owner}/${repo.replace('.git', '')}/languages`);
      if (langRes.ok) {
        const languages = await langRes.json();
        apiLanguages = Object.keys(languages);
      }
    } catch (e) {}

    // Merge technologies: API languages + README tech stack (deduplicated)
    const allTech = [...new Set([...apiLanguages, ...extractedTech])];
    const tech = allTech.join(', ');

    // Create project
    const proj = {
      name: repoData.name,
      shortDesc: repoData.description || '',
      tech: tech,
      url: repoData.html_url,
      features: extractedFeatures,
      readme: readme
    };

    state.projects.push(proj);
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
    renderProjects();
    saveUserData();

    const featureCount = extractedFeatures.length;
    const techCount = allTech.length;
    const parts = [];
    if (featureCount > 0) parts.push(`${featureCount} features`);
    if (techCount > 0) parts.push(`${techCount} technologies`);
    status.textContent = parts.length > 0
      ? `Imported with ${parts.join(' and ')} extracted!`
      : 'Imported! Click Edit to add features/achievements.';
    status.style.color = '#10b981';
    document.getElementById('githubRepoUrl').value = '';

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  }
}

function copyCoverLetter() {
  const text = document.getElementById('coverLetterOutput').innerText || document.getElementById('coverLetterOutput').textContent;
  if (!text || text.trim() === '') {
    alert('No cover letter content to copy.');
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Cover letter copied!');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

// Fetch job from URL
// Instruction presets
function loadInstructionPresets() {
  const presets = state.instructionPresets || [];
  const container = document.getElementById('instructionPresets');

  if (presets.length === 0) {
    container.innerHTML = '<span style="color:#666;font-size:12px">No saved presets yet. Type instructions and click "Save as Preset".</span>';
    return;
  }

  container.innerHTML = presets.map((preset, idx) => `
    <div class="preset-chip" style="display:inline-flex;align-items:center;gap:6px;background:#2a2a3e;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid #444;transition:all 0.2s"
         onmouseenter="this.style.borderColor='#00ff88'"
         onmouseleave="this.style.borderColor='#444'">
      <span onclick="addPresetToInstructions(${idx})" style="color:#ddd">${escapeHtml(preset.name)}</span>
      <span onclick="deletePreset(${idx})" style="color:#888;font-size:14px;padding:0 2px" title="Delete preset">&times;</span>
    </div>
  `).join('');
}

function saveInstructionPreset() {
  const text = document.getElementById('additionalInstructions').value.trim();
  if (!text) {
    alert('Please enter some instructions first');
    return;
  }

  const name = prompt('Give this preset a short name:', text.substring(0, 30) + (text.length > 30 ? '...' : ''));
  if (!name) return;

  // Check for duplicate names
  if (state.instructionPresets.some(p => p.name.toLowerCase() === name.toLowerCase())) {
    if (!confirm('A preset with this name already exists. Replace it?')) return;
    const idx = state.instructionPresets.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
    state.instructionPresets[idx] = { name, text };
  } else {
    state.instructionPresets.push({ name, text });
  }

  // Save to localStorage (for non-logged-in users) and to account (if logged in)
  localStorage.setItem('instructionPresets', JSON.stringify(state.instructionPresets));
  saveUserData();
  loadInstructionPresets();
  alert('Preset saved!' + (currentUser ? ' Synced to your account.' : ''));
}

function addPresetToInstructions(idx) {
  const presets = state.instructionPresets || [];
  if (!presets[idx]) return;

  const textarea = document.getElementById('additionalInstructions');
  const currentText = textarea.value.trim();
  const presetText = presets[idx].text;

  // Add to existing instructions (avoid duplicates)
  if (currentText.includes(presetText)) {
    return; // Already added
  }

  textarea.value = currentText ? currentText + '\n\n' + presetText : presetText;
}

function deletePreset(idx) {
  if (!confirm('Delete this preset?')) return;

  state.instructionPresets.splice(idx, 1);
  localStorage.setItem('instructionPresets', JSON.stringify(state.instructionPresets));
  saveUserData();
  loadInstructionPresets();
}

async function fetchJobFromUrl() {
  const urlInput = document.getElementById('jobUrl');
  const url = urlInput.value.trim();

  if (!url) {
    alert('Please enter a job posting URL');
    return;
  }

  const btn = document.getElementById('fetchJobBtn');
  const originalText = btn.textContent;
  btn.textContent = 'Fetching...';
  btn.disabled = true;

  try {
    const response = await fetch('/api/fetch-job', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });

    const data = await response.json();

    if (data.error) {
      alert('Error fetching job: ' + data.error);
      return;
    }

    // Populate the form fields
    if (data.description) {
      document.getElementById('jobDescription').value = data.description;
    }
    if (data.company) {
      document.getElementById('jobCompany').value = data.company;
    }
    if (data.title) {
      document.getElementById('targetRole').value = data.title;
    }

    // Show success message
    const msg = [];
    if (data.company) msg.push(data.company);
    if (data.title) msg.push(data.title);
    if (data.location) msg.push(data.location);

    if (msg.length > 0) {
      alert('Imported: ' + msg.join(' - '));
    } else if (data.description) {
      alert('Job description imported. Company/title could not be detected - please fill in manually.');
    }

  } catch (e) {
    alert('Error fetching job: ' + e.message);
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// Generate resume
async function generateResume() {
  const jobDescription = document.getElementById('jobDescription').value.trim();
  if (!jobDescription) {
    alert('Please paste a job description');
    return;
  }

  document.getElementById('loading').classList.add('active');
  document.getElementById('output').style.display = 'none';

  const payload = {
    profile: state.profile,
    experience: state.experience,
    education: state.education,
    certs: state.certs,
    skills: state.skills,
    projects: state.projects,
    jobDescription: jobDescription,
    targetRole: document.getElementById('targetRole').value,
    additionalInstructions: document.getElementById('additionalInstructions').value,
    includeCoverLetter: document.getElementById('generateCoverLetter').checked
  };

  try {
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.error || 'API error: ' + res.status);
    }

    const data = await res.json();

    // Store for saving to library
    state.lastGenerated = {
      company: document.getElementById('jobCompany').value || 'Unknown Company',
      title: document.getElementById('targetRole').value || 'Position',
      jobDescription: jobDescription,
      jobUrl: document.getElementById('jobUrl').value || '',
      score: data.score,
      matchedKeywords: data.matchedKeywords,
      missingKeywords: data.missingKeywords,
      tailoredSummary: data.tailoredSummary,
      resume: data.resume,
      recruiterAssessment: data.recruiterAssessment
    };

    document.getElementById('atsScore').textContent = data.score + '%';
    document.getElementById('keywordAnalysis').innerHTML = `
      <div style="margin-top:15px">
        <strong style="display:block;margin-bottom:8px">Matched Keywords:</strong>
        <div style="display:flex;flex-wrap:wrap;gap:4px">
          ${data.matchedKeywords.map(k => `<span class="keyword-match">${k}</span>`).join('')}
        </div>
      </div>
      <div style="margin-top:15px">
        <strong style="display:block;margin-bottom:8px">Consider Adding:</strong>
        <div style="display:flex;flex-wrap:wrap;gap:4px">
          ${data.missingKeywords.map(k => `<span class="keyword-missing">${k}</span>`).join('')}
        </div>
      </div>
    `;
    document.getElementById('relevanceRankings').textContent = data.relevanceRankings || 'Not available';
    document.getElementById('tailoredSummary').textContent = data.tailoredSummary || 'Not available';
    document.getElementById('resumeOutput').textContent = data.resume;
    document.getElementById('recruiterAssessment').innerHTML = (data.recruiterAssessment || 'Not available').replace(/\n/g, '<br>');

    // Show cover letter if generated
    if (data.coverLetter) {
      document.getElementById('coverLetterOutput').textContent = data.coverLetter;
      document.getElementById('coverLetterSection').style.display = 'block';
      state.lastGenerated.coverLetter = data.coverLetter;
    } else {
      document.getElementById('coverLetterSection').style.display = 'none';
    }

    // Populate comparison view
    populateComparison(data);

    document.getElementById('output').style.display = 'block';
  } catch (e) {
    alert('Error generating resume: ' + e.message);
  } finally {
    document.getElementById('loading').classList.remove('active');
  }
}

function toggleComparison() {
  const details = document.getElementById('comparisonDetails');
  const btn = document.getElementById('toggleComparisonBtn');

  if (details.style.display === 'none') {
    details.style.display = 'block';
    btn.textContent = 'Hide Details';
  } else {
    details.style.display = 'none';
    btn.textContent = 'Show Details';
  }
}

function populateComparison(data) {
  const originalSummary = state.profile.summary || '';
  const tailoredSummary = data.tailoredSummary || '';

  // Summary comparison
  document.getElementById('originalSummary').textContent = originalSummary || '(No summary provided)';
  document.getElementById('newSummary').textContent = tailoredSummary || '(No tailored summary generated)';

  // Parse the generated resume to extract experience bullets
  const generatedBullets = extractBulletsFromResume(data.resume || '');

  // Build experience comparison
  let comparisonHtml = '';
  let totalOriginalBullets = 0;
  let changesCount = 0;

  state.experience.forEach((exp, idx) => {
    const originalBullets = exp.bullets || [];
    totalOriginalBullets += originalBullets.length;

    // Find matching experience in generated resume
    const matchedBullets = findMatchingExperience(exp.company, exp.title, generatedBullets);

    if (originalBullets.length > 0 || matchedBullets.length > 0) {
      comparisonHtml += `
        <div style="margin-bottom:20px;padding:15px;background:#111;border-radius:8px">
          <div style="color:#fff;font-weight:600;margin-bottom:12px">${exp.title} at ${exp.company}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
            <div>
              <div style="color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase">Original Bullets</div>
              <ul style="margin:0;padding-left:20px;color:#aaa;font-size:13px;line-height:1.8">
                ${originalBullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')}
              </ul>
            </div>
            <div>
              <div style="color:#00ff88;font-size:11px;margin-bottom:8px;text-transform:uppercase">Rewritten Bullets</div>
              <ul style="margin:0;padding-left:20px;color:#ddd;font-size:13px;line-height:1.8">
                ${matchedBullets.length > 0
                  ? matchedBullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')
                  : '<li style="color:#666">(Experience may have been condensed or reordered)</li>'}
              </ul>
            </div>
          </div>
        </div>
      `;

      if (matchedBullets.length > 0) {
        changesCount += Math.max(originalBullets.length, matchedBullets.length);
      }
    }
  });

  document.getElementById('experienceComparisonList').innerHTML = comparisonHtml || '<p style="color:#666">No experience to compare</p>';

  // Summary stats
  const summaryChanged = originalSummary !== tailoredSummary && tailoredSummary;
  const keywordsAdded = (data.matchedKeywords || []).length;

  document.getElementById('comparisonSummary').innerHTML = `
    <div style="display:flex;gap:20px;flex-wrap:wrap">
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#00ff88">${summaryChanged ? 'Yes' : 'No'}</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">Summary Tailored</div>
      </div>
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#8b5cf6">${totalOriginalBullets}</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">Original Bullets</div>
      </div>
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#f59e0b">${keywordsAdded}</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">Keywords Matched</div>
      </div>
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#ec4899">${data.score || 0}%</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">ATS Score</div>
      </div>
    </div>
  `;

  // Reset comparison details to hidden
  document.getElementById('comparisonDetails').style.display = 'none';
  document.getElementById('toggleComparisonBtn').textContent = 'Show Details';
}

function extractBulletsFromResume(resumeText) {
  // Extract bullet points grouped by company/role
  const sections = {};
  const lines = resumeText.split('\n');
  let currentSection = null;
  let inExperienceSection = false;

  for (const line of lines) {
    const trimmed = line.trim();
    // Remove markdown bold markers for parsing
    const cleanLine = trimmed.replace(/\*\*/g, '').replace(/\*/g, '');

    // Detect major section headers (EXPERIENCE, EDUCATION, SKILLS, etc.)
    if (/^(PROFESSIONAL\s+)?EXPERIENCE/i.test(cleanLine) ||
        /^WORK\s+HISTORY/i.test(cleanLine)) {
      inExperienceSection = true;
      continue;
    }
    if (/^(EDUCATION|SKILLS|TECHNICAL\s+SKILLS|PROJECTS|CERTIFICATIONS|KEY\s+PROJECTS)/i.test(cleanLine)) {
      inExperienceSection = false;
      currentSection = null;
      continue;
    }

    // Only parse within experience section
    if (!inExperienceSection) continue;

    // Detect job headers - common formats:
    // "Title | Company | Location | Dates"
    // "Title at Company"
    // "Title - Company"
    const jobHeaderPatterns = [
      /^([A-Za-z\s\-]+)\s*\|\s*([A-Za-z\s\-&\.]+)\s*\|/i,  // Title | Company |
      /^([A-Za-z\s\-]+)\s+at\s+([A-Za-z\s\-&\.]+)/i,       // Title at Company
      /^([A-Za-z\s\-]+)\s*[-‚Äì‚Äî]\s*([A-Za-z\s\-&\.]+)/i,    // Title - Company
    ];

    let isJobHeader = false;
    for (const pattern of jobHeaderPatterns) {
      const match = cleanLine.match(pattern);
      if (match && match[1].length > 3 && match[2].length > 2) {
        // Make sure it's not a bullet point
        if (!trimmed.startsWith('‚Ä¢') && !trimmed.startsWith('-') && !trimmed.match(/^\d+\./)) {
          currentSection = cleanLine.toLowerCase();
          sections[currentSection] = [];
          isJobHeader = true;
          break;
        }
      }
    }

    if (isJobHeader) continue;

    // Detect bullets - starts with ‚Ä¢, -, or * (but not ** which is bold)
    if (currentSection) {
      const bulletMatch = trimmed.match(/^[‚Ä¢\-]\s*(.+)/) ||
                          (trimmed.startsWith('*') && !trimmed.startsWith('**') && trimmed.match(/^\*\s*(.+)/));
      if (bulletMatch) {
        const bullet = bulletMatch[1].replace(/\*\*/g, '').trim();
        if (bullet.length > 20) {  // Real bullets are usually longer
          sections[currentSection].push(bullet);
        }
      }
      // Also catch lines that start with action verbs (common in AI-generated resumes)
      else if (/^(Led|Managed|Developed|Built|Created|Designed|Implemented|Executed|Deployed|Configured|Conducted|Diagnosed|Served|Partnered|Optimized|Orchestrated|Collaborated|Applied|Established|Increased|Reduced)\s/i.test(cleanLine)) {
        if (cleanLine.length > 30) {
          sections[currentSection].push(cleanLine);
        }
      }
    }
  }

  return sections;
}

function findMatchingExperience(company, title, generatedBullets) {
  const companyLower = (company || '').toLowerCase().trim();
  const titleLower = (title || '').toLowerCase().trim();

  // First try exact matches
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;

    // Check if section contains both company and title
    if (section.includes(companyLower) && section.includes(titleLower)) {
      return bullets;
    }
  }

  // Try matching just company name
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;
    if (section.includes(companyLower)) {
      return bullets;
    }
  }

  // Try matching just title
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;
    if (section.includes(titleLower)) {
      return bullets;
    }
  }

  // Fuzzy match - check if any section contains significant parts of company or title
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;

    // Split and check meaningful words (4+ chars)
    const companyParts = companyLower.split(/\s+/).filter(p => p.length >= 4);
    const titleParts = titleLower.split(/\s+/).filter(p => p.length >= 4);

    for (const part of companyParts) {
      if (section.includes(part)) {
        return bullets;
      }
    }
    for (const part of titleParts) {
      if (section.includes(part)) {
        return bullets;
      }
    }
  }

  return [];
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function saveCurrentResume() {
  if (!currentUser) {
    alert('Please sign in to save resumes');
    return;
  }

  if (!state.lastGenerated) {
    alert('No resume to save');
    return;
  }

  const btn = document.getElementById('saveToLibraryBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    const res = await fetch('/api/resumes/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        ...state.lastGenerated
      })
    });

    if (!res.ok) throw new Error('Failed to save');

    const data = await res.json();
    btn.textContent = 'Saved!';
    setTimeout(() => {
      btn.textContent = 'Save to Library';
      btn.disabled = false;
    }, 2000);

    // Update dashboard stats
    updateDashboard();
  } catch (e) {
    alert('Error saving resume: ' + e.message);
    btn.textContent = 'Save to Library';
    btn.disabled = false;
  }
}

function copyResume() {
  const text = document.getElementById('resumeOutput').innerText || document.getElementById('resumeOutput').textContent;
  if (!text || text.trim() === '') {
    alert('No resume content to copy. Please generate a resume first.');
    return;
  }

  // Try modern clipboard API first, fall back to execCommand
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard!');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    alert('Copied to clipboard!');
  } catch (err) {
    alert('Failed to copy. Please select and copy manually.');
  }
  document.body.removeChild(textarea);
}

// Batch processing functions
function addBatchJob() {
  const container = document.getElementById('batchJobsList');
  const jobs = container.querySelectorAll('.batch-job');

  if (jobs.length >= 5) {
    alert('Maximum 5 jobs allowed');
    return;
  }

  const index = jobs.length;
  const jobHtml = `
    <div class="batch-job" data-index="${index}">
      <div class="batch-job-header">
        <div class="batch-job-number">${index + 1}</div>
        <button class="remove-job" onclick="removeBatchJob(${index})">&times;</button>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label>Company Name</label>
          <input type="text" class="batch-company" placeholder="e.g., Google">
        </div>
        <div class="form-group">
          <label>Job Title</label>
          <input type="text" class="batch-title" placeholder="e.g., Software Engineer">
        </div>
      </div>
      <div class="form-group">
        <label>Job URL (optional)</label>
        <input type="url" class="batch-url" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Job Description</label>
        <textarea class="batch-jd" rows="6" placeholder="Paste the job description here..."></textarea>
      </div>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', jobHtml);

  // Show all remove buttons if more than 1 job
  if (jobs.length >= 1) {
    container.querySelectorAll('.remove-job').forEach(btn => btn.style.display = 'block');
  }

  // Hide add button if at max
  if (index >= 4) {
    document.getElementById('addJobBtn').style.display = 'none';
  }
}

function removeBatchJob(index) {
  const container = document.getElementById('batchJobsList');
  const job = container.querySelector(`[data-index="${index}"]`);
  if (job) job.remove();

  // Renumber remaining jobs
  const jobs = container.querySelectorAll('.batch-job');
  jobs.forEach((job, i) => {
    job.dataset.index = i;
    job.querySelector('.batch-job-number').textContent = i + 1;
    job.querySelector('.remove-job').setAttribute('onclick', `removeBatchJob(${i})`);
  });

  // Hide remove button if only 1 job left
  if (jobs.length <= 1) {
    jobs[0]?.querySelector('.remove-job')?.style.setProperty('display', 'none');
  }

  // Show add button
  document.getElementById('addJobBtn').style.display = 'block';
}

async function processBatchJobs() {
  const jobElements = document.querySelectorAll('.batch-job');
  const jobs = [];

  jobElements.forEach(el => {
    const jd = el.querySelector('.batch-jd').value.trim();
    if (jd) {
      jobs.push({
        company: el.querySelector('.batch-company').value.trim(),
        title: el.querySelector('.batch-title').value.trim(),
        url: el.querySelector('.batch-url').value.trim(),
        jobDescription: jd
      });
    }
  });

  if (jobs.length === 0) {
    alert('Please add at least one job description');
    return;
  }

  document.getElementById('batchLoading').classList.add('active');
  document.getElementById('batchResults').style.display = 'none';

  try {
    const res = await fetch('/api/batch/process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        profile: state.profile,
        experience: state.experience,
        education: state.education,
        certs: state.certs,
        skills: state.skills,
        jobs
      })
    });

    if (!res.ok) throw new Error('Batch processing failed');

    const data = await res.json();
    displayBatchResults(data);
  } catch (e) {
    alert('Error processing jobs: ' + e.message);
  } finally {
    document.getElementById('batchLoading').classList.remove('active');
  }
}

function displayBatchResults(data) {
  document.getElementById('batchResults').style.display = 'block';

  // Summary
  document.getElementById('batchSummary').textContent = data.comparison.summary;
  document.getElementById('batchRecommendation').innerHTML = `
    <strong>Recommendation:</strong> ${data.comparison.recommendation}
    ${data.comparison.frequentlyMissing?.length > 0 ? `<br><br><strong>Skills to Develop:</strong> ${data.comparison.frequentlyMissing.join(', ')}` : ''}
  `;

  // Rankings
  document.getElementById('batchRankings').innerHTML = data.comparison.rankings.map(r => `
    <div class="ranking-item">
      <div class="ranking-position">#${r.rank}</div>
      <div class="ranking-details">
        <div class="ranking-company">${r.company}</div>
        <div class="ranking-title">${r.title}</div>
      </div>
      <div class="resume-score ${r.score >= 70 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</div>
      <span class="status-badge ${r.recommendation.toLowerCase().replace(' ', '-')}">${r.recommendation}</span>
    </div>
  `).join('');

  // Detailed results
  document.getElementById('batchDetailedResults').innerHTML = data.results.map((r, i) => `
    <div class="card" style="margin-bottom:20px">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">
        <div>
          <h4 style="margin:0">${r.company} - ${r.title}</h4>
          ${r.url ? `<a href="${r.url}" target="_blank" style="color:#6366f1;font-size:0.9em">View Job Posting</a>` : ''}
        </div>
        <div class="resume-score ${r.score >= 70 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</div>
      </div>

      ${r.error ? `<div style="color:#ef4444">Error: ${r.error}</div>` : `
        <div style="margin-bottom:15px">
          <strong>Strengths:</strong>
          <ul style="margin:5px 0 0 20px;color:#aaa">
            ${r.strengths.map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>

        <div style="margin-bottom:15px">
          <strong>Concerns:</strong>
          <ul style="margin:5px 0 0 20px;color:#aaa">
            ${r.concerns.map(c => `<li>${c}</li>`).join('')}
          </ul>
        </div>

        <div style="margin-bottom:15px">
          <strong>Matched Keywords:</strong>
          <span style="color:#10b981">${r.matchedKeywords.slice(0, 10).join(', ')}</span>
        </div>

        <div style="margin-bottom:15px">
          <strong>Missing Keywords:</strong>
          <span style="color:#ef4444">${r.missingKeywords.slice(0, 10).join(', ')}</span>
        </div>

        <details>
          <summary style="cursor:pointer;color:#6366f1">View Tailored Resume</summary>
          <pre style="background:#222;padding:15px;border-radius:8px;margin-top:10px;white-space:pre-wrap;font-size:0.85em">${r.resume}</pre>
        </details>

        <div style="margin-top:15px">
          <button onclick="saveBatchResult(${i})" class="small success">Save to Library</button>
        </div>
      `}
    </div>
  `).join('');

  // Store results for saving
  state.batchResults = data.results;
}

async function saveBatchResult(index) {
  if (!currentUser) {
    alert('Please sign in to save resumes');
    return;
  }

  const result = state.batchResults[index];
  if (!result || result.error) return;

  try {
    const res = await fetch('/api/resumes/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        company: result.company,
        title: result.title,
        jobUrl: result.url,
        score: result.score,
        matchedKeywords: result.matchedKeywords,
        missingKeywords: result.missingKeywords,
        tailoredSummary: result.tailoredSummary,
        resume: result.resume
      })
    });

    if (!res.ok) throw new Error('Failed to save');
    alert('Saved to library!');
    updateDashboard();
  } catch (e) {
    alert('Error saving: ' + e.message);
  }
}

// Library functions
async function loadLibrary() {
  if (!currentUser) {
    document.getElementById('resumeList').innerHTML = `
      <div style="color:#666;padding:40px;text-align:center">
        <p>Please sign in to view your resume library</p>
      </div>
    `;
    return;
  }

  const status = document.getElementById('libraryStatusFilter').value;

  try {
    const res = await fetch(`/api/resumes/list?email=${encodeURIComponent(currentUser.email)}&status=${status}`);
    if (!res.ok) throw new Error('Failed to load');

    const data = await res.json();

    if (data.resumes.length === 0) {
      document.getElementById('resumeList').innerHTML = `
        <div style="color:#666;padding:40px;text-align:center">
          <p>No resumes found${status !== 'all' ? ' with this status' : ''}</p>
          <p style="font-size:0.9em;margin-top:10px">Generate and save resumes to build your library</p>
        </div>
      `;
      return;
    }

    document.getElementById('resumeList').innerHTML = data.resumes.map(r => `
      <div class="resume-card" onclick="viewResumeDetail('${r.id}')">
        <div class="resume-card-header">
          <div>
            <div class="resume-company">${r.company}</div>
            <div class="resume-title">${r.title}</div>
          </div>
          <div class="resume-score ${r.score >= 70 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</div>
        </div>
        <div style="margin:10px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="status-badge ${r.status}">${r.status}</span>
          ${r.jobUrl ? `<a href="${r.jobUrl}" target="_blank" onclick="event.stopPropagation()" style="color:#6366f1;font-size:12px;text-decoration:none">View Job Posting ‚Üó</a>` : ''}
        </div>
        <div class="resume-meta">
          <span>Created ${formatDate(r.createdAt)}</span>
          ${(r.matchedKeywordsCount || r.matchedKeywords?.length) > 0 ? `<span style="color:#10b981">${r.matchedKeywordsCount || r.matchedKeywords.length} matched</span>` : ''}
          ${(r.missingKeywordsCount || r.missingKeywords?.length) > 0 ? `<span style="color:#ef4444">${r.missingKeywordsCount || r.missingKeywords.length} missing</span>` : ''}
        </div>
      </div>
    `).join('');

  } catch (e) {
    console.error('Load library error:', e);
    document.getElementById('resumeList').innerHTML = `
      <div style="color:#ef4444;padding:20px;text-align:center">
        Error loading library: ${e.message}
      </div>
    `;
  }
}

async function viewResumeDetail(resumeId) {
  if (!currentUser) return;

  try {
    const res = await fetch('/api/resumes/list', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: currentUser.email, resumeId })
    });

    if (!res.ok) throw new Error('Failed to load resume');

    const resume = await res.json();
    state.currentResumeDetail = resume;

    document.getElementById('resumeDetailTitle').textContent = `${resume.company} - ${resume.title}`;
    document.getElementById('resumeDetailContent').innerHTML = `
      <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap">
        <div class="stat-card" style="flex:1;min-width:150px">
          <div class="stat-value" style="font-size:2em">${resume.score}%</div>
          <div class="stat-label">Match Score</div>
        </div>
        <div style="flex:2;min-width:200px">
          <label style="display:block;margin-bottom:8px;color:#888">Application Status</label>
          <select id="resumeStatusSelect" onchange="updateResumeStatus('${resumeId}')" style="width:auto;min-width:200px">
            <option value="generated" ${resume.status === 'generated' ? 'selected' : ''}>Generated</option>
            <option value="applied" ${resume.status === 'applied' ? 'selected' : ''}>Applied</option>
            <option value="interviewing" ${resume.status === 'interviewing' ? 'selected' : ''}>Interviewing</option>
            <option value="offered" ${resume.status === 'offered' ? 'selected' : ''}>Offered</option>
            <option value="rejected" ${resume.status === 'rejected' ? 'selected' : ''}>Rejected</option>
            <option value="withdrawn" ${resume.status === 'withdrawn' ? 'selected' : ''}>Withdrawn</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;color:#888">Job Posting URL</label>
        <div style="display:flex;gap:10px;align-items:center">
          <input type="url" id="resumeJobUrl" value="${resume.jobUrl || ''}" placeholder="https://..." style="flex:1">
          <button onclick="saveResumeJobUrl('${resumeId}')" class="secondary small">Save URL</button>
          ${resume.jobUrl ? `<a href="${resume.jobUrl}" target="_blank" style="color:#6366f1;font-size:12px">Open ‚Üó</a>` : ''}
        </div>
      </div>

      <div style="margin-bottom:20px">
        <strong style="display:block;margin-bottom:8px">Matched Keywords (${(resume.matchedKeywords || []).length}):</strong>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${(resume.matchedKeywords || []).map(k => `<span style="display:inline-block;background:#10b981;color:#fff;padding:4px 12px;border-radius:15px;font-size:12px">${k}</span>`).join('')}
        </div>
      </div>

      <div style="margin-bottom:20px">
        <strong style="display:block;margin-bottom:8px">Missing Keywords (${(resume.missingKeywords || []).length}):</strong>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${(resume.missingKeywords || []).map(k => `<span style="display:inline-block;background:#ef4444;color:#fff;padding:4px 12px;border-radius:15px;font-size:12px">${k}</span>`).join('')}
        </div>
      </div>

      ${resume.tailoredSummary ? `
        <div class="card" style="margin-bottom:20px">
          <h4 style="color:#6366f1;margin-bottom:10px">Tailored Summary</h4>
          <p style="color:#ddd;font-style:italic">${resume.tailoredSummary}</p>
        </div>
      ` : ''}

      <div class="card" style="margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <h4 style="color:#00ff88;margin:0">Resume</h4>
          <button onclick="copyResumeFromDetail()" class="secondary small">Copy</button>
        </div>
        <pre style="white-space:pre-wrap;font-family:'Courier New',monospace;line-height:1.8;color:#aaa">${resume.resume || 'No resume content'}</pre>
      </div>

      ${resume.recruiterAssessment ? `
        <div class="card" style="background:linear-gradient(135deg,#1a1a2e,#16213e)">
          <h4 style="color:#f59e0b;margin-bottom:10px">Recruiter Assessment</h4>
          <div style="white-space:pre-wrap;line-height:1.8">${resume.recruiterAssessment}</div>
        </div>
      ` : ''}

      <div class="form-group" style="margin-top:20px">
        <label>Notes</label>
        <textarea id="resumeNotes" rows="3" placeholder="Add notes about this application...">${resume.notes || ''}</textarea>
        <button onclick="saveResumeNotes('${resumeId}')" class="secondary small" style="margin-top:10px">Save Notes</button>
      </div>

      <div style="margin-top:30px;padding-top:20px;border-top:1px solid #333">
        <button onclick="deleteResume('${resumeId}')" class="danger">Delete Resume</button>
      </div>
    `;

    document.getElementById('resumeDetailModal').classList.add('active');

  } catch (e) {
    alert('Error loading resume: ' + e.message);
  }
}

function closeResumeDetail() {
  document.getElementById('resumeDetailModal').classList.remove('active');
}

function copyResumeFromDetail() {
  const text = state.currentResumeDetail?.resume;
  if (!text) {
    alert('No resume content to copy.');
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard!');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

async function updateResumeStatus(resumeId) {
  if (!currentUser) return;

  const status = document.getElementById('resumeStatusSelect').value;

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        status
      })
    });

    if (!res.ok) throw new Error('Failed to update status');

    loadLibrary();
    updateDashboard();
  } catch (e) {
    alert('Error updating status: ' + e.message);
  }
}

async function saveResumeNotes(resumeId) {
  if (!currentUser) return;

  const notes = document.getElementById('resumeNotes').value;

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        notes
      })
    });

    if (!res.ok) throw new Error('Failed to save notes');

    alert('Notes saved!');
  } catch (e) {
    alert('Error saving notes: ' + e.message);
  }
}

async function saveResumeJobUrl(resumeId) {
  if (!currentUser) return;

  const jobUrl = document.getElementById('resumeJobUrl').value;

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        jobUrl
      })
    });

    if (!res.ok) throw new Error('Failed to save URL');

    alert('Job URL saved!');
    loadLibrary(); // Refresh library to show updated URL
  } catch (e) {
    alert('Error saving URL: ' + e.message);
  }
}

async function deleteResume(resumeId) {
  if (!currentUser) return;

  if (!confirm('Are you sure you want to delete this resume? This cannot be undone.')) {
    return;
  }

  try {
    const res = await fetch('/api/resumes/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId
      })
    });

    if (!res.ok) throw new Error('Failed to delete');

    closeResumeDetail();
    loadLibrary();
    updateDashboard();
  } catch (e) {
    alert('Error deleting resume: ' + e.message);
  }
}

// Auto-save on input change
function setupAutoSave() {
  // Profile fields
  ['fullName', 'email', 'phone', 'location', 'linkedin', 'github', 'portfolio', 'summary'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => {
        state.profile[id] = el.value;
        localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
        showSaveStatus();
      });
    }
  });
}

function showSaveStatus() {
  const status = document.getElementById('saveStatus');
  if (status) {
    status.textContent = 'Saved!';
    setTimeout(() => { status.textContent = ''; }, 2000);
  }
}

// Parse resume with AI
async function parseResumeWithAI() {
  const text = document.getElementById('importResume').value.trim();
  if (!text) {
    alert('Please paste your resume text first');
    return;
  }

  const status = document.getElementById('parseStatus');
  status.textContent = 'Parsing with AI...';

  try {
    const res = await fetch('/api/parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ resumeText: text })
    });

    if (!res.ok) throw new Error('Parse failed: ' + res.status);

    const data = await res.json();

    // Fill in profile fields
    if (data.profile) {
      Object.keys(data.profile).forEach(key => {
        const el = document.getElementById(key);
        if (el && data.profile[key]) {
          el.value = data.profile[key];
          state.profile[key] = data.profile[key];
        }
      });
      localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
    }

    // Add experience
    if (data.experience && data.experience.length > 0) {
      state.experience = data.experience;
      localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
      renderExperience();
    }

    // Add education
    if (data.education && data.education.length > 0) {
      state.education = data.education;
      localStorage.setItem('resumeEducation', JSON.stringify(state.education));
      renderEducation();
    }

    // Add skills
    if (data.skills) {
      state.skills = { ...state.skills, ...data.skills };
      localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
      renderSkills();
    }

    status.textContent = 'Parsed successfully!';
    document.getElementById('resumeTextModal').classList.remove('active');
    saveUserData();
    setTimeout(() => { status.textContent = ''; }, 3000);

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
  }
}

// Google OAuth
const GOOGLE_CLIENT_ID = '507770918834-2u3pd286qbnrars3vnmnms9i1sdmr952.apps.googleusercontent.com';
let currentUser = null;

async function loginWithGoogle() {
  const client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'email profile',
    callback: async (response) => {
      if (response.access_token) {
        const userRes = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
          headers: { Authorization: 'Bearer ' + response.access_token }
        });
        const user = await userRes.json();
        currentUser = user;
        localStorage.setItem('user', JSON.stringify(user));
        updateAuthUI();
        loadUserData();
        updateDashboard();
      }
    }
  });
  client.requestAccessToken();
}

function logout() {
  currentUser = null;
  localStorage.removeItem('user');
  updateAuthUI();
  updateDashboard();
}

function updateAuthUI() {
  const authSection = document.getElementById('authSection');
  const userInfo = document.getElementById('userInfo');
  const userName = document.getElementById('userName');

  if (currentUser) {
    authSection.style.display = 'none';
    userInfo.style.display = 'block';
    userName.textContent = currentUser.name || currentUser.email;
  } else {
    authSection.style.display = 'block';
    userInfo.style.display = 'none';
  }
}

async function loadUserData() {
  if (!currentUser) return;
  try {
    const res = await fetch('/api/user/load?email=' + encodeURIComponent(currentUser.email));
    if (res.ok) {
      const data = await res.json();
      if (data.profile) state.profile = data.profile;
      if (data.experience) state.experience = data.experience;
      if (data.education) state.education = data.education;
      if (data.certs) state.certs = data.certs;
      if (data.skills) state.skills = data.skills;
      if (data.projects) state.projects = data.projects;
      if (data.instructionPresets) state.instructionPresets = data.instructionPresets;
      loadProfile();
      renderExperience();
      renderEducation();
      renderCerts();
      renderSkills();
      renderProjects();
      loadInstructionPresets();
    }
  } catch (e) {
    console.log('No saved data found');
  }
}

async function saveUserData() {
  if (!currentUser) return;
  try {
    await fetch('/api/user/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        profile: state.profile,
        experience: state.experience,
        education: state.education,
        certs: state.certs,
        skills: state.skills,
        projects: state.projects,
        instructionPresets: state.instructionPresets
      })
    });
  } catch (e) {
    console.error('Save failed:', e);
  }
}

// LinkedIn ZIP Parser
async function parseLinkedInZip(file) {
  if (!file) return;
  const status = document.getElementById('importStatus');
  status.textContent = 'Reading LinkedIn data...';

  try {
    const JSZip = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
    const zip = await JSZip.default.loadAsync(file);

    let profileData = {};
    let positions = [];
    let education = [];
    let skills = [];

    // Parse Profile.csv
    const profileFile = zip.file(/Profile\.csv/i)[0];
    if (profileFile) {
      const text = await profileFile.async('text');
      const lines = text.split('\n');
      if (lines.length > 1) {
        const headers = parseCSVLine(lines[0]);
        const values = parseCSVLine(lines[1]);
        headers.forEach((h, i) => {
          if (h.toLowerCase().includes('first')) profileData.firstName = values[i];
          if (h.toLowerCase().includes('last')) profileData.lastName = values[i];
          if (h.toLowerCase().includes('headline')) profileData.summary = values[i];
          if (h.toLowerCase().includes('email')) profileData.email = values[i];
        });
      }
    }

    // Parse Positions.csv
    const positionsFile = zip.file(/Positions\.csv/i)[0];
    if (positionsFile) {
      const text = await positionsFile.async('text');
      const lines = text.split('\n');
      if (lines.length > 1) {
        const headers = parseCSVLine(lines[0]);
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const pos = {};
          headers.forEach((h, idx) => {
            const hl = h.toLowerCase();
            if (hl.includes('company')) pos.company = values[idx];
            if (hl.includes('title')) pos.title = values[idx];
            if (hl.includes('description')) pos.description = values[idx];
            if (hl.includes('location')) pos.location = values[idx];
            if (hl.includes('started on')) pos.start = values[idx];
            if (hl.includes('finished on')) pos.end = values[idx];
          });
          if (pos.company || pos.title) positions.push(pos);
        }
      }
    }

    // Parse Education.csv
    const eduFile = zip.file(/Education\.csv/i)[0];
    if (eduFile) {
      const text = await eduFile.async('text');
      const lines = text.split('\n');
      if (lines.length > 1) {
        const headers = parseCSVLine(lines[0]);
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const edu = {};
          headers.forEach((h, idx) => {
            const hl = h.toLowerCase();
            if (hl.includes('school')) edu.school = values[idx];
            if (hl.includes('degree')) edu.degree = values[idx];
            if (hl.includes('start')) edu.start = values[idx];
            if (hl.includes('end')) edu.end = values[idx];
          });
          if (edu.school) education.push(edu);
        }
      }
    }

    // Parse Skills.csv
    const skillsFile = zip.file(/Skills\.csv/i)[0];
    if (skillsFile) {
      const text = await skillsFile.async('text');
      const lines = text.split('\n');
      for (let i = 1; i < lines.length; i++) {
        const skill = lines[i].trim().replace(/"/g, '');
        if (skill) skills.push(skill);
      }
    }

    // Apply to state
    if (profileData.firstName) {
      state.profile.fullName = (profileData.firstName + ' ' + (profileData.lastName || '')).trim();
    }
    if (profileData.email) state.profile.email = profileData.email;
    if (profileData.summary) state.profile.summary = profileData.summary;
    loadProfile();

    if (positions.length > 0) {
      state.experience = positions.map(p => ({
        title: p.title || '',
        company: p.company || '',
        location: p.location || '',
        start: p.start || '',
        end: p.end || '',
        bullets: p.description ? p.description.split(/[.;]\s+/).filter(b => b.trim()) : []
      }));
      localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
      renderExperience();
    }

    if (education.length > 0) {
      state.education = education.map(e => ({
        degree: e.degree || '',
        school: e.school || '',
        start: e.start || '',
        end: e.end || '',
        location: '',
        gpa: '',
        extras: ''
      }));
      localStorage.setItem('resumeEducation', JSON.stringify(state.education));
      renderEducation();
    }

    if (skills.length > 0) {
      state.skills.technical = [...new Set([...state.skills.technical, ...skills])];
      localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
      renderSkills();
    }

    localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
    status.textContent = 'LinkedIn data imported! Found ' + positions.length + ' positions, ' + education.length + ' education, ' + skills.length + ' skills';
    saveUserData();

  } catch (e) {
    status.textContent = 'Error parsing ZIP: ' + e.message;
    console.error(e);
  }
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current.trim());
  return result;
}

// Check for saved user on load
const savedUser = localStorage.getItem('user');
if (savedUser) {
  currentUser = JSON.parse(savedUser);
  updateAuthUI();
}

// Initialize
loadProfile();
renderExperience();
renderEducation();
renderCerts();
renderSkills();
renderProjects();
loadInstructionPresets();
setupAutoSave();
updateDashboard();
console.log('Claude Resume initialized v3');
</script>

<!-- Hidden PDF Template -->
<div id="pdfTemplate" style="display:none">
<div id="pdfContent" style="font-family:Arial,Helvetica,sans-serif;color:#1a1a1a;line-height:1.5;max-width:8.5in;margin:0 auto;padding:0.5in;background:#fff">
<!-- Header -->
<div id="pdfHeader" style="text-align:center;border-bottom:2px solid #2563eb;padding-bottom:15px;margin-bottom:20px">
<h1 id="pdfName" style="font-size:24px;font-weight:700;color:#1a1a1a;margin:0 0 8px 0"></h1>
<div id="pdfContact" style="font-size:11px;color:#4b5563"></div>
</div>
<!-- Summary -->
<div id="pdfSummarySection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin:0 0 10px 0">Professional Summary</h2>
<p id="pdfSummary" style="font-size:11px;margin:0;text-align:justify"></p>
</div>
<!-- Experience -->
<div id="pdfExperienceSection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin:0 0 10px 0">Professional Experience</h2>
<div id="pdfExperience"></div>
</div>
<!-- Education -->
<div id="pdfEducationSection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin:0 0 10px 0">Education</h2>
<div id="pdfEducation"></div>
</div>
<!-- Skills -->
<div id="pdfSkillsSection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin:0 0 10px 0">Skills</h2>
<p id="pdfSkills" style="font-size:11px;margin:0"></p>
</div>
<!-- Projects -->
<div id="pdfProjectsSection" style="margin-bottom:20px;display:none">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin:0 0 10px 0">Projects</h2>
<div id="pdfProjects"></div>
</div>
<!-- Certifications -->
<div id="pdfCertsSection" style="margin-bottom:20px;display:none">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:5px;margin:0 0 10px 0">Certifications</h2>
<div id="pdfCerts"></div>
</div>
</div>
</div>

<!-- Hidden Cover Letter PDF Template -->
<div id="coverLetterPdfTemplate" style="display:none">
<div id="coverLetterPdfContent" style="font-family:Arial,Helvetica,sans-serif;color:#1a1a1a;line-height:1.6;max-width:8.5in;margin:0 auto;padding:0.75in 1in;background:#fff">
<!-- Header -->
<div id="clPdfHeader" style="margin-bottom:30px">
<div id="clPdfName" style="font-size:18px;font-weight:700;color:#1a1a1a;margin-bottom:5px"></div>
<div id="clPdfContact" style="font-size:11px;color:#4b5563"></div>
</div>
<!-- Date -->
<div id="clPdfDate" style="font-size:11px;margin-bottom:25px"></div>
<!-- Recipient -->
<div id="clPdfRecipient" style="font-size:11px;margin-bottom:25px">
<div id="clPdfCompany" style="font-weight:600"></div>
<div id="clPdfPosition"></div>
</div>
<!-- Salutation -->
<div style="font-size:11px;margin-bottom:15px">Dear Hiring Manager,</div>
<!-- Body -->
<div id="clPdfBody" style="font-size:11px;text-align:justify"></div>
<!-- Closing -->
<div style="font-size:11px;margin-top:25px">
<div>Sincerely,</div>
<div style="margin-top:30px;font-weight:600" id="clPdfSignature"></div>
</div>
</div>
</div>

<script>
// ============ PDF Export Functions ============

function downloadPDF() {
  if (!state.lastGenerated || !state.lastGenerated.resume) {
    alert('Please generate a resume first');
    return;
  }

  // Check if html2pdf is loaded
  if (typeof html2pdf === 'undefined') {
    alert('PDF library not loaded. Please refresh the page and try again.');
    return;
  }

  try {
    // Populate PDF template from current state and generated resume
    populatePDFTemplate();

    // Get the elements - need to show parent template too
    const template = document.getElementById('pdfTemplate');
    const element = document.getElementById('pdfContent');
    if (!element || !template) {
      alert('PDF template not found. Please refresh the page.');
      return;
    }

    // Show both template and content for rendering
    template.style.display = 'block';
    element.style.display = 'block';

    // Clean filename
    const safeName = (state.profile.fullName || 'Resume').replace(/[^a-zA-Z0-9]/g, '_');
    const safeCompany = (state.lastGenerated.company || 'Resume').replace(/[^a-zA-Z0-9]/g, '_');

    // Configure options for html2pdf
    const opt = {
      margin: 0,
      filename: `${safeName}_${safeCompany}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
      pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    // Generate PDF
    html2pdf().set(opt).from(element).save().then(() => {
      template.style.display = 'none';
      element.style.display = 'none';
    }).catch(err => {
      console.error('PDF generation error:', err);
      alert('Error generating PDF: ' + err.message);
      template.style.display = 'none';
      element.style.display = 'none';
    });
  } catch (err) {
    console.error('PDF setup error:', err);
    alert('Error setting up PDF: ' + err.message);
  }
}

function populatePDFTemplate() {
  const profile = state.profile;
  const generated = state.lastGenerated;

  // Header
  document.getElementById('pdfName').textContent = profile.fullName || 'Your Name';

  // Contact info
  const contactParts = [];
  if (profile.email) contactParts.push(profile.email);
  if (profile.phone) contactParts.push(profile.phone);
  if (profile.location) contactParts.push(profile.location);
  if (profile.linkedin) contactParts.push(profile.linkedin.replace('https://', ''));
  if (profile.github) contactParts.push(profile.github.replace('https://', ''));
  document.getElementById('pdfContact').textContent = contactParts.join(' | ');

  // Summary - use tailored summary if available
  const summary = generated.tailoredSummary || profile.summary || '';
  document.getElementById('pdfSummary').textContent = summary;
  document.getElementById('pdfSummarySection').style.display = summary ? 'block' : 'none';

  // Experience - parse from generated resume text
  const expHtml = parseResumeExperience(generated.resume);
  document.getElementById('pdfExperience').innerHTML = expHtml;
  document.getElementById('pdfExperienceSection').style.display = expHtml ? 'block' : 'none';

  // Education
  const eduHtml = state.education.map(edu => `
    <div style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:baseline">
        <strong style="font-size:12px">${edu.degree}</strong>
        <span style="font-size:10px;color:#6b7280">${edu.startYear || ''} - ${edu.endYear || ''}</span>
      </div>
      <div style="font-size:11px;color:#4b5563">${edu.school}${edu.location ? ', ' + edu.location : ''}</div>
      ${edu.gpa ? `<div style="font-size:10px;color:#6b7280">GPA: ${edu.gpa}</div>` : ''}
    </div>
  `).join('');
  document.getElementById('pdfEducation').innerHTML = eduHtml;
  document.getElementById('pdfEducationSection').style.display = eduHtml ? 'block' : 'none';

  // Skills
  const allSkills = [
    ...(state.skills.technical || []),
    ...(state.skills.tools || [])
  ];
  document.getElementById('pdfSkills').textContent = allSkills.join(', ');
  document.getElementById('pdfSkillsSection').style.display = allSkills.length ? 'block' : 'none';

  // Projects
  if (state.projects && state.projects.length > 0) {
    const projHtml = state.projects.slice(0, 3).map(proj => `
      <div style="margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:baseline">
          <strong style="font-size:12px">${proj.name}</strong>
          ${proj.url ? `<span style="font-size:10px;color:#2563eb">${proj.url.replace('https://', '')}</span>` : ''}
        </div>
        <div style="font-size:11px;color:#4b5563;margin:3px 0">${proj.shortDesc || ''}</div>
        ${proj.technologies ? `<div style="font-size:10px;color:#6b7280">Tech: ${proj.technologies.join(', ')}</div>` : ''}
      </div>
    `).join('');
    document.getElementById('pdfProjects').innerHTML = projHtml;
    document.getElementById('pdfProjectsSection').style.display = 'block';
  } else {
    document.getElementById('pdfProjectsSection').style.display = 'none';
  }

  // Certifications
  if (state.certs && state.certs.length > 0) {
    const certHtml = state.certs.map(cert => `
      <div style="margin-bottom:8px;font-size:11px">
        <strong>${cert.name}</strong> - ${cert.org}${cert.date ? ` (${cert.date})` : ''}
      </div>
    `).join('');
    document.getElementById('pdfCerts').innerHTML = certHtml;
    document.getElementById('pdfCertsSection').style.display = 'block';
  } else {
    document.getElementById('pdfCertsSection').style.display = 'none';
  }
}

function parseResumeExperience(resumeText) {
  if (!resumeText) return '';

  // Parse the plain text resume to extract experience section
  const lines = resumeText.split('\n');
  let inExperience = false;
  let expHtml = '';
  let currentJob = null;
  let bullets = [];

  for (const line of lines) {
    const trimmed = line.trim();
    // Remove markdown bold markers for parsing
    const cleanLine = trimmed.replace(/\*\*/g, '').replace(/\*/g, '');

    // Detect section headers
    if (/^(EXPERIENCE|PROFESSIONAL EXPERIENCE|WORK EXPERIENCE|WORK HISTORY)/i.test(cleanLine)) {
      inExperience = true;
      continue;
    }
    if (/^(EDUCATION|SKILLS|PROJECTS|CERTIFICATIONS|TECHNICAL SKILLS|KEY PROJECTS)/i.test(cleanLine)) {
      // Save last job before exiting
      if (currentJob) {
        expHtml += formatJobEntry(currentJob, bullets);
      }
      inExperience = false;
      currentJob = null;
      bullets = [];
      continue;
    }

    if (inExperience && cleanLine) {
      // Check if this is a new job entry
      const hasPipe = cleanLine.includes('|');
      const isNotBullet = !trimmed.startsWith('-') && !trimmed.startsWith('‚Ä¢') && !trimmed.match(/^\d+\./);

      if (hasPipe && isNotBullet) {
        // Save previous job
        if (currentJob) {
          expHtml += formatJobEntry(currentJob, bullets);
          bullets = [];
        }
        const parts = cleanLine.split('|').map(p => p.trim());
        currentJob = {
          title: parts[0] || '',
          company: parts[1] || '',
          location: parts[2] || '',
          dates: parts[3] || ''
        };
      } else if (isNotBullet && /^[A-Z][a-z]+\s+(at|@)\s+[A-Z]/i.test(cleanLine)) {
        // Pattern: "Title at Company"
        if (currentJob) {
          expHtml += formatJobEntry(currentJob, bullets);
          bullets = [];
        }
        const match = cleanLine.match(/^(.+?)\s+(?:at|@)\s+(.+?)(?:\s*[,|]\s*(.+?))?(?:\s*[,|]\s*(.+))?$/i);
        if (match) {
          currentJob = {
            title: match[1] || '',
            company: match[2] || '',
            location: match[3] || '',
            dates: match[4] || ''
          };
        }
      } else if (currentJob) {
        // Check for bullets
        if (trimmed.startsWith('-') || trimmed.startsWith('‚Ä¢')) {
          const bullet = trimmed.replace(/^[-‚Ä¢]\s*/, '').replace(/\*\*/g, '');
          if (bullet.length > 10) {
            bullets.push(bullet);
          }
        }
        // Also catch lines starting with action verbs
        else if (/^(Led|Managed|Developed|Built|Created|Designed|Implemented|Executed|Deployed|Configured|Conducted|Diagnosed|Served|Partnered|Optimized|Orchestrated|Collaborated|Applied|Established|Increased|Reduced)\s/i.test(cleanLine)) {
          if (cleanLine.length > 30) {
            bullets.push(cleanLine);
          }
        }
      }
    }
  }

  // Don't forget the last job
  if (currentJob) {
    expHtml += formatJobEntry(currentJob, bullets);
  }

  return expHtml;
}

function formatJobEntry(job, bullets) {
  return `
    <div style="margin-bottom:15px">
      <div style="display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap">
        <strong style="font-size:12px">${job.title}</strong>
        <span style="font-size:10px;color:#6b7280">${job.dates}</span>
      </div>
      <div style="font-size:11px;color:#4b5563;margin-bottom:5px">${job.company}${job.location ? ', ' + job.location : ''}</div>
      <ul style="margin:0;padding-left:18px;font-size:11px">
        ${bullets.map(b => `<li style="margin-bottom:3px">${b}</li>`).join('')}
      </ul>
    </div>
  `;
}

// ============ Cover Letter PDF Export ============

function downloadCoverLetterPDF() {
  if (!state.lastGenerated || !state.lastGenerated.coverLetter) {
    alert('No cover letter available. Generate a resume with the cover letter option enabled.');
    return;
  }

  // Check if html2pdf is loaded
  if (typeof html2pdf === 'undefined') {
    alert('PDF library not loaded. Please refresh the page and try again.');
    return;
  }

  try {
    // Populate cover letter PDF template
    populateCoverLetterPDFTemplate();

    // Get the elements - need to show parent template too
    const template = document.getElementById('coverLetterPdfTemplate');
    const element = document.getElementById('coverLetterPdfContent');
    if (!element || !template) {
      alert('Cover letter PDF template not found. Please refresh the page.');
      return;
    }

    // Show both template and content for rendering
    template.style.display = 'block';
    element.style.display = 'block';

    // Clean filename
    const safeName = (state.profile.fullName || 'Cover_Letter').replace(/[^a-zA-Z0-9]/g, '_');
    const safeCompany = (state.lastGenerated.company || '').replace(/[^a-zA-Z0-9]/g, '_');

    // Configure options for html2pdf
    const opt = {
      margin: 0,
      filename: `Cover_Letter_${safeName}_${safeCompany}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };

    // Generate PDF
    html2pdf().set(opt).from(element).save().then(() => {
      template.style.display = 'none';
      element.style.display = 'none';
    }).catch(err => {
      console.error('Cover letter PDF generation error:', err);
      alert('Error generating PDF: ' + err.message);
      template.style.display = 'none';
      element.style.display = 'none';
    });
  } catch (err) {
    console.error('Cover letter PDF setup error:', err);
    alert('Error setting up PDF: ' + err.message);
  }
}

function populateCoverLetterPDFTemplate() {
  const profile = state.profile;
  const generated = state.lastGenerated;

  // Header
  document.getElementById('clPdfName').textContent = profile.fullName || 'Your Name';

  // Contact info
  const contactParts = [];
  if (profile.email) contactParts.push(profile.email);
  if (profile.phone) contactParts.push(profile.phone);
  if (profile.location) contactParts.push(profile.location);
  document.getElementById('clPdfContact').textContent = contactParts.join(' | ');

  // Date
  const today = new Date();
  const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('clPdfDate').textContent = dateStr;

  // Recipient
  document.getElementById('clPdfCompany').textContent = generated.company || '';
  document.getElementById('clPdfPosition').textContent = generated.title ? `Re: ${generated.title}` : '';

  // Body - parse cover letter and convert to paragraphs
  const coverLetter = generated.coverLetter || '';
  // Remove common salutation and closing if present (we add our own)
  let bodyText = coverLetter
    .replace(/^Dear[^,]*,?\s*/i, '')
    .replace(/\s*Sincerely,?\s*[\s\S]*$/i, '')
    .replace(/\s*Best regards,?\s*[\s\S]*$/i, '')
    .replace(/\s*Kind regards,?\s*[\s\S]*$/i, '')
    .trim();

  // Convert to paragraphs
  const paragraphs = bodyText.split(/\n\n+/).filter(p => p.trim());
  document.getElementById('clPdfBody').innerHTML = paragraphs
    .map(p => `<p style="margin:0 0 12px 0">${p.replace(/\n/g, ' ')}</p>`)
    .join('');

  // Signature
  document.getElementById('clPdfSignature').textContent = profile.fullName || 'Your Name';
}

// ============ Google Docs Export Functions ============

// CONFIGURATION: Replace with your Google Cloud OAuth Client ID
// Follow these steps to get your client ID:
// 1. Go to console.cloud.google.com
// 2. Create a new project (or select existing)
// 3. Enable Google Docs API and Google Drive API
// 4. Go to Credentials > Create Credentials > OAuth Client ID
// 5. Select "Web application" and add your domain to authorized JavaScript origins
// 6. Copy the client ID and paste it below
const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com';

let googleAccessToken = null;

async function exportToGoogleDocs() {
  if (!state.lastGenerated || !state.lastGenerated.resume) {
    alert('Please generate a resume first');
    return;
  }

  // Check if user is signed in with Google
  if (!googleAccessToken) {
    // Trigger Google sign-in
    await signInWithGoogle();
    if (!googleAccessToken) {
      return; // User cancelled or error
    }
  }

  const btn = document.getElementById('googleDocsBtn');
  const originalText = btn.textContent;
  btn.textContent = 'Creating...';
  btn.disabled = true;

  try {
    const response = await fetch('/api/google-docs', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        accessToken: googleAccessToken,
        resumeData: {
          fullName: state.profile.fullName || 'Your Name',
          email: state.profile.email || '',
          phone: state.profile.phone || '',
          location: state.profile.location || '',
          linkedin: state.profile.linkedin || '',
          github: state.profile.github || '',
          summary: state.lastGenerated.tailoredSummary || state.profile.summary || '',
          resume: state.lastGenerated.resume,
          coverLetter: state.lastGenerated.coverLetter || null,
          company: state.lastGenerated.company || 'Resume',
          title: state.lastGenerated.title || 'Position',
          experience: state.experience,
          education: state.education,
          skills: state.skills,
          projects: state.projects,
          certs: state.certs
        }
      })
    });

    const data = await response.json();

    if (data.error) {
      if (data.error.includes('token')) {
        // Token expired, clear and retry
        googleAccessToken = null;
        alert('Google session expired. Please sign in again.');
      } else {
        alert('Error creating Google Doc: ' + data.error);
      }
      return;
    }

    if (data.docUrl) {
      // Success - open the document
      window.open(data.docUrl, '_blank');
      alert('Resume exported to Google Docs successfully!');
    }
  } catch (err) {
    console.error('Google Docs export error:', err);
    alert('Error exporting to Google Docs. Please try again.');
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

function signInWithGoogle() {
  return new Promise((resolve) => {
    // Check if google.accounts is available
    if (typeof google === 'undefined' || !google.accounts) {
      alert('Google Sign-In is not available. Please refresh the page and try again.');
      resolve();
      return;
    }

    // Check if Google Client ID is configured
    if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
      alert('Google Docs export requires configuration.\n\nPlease set up a Google Cloud project and update GOOGLE_CLIENT_ID in the code.\n\nSee: console.cloud.google.com');
      resolve();
      return;
    }

    const client = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file',
      callback: (response) => {
        if (response.access_token) {
          googleAccessToken = response.access_token;
          resolve();
        } else {
          console.error('No access token in response');
          resolve();
        }
      },
      error_callback: (error) => {
        console.error('Google sign-in error:', error);
        if (error.type === 'popup_closed') {
          // User closed the popup
        } else {
          alert('Google sign-in failed. Please check your Google Cloud project configuration.');
        }
        resolve();
      }
    });

    client.requestAccessToken();
  });
}
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>
