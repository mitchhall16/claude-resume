<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Resume - AI-Powered ATS Resume Builder</title>
<!-- PDF Export Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://unpkg.com/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
<!-- React for Prospect Tool -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;line-height:1.6}
.container{max-width:1400px;margin:0 auto;padding:20px}
header{text-align:center;padding:30px 0;border-bottom:1px solid #222}
h1{font-size:2.5em;background:linear-gradient(135deg,#6366f1,#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
.subtitle{color:#888;font-size:1.1em}
.tabs{display:flex;gap:10px;margin:30px 0;flex-wrap:wrap}
.tab{padding:12px 24px;background:#1a1a1a;border:1px solid #333;border-radius:8px;cursor:pointer;transition:all 0.2s}
.tab:hover{border-color:#6366f1}
.tab.active{background:#6366f1;border-color:#6366f1;color:#fff}
.tab-badge{background:#ef4444;color:#fff;font-size:0.7em;padding:2px 6px;border-radius:10px;margin-left:6px}
.panel{display:none;background:#111;border:1px solid #222;border-radius:12px;padding:30px}
.panel.active{display:block}
h2{font-size:1.5em;margin-bottom:20px;color:#fff}
h3{font-size:1.2em;margin:20px 0 15px;color:#a5a5a5}
.form-group{margin-bottom:20px}
label{display:block;margin-bottom:8px;color:#888;font-size:0.9em}
input,textarea,select{width:100%;padding:12px;background:#1a1a1a;border:1px solid #333;border-radius:8px;color:#fff;font-size:1em}
input:focus,textarea:focus,select:focus{outline:none;border-color:#6366f1}
textarea{min-height:120px;resize:vertical;font-family:inherit}
button{padding:12px 24px;background:#6366f1;color:#fff;border:none;border-radius:8px;cursor:pointer;font-size:1em;transition:all 0.2s}
button:hover{background:#5558e3}
button:disabled{opacity:0.5;cursor:not-allowed}
button.secondary{background:#333}
button.secondary:hover{background:#444}
button.danger{background:#ef4444}
button.danger:hover{background:#dc2626}
button.success{background:#10b981}
button.success:hover{background:#059669}
button.small{padding:6px 12px;font-size:0.85em}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:20px}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:15px}
.card{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px}
.card h4{margin-bottom:15px;color:#fff}
.card.highlight{border-color:#6366f1;background:linear-gradient(135deg,#1a1a2e,#16213e)}
.item{background:#222;border-radius:8px;padding:15px;margin-bottom:10px;position:relative}
.item-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.item-title{font-weight:600;color:#fff}
.item-subtitle{color:#888;font-size:0.9em}
.item-actions{display:flex;gap:8px}
.item-actions button{padding:5px 10px;font-size:0.8em}
.bullets{margin-top:10px}
.bullet{display:flex;gap:10px;margin-bottom:8px;align-items:start}
.bullet-dot{color:#6366f1;margin-top:2px}
.add-btn{width:100%;padding:15px;background:#1a1a1a;border:2px dashed #333;border-radius:8px;color:#888;cursor:pointer;transition:all 0.2s}
.add-btn:hover{border-color:#6366f1;color:#6366f1}
.tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.tag{background:#333;padding:6px 12px;border-radius:20px;font-size:0.85em;display:flex;align-items:center;gap:6px}
.tag-remove{cursor:pointer;color:#888}
.tag-remove:hover{color:#ef4444}
.tech-tag{background:linear-gradient(135deg,#1e3a5f,#1a1a2e);padding:4px 10px;border-radius:12px;font-size:0.8em;color:#60a5fa;border:1px solid #2563eb33;white-space:nowrap}
.feature-chip{background:#1a1a2e;padding:6px 12px;border-radius:8px;font-size:0.85em;color:#a5b4fc;border:1px solid #4f46e533;line-height:1.4}
.ai-badge{background:linear-gradient(135deg,#8b5cf6,#6366f1);padding:3px 10px;border-radius:12px;font-size:0.7em;color:#fff;font-weight:500;white-space:nowrap}
.tag-input{display:flex;gap:10px;margin-top:10px}
.tag-input input{flex:1}
.tag-input button{white-space:nowrap}
.resources-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px}
.resource-card{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px}
.resource-card h4{color:#6366f1;margin-bottom:10px}
.resource-list{list-style:none}
.resource-list li{padding:8px 0;border-bottom:1px solid #222;color:#aaa}
.resource-list li:last-child{border-bottom:none}
.generate-section{text-align:center;padding:40px}
.generate-section h2{margin-bottom:20px}
.generate-btn{font-size:1.2em;padding:16px 40px;background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.generate-btn:hover{opacity:0.9}
.output-section{margin-top:30px}
.score-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #333;border-radius:12px;padding:30px;text-align:center;margin-bottom:20px}
.score{font-size:4em;font-weight:700;background:linear-gradient(135deg,#00ff88,#00cc6a);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.score-label{color:#888;margin-top:10px}
.keywords{margin-top:20px}
.keyword-match{display:inline-block;background:#00ff8820;color:#00ff88;padding:4px 10px;border-radius:15px;font-size:12px;margin:3px}
.keyword-missing{display:inline-block;background:#ff6b6b20;color:#ff6b6b;padding:4px 10px;border-radius:15px;font-size:12px;margin:3px}
.resume-output{background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:30px;white-space:pre-wrap;font-family:'Courier New',monospace;line-height:1.8}
.copy-btn{position:absolute;top:15px;right:15px}
.loading{display:none;text-align:center;padding:40px}
.loading.active{display:block}
.spinner{width:50px;height:50px;border:4px solid #333;border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#111;border:1px solid #333;border-radius:12px;padding:30px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-close{background:none;border:none;color:#888;font-size:1.5em;cursor:pointer}
.status{padding:15px;border-radius:8px;margin-bottom:20px;display:none}
.status.success{display:block;background:rgba(0,255,136,0.1);border:1px solid #00ff88;color:#00ff88}
.status.error{display:block;background:rgba(255,107,107,0.1);border:1px solid #ff6b6b;color:#ff6b6b}

/* Dashboard Styles */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #333;border-radius:12px;padding:25px;text-align:center}
.stat-value{font-size:3em;font-weight:700;color:#6366f1}
.stat-label{color:#888;margin-top:5px;font-size:0.9em}
.stat-card.success .stat-value{color:#10b981}
.stat-card.warning .stat-value{color:#f59e0b}
.stat-card.danger .stat-value{color:#ef4444}
.activity-list{max-height:400px;overflow-y:auto}
.activity-item{display:flex;align-items:center;gap:15px;padding:15px;border-bottom:1px solid #222}
.activity-icon{width:40px;height:40px;border-radius:50%;background:#333;display:flex;align-items:center;justify-content:center;font-size:1.2em}
.activity-content{flex:1}
.activity-title{color:#fff;font-weight:500}
.activity-meta{color:#666;font-size:0.85em}

/* Resume Library Styles */
.library-filters{display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.library-filters select{width:auto;min-width:150px}
.resume-list{display:grid;gap:15px}
.resume-card{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;cursor:pointer;transition:all 0.2s}
.resume-card:hover{border-color:#6366f1;transform:translateY(-2px)}
.resume-card-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:10px}
.resume-company{font-weight:600;color:#fff;font-size:1.1em}
.resume-title{color:#888;font-size:0.95em}
.resume-score{font-size:1.5em;font-weight:700}
.resume-score.high{color:#10b981}
.resume-score.medium{color:#f59e0b}
.resume-score.low{color:#ef4444}
.resume-meta{display:flex;gap:15px;margin-top:10px;color:#666;font-size:0.85em}
.status-badge{display:inline-block;padding:4px 10px;border-radius:20px;font-size:0.8em;font-weight:500}
.status-badge.generated{background:#333;color:#888}
.status-badge.applied{background:rgba(99,102,241,0.2);color:#6366f1}
.status-badge.interviewing{background:rgba(245,158,11,0.2);color:#f59e0b}
.status-badge.offered{background:rgba(16,185,129,0.2);color:#10b981}
.status-badge.rejected{background:rgba(239,68,68,0.2);color:#ef4444}
.status-badge.withdrawn{background:rgba(107,114,128,0.2);color:#6b7280}

/* Batch Processing Styles */
.batch-jobs{display:grid;gap:20px}
.batch-job{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;position:relative}
.batch-job-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.batch-job-number{background:#6366f1;color:#fff;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600}
.remove-job{background:#333;border:none;color:#888;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:1.2em}
.remove-job:hover{background:#ef4444;color:#fff}
.batch-results{margin-top:30px}
.comparison-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #6366f1;border-radius:12px;padding:25px;margin-bottom:20px}
.ranking-list{display:grid;gap:10px}
.ranking-item{display:flex;align-items:center;gap:15px;background:#222;padding:15px;border-radius:8px}
.ranking-position{font-size:1.5em;font-weight:700;color:#6366f1;width:40px}
.ranking-details{flex:1}
.ranking-company{font-weight:600;color:#fff}
.ranking-title{color:#888;font-size:0.9em}

/* Mobile Responsive */
@media(max-width:768px){
  .grid-2,.grid-3,.grid-4{grid-template-columns:1fr}
  .tabs{justify-content:center}
  .tab{padding:10px 16px;font-size:0.9em}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .modal-content{width:95%;padding:20px}
}

/* Interview Prep Styles */
.interview-setup{margin-bottom:20px}
.interview-active{display:none}
.interview-active.active{display:block}
.interview-setup.hidden{display:none}
.question-card{background:linear-gradient(135deg,#1a1a2e,#16213e);border:1px solid #6366f1;border-radius:12px;padding:25px;margin-bottom:20px}
.question-number{color:#888;font-size:0.9em;margin-bottom:10px}
.question-text{font-size:1.3em;color:#fff;line-height:1.5;margin-bottom:15px}
.question-type{display:inline-block;background:#333;padding:4px 12px;border-radius:15px;font-size:0.8em;color:#a5b4fc;margin-right:10px}
.question-time{color:#888;font-size:0.85em}
.interview-controls{display:flex;gap:15px;flex-wrap:wrap;margin:20px 0}
.interview-controls button{display:flex;align-items:center;gap:8px;padding:12px 20px}
.record-btn{background:linear-gradient(135deg,#ef4444,#dc2626)}
.record-btn:hover{background:linear-gradient(135deg,#dc2626,#b91c1c)}
.record-btn.recording{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.6}}
.speak-btn{background:linear-gradient(135deg,#8b5cf6,#6366f1)}
.speak-btn:hover{background:linear-gradient(135deg,#7c3aed,#5558e3)}
.speak-btn.speaking{animation:pulse 1s infinite}
.transcript-area{background:#1a1a1a;border:1px solid #333;border-radius:10px;padding:20px;min-height:100px;margin:15px 0}
.transcript-area.empty{color:#666;font-style:italic}
.transcript-area.recording{border-color:#ef4444;box-shadow:0 0 10px rgba(239,68,68,0.2)}
.feedback-card{background:#111;border:1px solid #333;border-radius:12px;padding:25px;margin-top:20px}
.feedback-score{font-size:3em;font-weight:700;text-align:center;margin-bottom:20px}
.feedback-score.high{color:#10b981}
.feedback-score.medium{color:#f59e0b}
.feedback-score.low{color:#ef4444}
.feedback-section{margin-bottom:20px}
.feedback-section h4{margin-bottom:10px;display:flex;align-items:center;gap:8px}
.feedback-section ul{list-style:none;padding:0}
.feedback-section li{padding:8px 0;border-bottom:1px solid #222;color:#aaa;display:flex;align-items:start;gap:10px}
.feedback-section li:last-child{border-bottom:none}
.strength-icon{color:#10b981}
.improve-icon{color:#f59e0b}
.session-summary{background:linear-gradient(135deg,#1a2e1a,#16213e);border:1px solid #10b981;border-radius:12px;padding:30px;text-align:center}
.session-summary h3{color:#10b981;margin-bottom:20px}
.session-stats{display:flex;justify-content:center;gap:40px;margin-bottom:25px}
.session-stat{text-align:center}
.session-stat-value{font-size:2.5em;font-weight:700;color:#fff}
.session-stat-label{color:#888;font-size:0.9em}
.browser-warning{background:rgba(245,158,11,0.1);border:1px solid #f59e0b;border-radius:8px;padding:15px;margin-bottom:20px;color:#f59e0b;font-size:0.9em}

/* Toast Notification */
.toast{position:fixed;bottom:20px;right:20px;background:#1a1a2e;border:1px solid #6366f1;border-radius:10px;padding:15px 25px;color:#fff;font-size:0.95em;z-index:10000;transform:translateY(100px);opacity:0;transition:all 0.3s ease;display:flex;align-items:center;gap:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:#10b981;background:linear-gradient(135deg,#0a1a0a,#1a1a1a)}
.toast.info{border-color:#6366f1;background:linear-gradient(135deg,#1a1a2e,#1a1a1a)}
.toast.warning{border-color:#f59e0b;background:linear-gradient(135deg,#1a1a0a,#1a1a1a)}
.toast-spinner{width:18px;height:18px;border:2px solid #333;border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite}
</style>
</head>
<body>
<div class="container">
<header>
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h1>Claude Resume</h1>
<p class="subtitle">AI-Powered ATS Resume Builder - Tailored for Every Job</p>
</div>
<div id="authSection">
<button onclick="loginWithGoogle()" class="secondary" style="display:flex;align-items:center;gap:10px">
<svg width="18" height="18" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Sign in with Google
</button>
</div>
</div>
<div id="userInfo" style="display:none;text-align:right;margin-top:10px">
<span id="userName" style="color:#888"></span>
<button onclick="logout()" class="secondary" style="margin-left:10px;padding:6px 12px;font-size:0.85em">Logout</button>
</div>
</header>

<div class="tabs">
<div class="tab active" data-tab="dashboard">Dashboard</div>
<div class="tab" data-tab="profile">Profile</div>
<div class="tab" data-tab="experience">Experience</div>
<div class="tab" data-tab="skills">Skills</div>
<div class="tab" data-tab="projects">Projects</div>
<div class="tab" data-tab="generate">Generate</div>
<div class="tab" data-tab="batch">Batch Jobs</div>
<div class="tab" data-tab="library">Library<span class="tab-badge" id="libraryBadge" style="display:none">0</span></div>
<div class="tab" data-tab="questions">Q&A Helper</div>
<div class="tab" data-tab="prospect">Prospect</div>
<div class="tab" data-tab="interview">Interview Prep</div>
</div>

<!-- Dashboard Panel -->
<div class="panel active" id="dashboard">
<h2>Dashboard</h2>

<div class="stats-grid" id="dashboardStats">
<div class="stat-card">
<div class="stat-value" id="statTotal">0</div>
<div class="stat-label">Total Resumes</div>
</div>
<div class="stat-card success">
<div class="stat-value" id="statAvgScore">0%</div>
<div class="stat-label">Avg Match Score</div>
</div>
<div class="stat-card">
<div class="stat-value" id="statApplied">0</div>
<div class="stat-label">Applied</div>
</div>
<div class="stat-card warning">
<div class="stat-value" id="statInterviewing">0</div>
<div class="stat-label">Interviewing</div>
</div>
<div class="stat-card success">
<div class="stat-value" id="statOffered">0</div>
<div class="stat-label">Offers</div>
</div>
</div>

<div class="grid-2">
<div class="card">
<h4>Quick Actions</h4>
<div style="display:grid;gap:10px;margin-top:15px">
<button onclick="switchTab('generate')" style="text-align:left;padding:15px">
<strong>Generate New Resume</strong><br>
<span style="color:#888;font-size:0.9em">Tailor your resume for a specific job</span>
</button>
<button onclick="switchTab('batch')" class="secondary" style="text-align:left;padding:15px">
<strong>Batch Process Jobs</strong><br>
<span style="color:#888;font-size:0.9em">Compare fit across multiple positions</span>
</button>
<button onclick="switchTab('library')" class="secondary" style="text-align:left;padding:15px">
<strong>View Resume Library</strong><br>
<span style="color:#888;font-size:0.9em">Manage saved resumes and track applications</span>
</button>
</div>
</div>

<div class="card">
<h4>Recent Activity</h4>
<div class="activity-list" id="recentActivity">
<div style="color:#666;padding:20px;text-align:center">
<p>No recent activity</p>
<p style="font-size:0.9em;margin-top:10px">Generate your first tailored resume to get started</p>
</div>
</div>
</div>
</div>

<div class="card" style="margin-top:20px">
<h4>Profile Completeness</h4>
<div id="profileCompleteness" style="margin-top:15px">
<div style="display:flex;justify-content:space-between;margin-bottom:8px">
<span>Profile completion</span>
<span id="completenessPercent">0%</span>
</div>
<div style="background:#333;height:8px;border-radius:4px;overflow:hidden">
<div id="completenessBar" style="background:linear-gradient(90deg,#6366f1,#8b5cf6);height:100%;width:0%;transition:width 0.3s"></div>
</div>
<div id="completenessHints" style="margin-top:15px;color:#888;font-size:0.9em"></div>
</div>
</div>
</div>

<!-- Profile Panel -->
<div class="panel" id="profile">

<!-- Import Section -->
<div class="card" style="margin-bottom:30px;background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#8b5cf6;margin-bottom:15px">Import Your Data</h4>

<div class="grid" style="margin-bottom:20px">
<div>
<label style="color:#0077b5;font-weight:600">LinkedIn Data Export</label>
<p style="color:#888;font-size:0.85em;margin:5px 0 10px">
<strong>Important:</strong> You need the <em>full</em> export, not the basic one.<br>
1. LinkedIn â†’ Settings â†’ Data Privacy â†’ Get a copy of your data<br>
2. Select "<strong>Download larger data archive</strong>" (takes 10min-24hrs)<br>
3. Upload the ZIP when you receive the email
</p>
<input type="file" id="linkedinZip" accept=".zip" onchange="parseLinkedInZip(this.files[0])" style="display:none">
<button onclick="document.getElementById('linkedinZip').click()" class="secondary" style="width:100%">
Upload LinkedIn ZIP
</button>
</div>
<div>
<label style="color:#6366f1;font-weight:600">Paste Resume Text</label>
<p style="color:#888;font-size:0.85em;margin:5px 0 10px">Copy/paste from any document</p>
<button onclick="document.getElementById('resumeTextModal').classList.add('active')" class="secondary" style="width:100%">
Paste Resume Text
</button>
</div>
</div>
<div id="importStatus" style="color:#00ff88;font-size:0.9em"></div>

<div style="margin-top:20px;padding-top:20px;border-top:1px solid #333">
<label style="color:#00ff88;font-weight:600">Export for Browser Extension</label>
<p style="color:#888;font-size:0.85em;margin:5px 0 10px">Copy your profile data to use with the AutoFill extension</p>
<button onclick="exportForExtension()" class="secondary" style="width:100%">Copy Profile Data</button>
</div>
</div>

<!-- Resume Text Modal -->
<div class="modal" id="resumeTextModal">
<div class="modal-content">
<div class="modal-header">
<h3>Paste Resume Text</h3>
<button class="modal-close" onclick="document.getElementById('resumeTextModal').classList.remove('active')">&times;</button>
</div>
<textarea id="importResume" rows="12" placeholder="Paste your resume text here..."></textarea>
<div style="margin-top:15px;display:flex;gap:10px">
<button onclick="parseResumeWithAI()">Parse with AI</button>
<span id="parseStatus" style="color:#888;line-height:45px"></span>
</div>
</div>
</div>

<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h2 style="margin:0">Personal Information</h2>
<span id="saveStatus" style="color:#00ff88;font-size:0.9em"></span>
</div>
<div class="grid">
<div class="form-group">
<label>Full Name</label>
<input type="text" id="fullName" placeholder="John Doe">
</div>
<div class="form-group">
<label>Email</label>
<input type="email" id="email" placeholder="john@example.com">
</div>
<div class="form-group">
<label>Phone</label>
<input type="tel" id="phone" placeholder="+1 (555) 123-4567">
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="location" placeholder="New York, NY">
</div>
<div class="form-group">
<label>LinkedIn URL</label>
<input type="url" id="linkedin" placeholder="https://linkedin.com/in/johndoe">
</div>
<div class="form-group">
<label>GitHub URL</label>
<input type="url" id="github" placeholder="https://github.com/johndoe">
</div>
<div class="form-group">
<label>Portfolio/Website</label>
<input type="url" id="portfolio" placeholder="https://johndoe.com">
</div>
</div>
<div class="form-group">
<label>Professional Summary (Master version - will be tailored per job)</label>
<textarea id="summary" placeholder="Experienced software engineer with 5+ years..."></textarea>
</div>
<button onclick="saveProfile()">Save Profile</button>
</div>

<!-- Experience Panel -->
<div class="panel" id="experience">
<h2>Work Experience</h2>
<div id="experienceList"></div>
<div class="add-btn" onclick="openModal('experience')">+ Add Work Experience</div>

<h2 style="margin-top:40px">Education</h2>
<div id="educationList"></div>
<div class="add-btn" onclick="openModal('education')">+ Add Education</div>

<h2 style="margin-top:40px">Certifications</h2>
<div id="certsList"></div>
<div class="add-btn" onclick="openModal('cert')">+ Add Certification</div>
</div>

<!-- Skills Panel -->
<div class="panel" id="skills">
<div class="grid">
<div class="card">
<h4>Technical Skills</h4>
<div id="technicalSkills" class="tags"></div>
<div class="tag-input">
<input type="text" id="techSkillInput" placeholder="e.g., Python, React, AWS">
<button onclick="addSkill('technical')">Add</button>
</div>
</div>
<div class="card">
<h4>Soft Skills</h4>
<div id="softSkills" class="tags"></div>
<div class="tag-input">
<input type="text" id="softSkillInput" placeholder="e.g., Leadership, Communication">
<button onclick="addSkill('soft')">Add</button>
</div>
</div>
<div class="card">
<h4>Tools & Technologies</h4>
<div id="tools" class="tags"></div>
<div class="tag-input">
<input type="text" id="toolInput" placeholder="e.g., Git, Docker, Jira">
<button onclick="addSkill('tools')">Add</button>
</div>
</div>
<div class="card">
<h4>Interests & Hobbies</h4>
<p style="color:#888;font-size:0.9em;margin-bottom:10px">Personal touches that make you memorable</p>
<div id="interests" class="tags"></div>
<div class="tag-input">
<input type="text" id="interestInput" placeholder="e.g., Open source, Rock climbing">
<button onclick="addSkill('interests')">Add</button>
</div>
</div>
</div>
</div>

<!-- Projects Panel -->
<div class="panel" id="projects">
<h2>Projects & Portfolio</h2>
<p style="color:#888;margin-bottom:20px">Add projects that showcase your skills. These will be matched against job requirements and included in your tailored resume and cover letter.</p>

<div id="projectsList"></div>
<div class="add-btn" onclick="openModal('project')">+ Add Project</div>

<div class="card" style="margin-top:30px;background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#8b5cf6;margin-bottom:15px">Import from GitHub</h4>
<p style="color:#888;font-size:0.9em;margin-bottom:15px">Enter your GitHub username to browse and import your public repositories. <span style="color:#f59e0b">Note: These are public repos - anyone can view them on GitHub.</span></p>
<div class="form-group">
<label>GitHub Username or Profile URL</label>
<div style="display:flex;gap:10px">
<input type="text" id="githubUsername" placeholder="username or https://github.com/username" style="flex:1">
<button onclick="fetchGitHubRepos()" class="secondary">Fetch Repos</button>
</div>
</div>
<span id="githubFetchStatus" style="color:#888;font-size:0.9em"></span>
<div id="githubReposList" style="margin-top:15px;max-height:400px;overflow-y:auto"></div>
</div>
</div>

<!-- Project Modal -->
<div class="modal" id="projectModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="projectModalTitle">Add Project</h3>
<button class="modal-close" onclick="closeModal('project')">&times;</button>
</div>
<input type="hidden" id="projectEditIndex" value="-1">
<div class="form-group">
<label>Project Name</label>
<input type="text" id="projectName" placeholder="E-commerce Platform">
</div>
<div class="form-group">
<label>Short Description</label>
<input type="text" id="projectShortDesc" placeholder="Full-stack e-commerce solution with payment processing">
</div>
<div class="form-group">
<label>Technologies Used (comma-separated)</label>
<input type="text" id="projectTech" placeholder="React, Node.js, PostgreSQL, Stripe API">
</div>
<div class="grid-2">
<div class="form-group">
<label>GitHub/Repo URL</label>
<input type="url" id="projectUrl" placeholder="https://github.com/you/project">
</div>
<div class="form-group">
<label>Live Demo URL</label>
<input type="url" id="projectLiveUrl" placeholder="https://yourproject.com">
</div>
</div>
<div class="form-group">
<label>Key Features & Achievements (one per line)</label>
<textarea id="projectFeatures" rows="5" placeholder="Built real-time inventory management system
Integrated Stripe payments processing $50K+ monthly
Achieved 99.9% uptime with automated CI/CD pipeline
Reduced page load time by 60% through optimization"></textarea>
</div>
<div class="form-group">
<label>Why I Built This (context for Q&A)</label>
<textarea id="projectContext" rows="3" placeholder="I built this because I wanted to solve... / I was frustrated with... / I needed a way to..."></textarea>
<span style="font-size:0.8em;color:#888">This helps the Q&A Helper explain your motivation for building this project</span>
</div>
<div class="form-group">
<label>Detailed Description / README (optional - helps AI understand the project)</label>
<textarea id="projectReadme" rows="6" placeholder="Paste README content or detailed project description..."></textarea>
<div style="display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap">
<button type="button" onclick="aiExtractFromReadme()" class="secondary" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
  <span id="aiExtractBtnText">Extract with AI</span>
</button>
<span id="extractStatus" style="font-size:0.85em;color:#888"></span>
</div>
</div>
<div class="form-group" style="display:flex;align-items:center;gap:10px">
<input type="checkbox" id="projectAiAssisted" style="width:auto;margin:0">
<label for="projectAiAssisted" style="margin:0;cursor:pointer">Built with AI assistance (adds badge)</label>
</div>
<button onclick="saveProject()">Save Project</button>
</div>
</div>

<!-- Generate Panel -->
<div class="panel" id="generate">
<h2>Generate Tailored Resume</h2>

<!-- Job URL Import -->
<div class="form-group">
<label>Import from Job URL</label>
<div style="display:flex;gap:10px">
<input type="url" id="jobUrl" placeholder="https://job-boards.greenhouse.io/company/jobs/123..." style="flex:1">
<button onclick="fetchJobFromUrl()" class="secondary" id="fetchJobBtn">Fetch Job</button>
</div>
<small style="color:#888;margin-top:5px;display:block">Supports Greenhouse, Lever, Ashby, and most job boards</small>
</div>

<div style="display:flex;align-items:center;gap:15px;margin:15px 0;color:#666">
<div style="flex:1;height:1px;background:#333"></div>
<span>or paste manually</span>
<div style="flex:1;height:1px;background:#333"></div>
</div>

<div class="form-group">
<label>Job Description</label>
<textarea id="jobDescription" rows="10" placeholder="Paste the full job description here..."></textarea>
</div>
<div class="grid-2">
<div class="form-group">
<label>Company Name (optional)</label>
<input type="text" id="jobCompany" placeholder="e.g., Google">
</div>
<div class="form-group">
<label>Target Role (optional override)</label>
<input type="text" id="targetRole" placeholder="e.g., Senior Software Engineer">
</div>
</div>
<div class="form-group">
<label style="display:flex;justify-content:space-between;align-items:center">
<span>Additional Instructions (optional)</span>
<button type="button" class="secondary small" onclick="saveInstructionPreset()" style="font-size:11px;padding:4px 10px">Save as Preset</button>
</label>
<div id="instructionPresets" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px"></div>
<textarea id="additionalInstructions" rows="3" placeholder="e.g., Emphasize leadership experience, downplay older roles..."></textarea>
<small style="color:#666;margin-top:5px;display:block">Click presets above to add them. Combine multiple for different job types.</small>
</div>
<div class="form-group">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer">
<input type="checkbox" id="generateCoverLetter" style="width:auto">
<span>Also generate a cover letter (uses your experience + relevant projects)</span>
</label>
</div>
<div class="generate-section">
<button class="generate-btn" onclick="generateResume()">Generate ATS-Optimized Resume</button>
</div>
<div class="loading" id="loading">
<div class="spinner"></div>
<p>Analyzing job description and tailoring your resume...</p>
</div>
<div class="output-section" id="output" style="display:none">

<!-- Score Card -->
<div class="score-card">
<div class="score" id="atsScore">--</div>
<div class="score-label">ATS Match Score</div>
<div class="keywords" id="keywordAnalysis"></div>
</div>

<!-- Save to Library Button -->
<div style="text-align:center;margin-bottom:20px">
<button onclick="saveCurrentResume()" class="success" id="saveToLibraryBtn">Save to Library</button>
</div>

<!-- Relevance Rankings -->
<div class="card" style="margin-bottom:20px">
<h4 style="color:#8b5cf6;margin-bottom:15px">Experience Relevance Rankings</h4>
<div id="relevanceRankings" style="white-space:pre-wrap;color:#aaa"></div>
</div>

<!-- Tailored Summary -->
<div class="card" style="margin-bottom:20px">
<h4 style="color:#6366f1;margin-bottom:15px">Tailored Professional Summary</h4>
<div id="tailoredSummary" style="font-style:italic;color:#ddd"></div>
</div>

<!-- Side-by-Side Comparison -->
<div class="card" style="margin-bottom:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#ec4899;margin:0">What Changed</h4>
<button class="secondary small" onclick="toggleComparison()" id="toggleComparisonBtn">Show Details</button>
</div>

<div id="comparisonSummary" style="color:#aaa;margin-bottom:15px">
<!-- Quick stats shown by default -->
</div>

<div id="comparisonDetails" style="display:none">
<!-- Summary Comparison -->
<div style="margin-bottom:25px">
<h5 style="color:#a855f7;margin-bottom:10px;font-size:14px">Professional Summary</h5>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div style="background:#1a1a2e;padding:15px;border-radius:8px;border-left:3px solid #666">
<div style="color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase">Original</div>
<div id="originalSummary" style="color:#aaa;font-size:13px;line-height:1.6"></div>
</div>
<div style="background:#1a2e1a;padding:15px;border-radius:8px;border-left:3px solid #00ff88">
<div style="color:#00ff88;font-size:11px;margin-bottom:8px;text-transform:uppercase">Tailored</div>
<div id="newSummary" style="color:#ddd;font-size:13px;line-height:1.6"></div>
</div>
</div>
</div>

<!-- Experience Comparison -->
<div id="experienceComparison">
<h5 style="color:#a855f7;margin-bottom:10px;font-size:14px">Experience Bullets</h5>
<div id="experienceComparisonList"></div>
</div>
</div>
</div>

<!-- Resume Output -->
<div class="card" style="margin-bottom:20px;position:relative">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#00ff88;margin:0">ATS-Optimized Resume</h4>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="secondary small" onclick="openResumeEditor()" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">Edit</button>
<button class="secondary small" onclick="previewPDF()" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">Preview PDF</button>
<button class="secondary small" onclick="copyResume()">Copy</button>
<button class="secondary small" onclick="downloadPDF()" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Download PDF</button>
<label style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#888;cursor:pointer"><input type="checkbox" id="pdfKeepTogether" checked style="cursor:pointer"> Keep jobs on one page</label>
<button class="secondary small" onclick="exportToGoogleDocs()" id="googleDocsBtn" style="background:linear-gradient(135deg,#4285F4,#1a73e8)">Export to Google Docs</button>
<button class="secondary small" onclick="checkAI('resume')" style="background:linear-gradient(135deg,#f59e0b,#d97706)">ðŸ¤– AI Check</button>
</div>
</div>
<div class="resume-output" id="resumeOutput"></div>
</div>

<!-- Recruiter Assessment -->
<div class="card" style="background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#f59e0b;margin-bottom:15px">Recruiter Assessment</h4>
<div id="recruiterAssessment" style="white-space:pre-wrap;line-height:1.8"></div>
</div>

<!-- Cover Letter Output -->
<div class="card" style="margin-top:20px;display:none" id="coverLetterSection">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#10b981;margin:0">Cover Letter</h4>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="secondary small" onclick="openCoverLetterEditor()" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">Edit</button>
<button class="secondary small" onclick="copyCoverLetter()">Copy</button>
<button class="secondary small" onclick="downloadCoverLetterPDF()" style="background:linear-gradient(135deg,#10b981,#059669)">Download PDF</button>
<button class="secondary small" onclick="checkAI('coverLetter')" style="background:linear-gradient(135deg,#f59e0b,#d97706)">ðŸ¤– AI Check</button>
</div>
</div>
<div id="coverLetterOutput" style="white-space:pre-wrap;line-height:1.8;color:#ddd"></div>
</div>

</div>
</div>

<!-- Batch Processing Panel -->
<div class="panel" id="batch">
<h2>Batch Process Multiple Jobs</h2>
<p style="color:#888;margin-bottom:20px">Compare your fit across multiple positions simultaneously (up to 5 jobs)</p>

<div class="batch-jobs" id="batchJobsList">
<div class="batch-job" data-index="0">
<div class="batch-job-header">
<div class="batch-job-number">1</div>
<button class="remove-job" onclick="removeBatchJob(0)" style="display:none">&times;</button>
</div>
<div class="grid-2">
<div class="form-group">
<label>Company Name</label>
<input type="text" class="batch-company" placeholder="e.g., Google">
</div>
<div class="form-group">
<label>Job Title</label>
<input type="text" class="batch-title" placeholder="e.g., Software Engineer">
</div>
</div>
<div class="form-group">
<label>Job URL (optional)</label>
<input type="url" class="batch-url" placeholder="https://...">
</div>
<div class="form-group">
<label>Job Description</label>
<textarea class="batch-jd" rows="6" placeholder="Paste the job description here..."></textarea>
</div>
</div>
</div>

<button onclick="addBatchJob()" class="secondary" style="width:100%;margin-top:10px" id="addJobBtn">+ Add Another Job</button>

<div class="generate-section" style="margin-top:20px">
<button class="generate-btn" onclick="processBatchJobs()">Process All Jobs</button>
</div>

<div class="loading" id="batchLoading">
<div class="spinner"></div>
<p>Processing all jobs in parallel...</p>
</div>

<div class="batch-results" id="batchResults" style="display:none">
<div class="comparison-card">
<h3 style="color:#fff;margin-bottom:15px">Comparison Summary</h3>
<p id="batchSummary" style="color:#aaa"></p>
<div id="batchRecommendation" style="margin-top:15px;padding:15px;background:#222;border-radius:8px"></div>
</div>

<h3 style="margin-bottom:15px">Rankings (Best Fit First)</h3>
<div class="ranking-list" id="batchRankings"></div>

<h3 style="margin-top:30px;margin-bottom:15px">Detailed Results</h3>
<div id="batchDetailedResults"></div>
</div>
</div>

<!-- Resume Library Panel -->
<div class="panel" id="library">
<h2>Resume Library</h2>

<div class="library-filters">
<select id="libraryStatusFilter" onchange="loadLibrary()">
<option value="all">All Statuses</option>
<option value="generated">Generated</option>
<option value="applied">Applied</option>
<option value="interviewing">Interviewing</option>
<option value="offered">Offered</option>
<option value="rejected">Rejected</option>
<option value="withdrawn">Withdrawn</option>
</select>
<button onclick="loadLibrary()" class="secondary small">Refresh</button>
</div>

<div id="libraryContent">
<div class="resume-list" id="resumeList">
<div style="color:#666;padding:40px;text-align:center">
<p>No saved resumes yet</p>
<p style="font-size:0.9em;margin-top:10px">Generate and save resumes to build your library</p>
</div>
</div>
</div>
</div>

<!-- AI Detection Modal -->
<div class="modal" id="aiCheckModal">
<div class="modal-content" style="max-width:700px">
<div class="modal-header">
<h3>AI Detection Check</h3>
<button class="modal-close" onclick="document.getElementById('aiCheckModal').classList.remove('active')">&times;</button>
</div>
<div id="aiCheckLoading" style="text-align:center;padding:30px;display:none">
<div class="spinner"></div>
<p id="aiCheckLoadingText">Analyzing text for AI patterns...</p>
</div>
<div id="aiCheckResults" style="display:none">

<!-- Score Summary -->
<div id="aiScoreSummary" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:25px">
<div style="text-align:center;padding:20px;background:#1a1a2e;border-radius:10px">
<div style="color:#888;font-size:0.85em;margin-bottom:5px">Resume</div>
<div id="aiResumeScore" style="font-size:3em;font-weight:700">-</div>
<div style="color:#666;font-size:0.8em">/10</div>
</div>
<div id="aiCoverLetterBox" style="text-align:center;padding:20px;background:#1a1a2e;border-radius:10px">
<div style="color:#888;font-size:0.85em;margin-bottom:5px">Cover Letter</div>
<div id="aiCoverLetterScore" style="font-size:3em;font-weight:700">-</div>
<div style="color:#666;font-size:0.8em">/10</div>
</div>
</div>

<div id="aiCheckVerdict" style="text-align:center;margin-bottom:20px;color:#aaa;font-style:italic"></div>

<!-- Tabs for Resume/Cover Letter details -->
<div style="display:flex;gap:10px;margin-bottom:15px">
<button id="aiTabResume" onclick="showAITab('resume')" class="secondary small" style="flex:1">Resume Details</button>
<button id="aiTabCover" onclick="showAITab('cover')" class="secondary small" style="flex:1">Cover Letter Details</button>
</div>

<div id="aiResumeDetails">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
<div style="background:#1a0a0a;border:1px solid #ef4444;border-radius:8px;padding:12px">
<h4 style="color:#ef4444;margin-bottom:8px;font-size:0.9em">ðŸš© Red Flags</h4>
<ul id="aiCheckRedFlags" style="list-style:none;color:#fca5a5;font-size:0.85em"></ul>
</div>
<div style="background:#0a1a0a;border:1px solid #10b981;border-radius:8px;padding:12px">
<h4 style="color:#10b981;margin-bottom:8px;font-size:0.9em">âœ“ Human Elements</h4>
<ul id="aiCheckHuman" style="list-style:none;color:#6ee7b7;font-size:0.85em"></ul>
</div>
</div>
<div style="background:#1a1a2e;border:1px solid #6366f1;border-radius:8px;padding:12px">
<h4 style="color:#a5b4fc;margin-bottom:8px;font-size:0.9em">ðŸ’¡ Suggestions</h4>
<ul id="aiCheckSuggestions" style="list-style:none;color:#c4b5fd;font-size:0.85em"></ul>
</div>
</div>

<div id="aiCoverDetails" style="display:none">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px">
<div style="background:#1a0a0a;border:1px solid #ef4444;border-radius:8px;padding:12px">
<h4 style="color:#ef4444;margin-bottom:8px;font-size:0.9em">ðŸš© Red Flags</h4>
<ul id="aiCheckRedFlagsCover" style="list-style:none;color:#fca5a5;font-size:0.85em"></ul>
</div>
<div style="background:#0a1a0a;border:1px solid #10b981;border-radius:8px;padding:12px">
<h4 style="color:#10b981;margin-bottom:8px;font-size:0.9em">âœ“ Human Elements</h4>
<ul id="aiCheckHumanCover" style="list-style:none;color:#6ee7b7;font-size:0.85em"></ul>
</div>
</div>
<div style="background:#1a1a2e;border:1px solid #6366f1;border-radius:8px;padding:12px">
<h4 style="color:#a5b4fc;margin-bottom:8px;font-size:0.9em">ðŸ’¡ Suggestions</h4>
<ul id="aiCheckSuggestionsCover" style="list-style:none;color:#c4b5fd;font-size:0.85em"></ul>
</div>
</div>

<div style="margin-top:20px;text-align:center">
<button onclick="saveAIScores()" class="success small">Save Scores to Library</button>
</div>
</div>
</div>
</div>

<!-- Resume Detail Modal -->
<div class="modal" id="resumeDetailModal">
<div class="modal-content" style="max-width:900px">
<div class="modal-header">
<h3 id="resumeDetailTitle">Resume Details</h3>
<button class="modal-close" onclick="closeResumeDetail()">&times;</button>
</div>
<div id="resumeDetailContent"></div>
</div>
</div>

<!-- Questions Helper Panel -->
<div class="panel" id="questions">
<h2>Application Q&A Helper</h2>
<p style="color:#888;margin-bottom:20px">Generate tailored answers to common application questions using your experience data.</p>

<div class="form-group">
<label>Common Questions (click to use)</label>
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px">
<button class="secondary small" onclick="setQuestion('Why do you want to work at [Company]?')">Why this company?</button>
<button class="secondary small" onclick="setQuestion('Tell me about a time you solved a difficult technical problem.')">Problem solving</button>
<button class="secondary small" onclick="setQuestion('Describe a situation where you demonstrated leadership.')">Leadership</button>
<button class="secondary small" onclick="setQuestion('Tell me about a time you had to work under pressure or meet a tight deadline.')">Working under pressure</button>
<button class="secondary small" onclick="setQuestion('Describe a time you had a conflict with a coworker and how you resolved it.')">Conflict resolution</button>
<button class="secondary small" onclick="setQuestion('What is your greatest professional achievement?')">Greatest achievement</button>
<button class="secondary small" onclick="setQuestion('Tell me about a time you failed and what you learned from it.')">Learning from failure</button>
<button class="secondary small" onclick="setQuestion('Why are you leaving your current job?')">Why leaving?</button>
<button class="secondary small" onclick="setQuestion('Where do you see yourself in 5 years?')">5 year plan</button>
<button class="secondary small" onclick="setQuestion('What makes you a good fit for this role?')">Good fit</button>
</div>
</div>

<div class="form-group">
<label style="display:flex;justify-content:space-between;align-items:center">
<span>Your Saved Questions</span>
<button type="button" class="secondary small" onclick="saveQuestionPreset()" style="font-size:11px;padding:4px 10px">Save Current as Preset</button>
</label>
<div id="questionPresets" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px"></div>
</div>

<div class="form-group">
<label>Your Question</label>
<textarea id="applicationQuestion" rows="3" placeholder="Type or select a question above..."></textarea>
</div>

<div class="form-group">
<label>Job Description / Company Info (optional - for context)</label>
<textarea id="questionContext" rows="4" placeholder="Paste the job description or company info to get more tailored answers..."></textarea>
</div>

<div class="form-group">
<label>Answer Length</label>
<select id="answerLength">
<option value="short">Short (2-3 sentences)</option>
<option value="medium" selected>Medium (1 paragraph)</option>
<option value="long">Long (2-3 paragraphs / STAR format)</option>
</select>
</div>

<button class="generate-btn" onclick="generateAnswer()" id="generateAnswerBtn">Generate Answer</button>

<div class="loading" id="answerLoading">
<div class="spinner"></div>
<p>Crafting your answer based on your experience...</p>
</div>

<div id="answerOutput" style="display:none;margin-top:20px">
<div class="card">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="color:#00ff88;margin:0">Generated Answer</h4>
<div style="display:flex;gap:8px">
<button class="secondary small" onclick="copyAnswer()">Copy</button>
<button class="secondary small" onclick="checkAI('answer')" style="background:linear-gradient(135deg,#f59e0b,#d97706)">ðŸ¤– AI Check</button>
</div>
</div>
<div id="answerText" style="white-space:pre-wrap;line-height:1.8;color:#ddd"></div>
</div>

<div class="card" style="margin-top:15px;background:linear-gradient(135deg,#1a1a2e,#16213e)">
<h4 style="color:#f59e0b;margin-bottom:10px">Tips for Delivery</h4>
<div id="answerTips" style="color:#aaa;line-height:1.8"></div>
</div>
</div>
</div>
</div>

<!-- Prospect Panel -->
<div class="panel" id="prospect">
<div id="prospect-root"></div>
</div>

<!-- Interview Prep Panel -->
<div class="panel" id="interview">
<h2>AI Interview Practice</h2>
<p style="color:#888;margin-bottom:20px">Practice answering interview questions with AI feedback. The AI interviewer will speak questions aloud, and you can respond verbally or by typing.</p>

<div id="browserWarning" class="browser-warning" style="display:none">
  <strong>Note:</strong> Voice recording requires Chrome, Edge, or Brave. You can still practice by typing your answers.
</div>

<!-- Setup Section -->
<div id="interviewSetup" class="interview-setup">
  <div class="form-group">
    <label>Job Description or Interview Context</label>
    <textarea id="interviewJobContext" rows="8" placeholder="Paste the job description here, or describe the role you're interviewing for..."></textarea>
  </div>

  <div class="form-group">
    <label>Number of Questions</label>
    <select id="interviewQuestionCount">
      <option value="3">3 questions (quick practice)</option>
      <option value="5" selected>5 questions (standard)</option>
      <option value="10">10 questions (thorough)</option>
    </select>
  </div>

  <div style="text-align:center;margin-top:30px">
    <button class="generate-btn" onclick="startInterviewSession()">Start Practice Session</button>
  </div>
</div>

<!-- Active Interview Section -->
<div id="interviewActive" class="interview-active">
  <!-- Question Display -->
  <div class="question-card" id="questionCard">
    <div class="question-number" id="questionNumber">Question 1 of 5</div>
    <div class="question-text" id="questionText">Loading question...</div>
    <div>
      <span class="question-type" id="questionType">behavioral</span>
      <span class="question-time" id="questionTime">Suggested: 1-2 minutes</span>
    </div>
    <div id="questionTip" style="margin-top:15px;color:#a5b4fc;font-size:0.9em;font-style:italic"></div>
  </div>

  <!-- Controls -->
  <div class="interview-controls">
    <button class="speak-btn" id="speakBtn" onclick="speakQuestion()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
      <span id="speakBtnText">Hear Question</span>
    </button>
    <button class="record-btn" id="recordBtn" onclick="toggleRecording()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
      <span id="recordBtnText">Record Answer</span>
    </button>
  </div>

  <!-- Transcript Area -->
  <div class="form-group">
    <label style="display:flex;justify-content:space-between;align-items:center">
      <span>Your Answer</span>
      <span id="recordingStatus" style="color:#ef4444;font-size:0.85em"></span>
    </label>
    <div id="transcriptArea" class="transcript-area empty">
      Click "Record Answer" to speak, or type your response below...
    </div>
    <textarea id="answerInput" rows="4" placeholder="Or type your answer here..." style="margin-top:10px"></textarea>
  </div>

  <!-- Submit Button -->
  <div style="display:flex;gap:15px;flex-wrap:wrap">
    <button onclick="submitAnswer()" id="submitAnswerBtn">Submit Answer for Feedback</button>
    <button onclick="getAnswerHint()" class="secondary" id="hintBtn" style="background:linear-gradient(135deg,#f59e0b,#d97706)">ðŸ’¡ Get Hint</button>
    <button onclick="skipQuestion()" class="secondary">Skip Question</button>
  </div>

  <!-- Hint Display -->
  <div id="hintCard" style="display:none;margin-top:15px;padding:20px;background:linear-gradient(135deg,#1a1a0a,#1a1a1a);border:1px solid #f59e0b;border-radius:10px">
    <div style="color:#f59e0b;font-weight:600;margin-bottom:10px">ðŸ’¡ Talking Points from Your Experience:</div>
    <div id="hintContent" style="color:#ddd;line-height:1.7"></div>
  </div>

  <!-- Loading -->
  <div class="loading" id="feedbackLoading">
    <div class="spinner"></div>
    <p>Evaluating your answer...</p>
  </div>

  <!-- Feedback Display -->
  <div id="feedbackCard" class="feedback-card" style="display:none">
    <div class="feedback-score" id="feedbackScore">--</div>
    <div id="feedbackOverall" style="text-align:center;color:#aaa;margin-bottom:25px"></div>

    <div class="feedback-section">
      <h4><span class="strength-icon">âœ“</span> Strengths</h4>
      <ul id="feedbackStrengths"></ul>
    </div>

    <div class="feedback-section">
      <h4><span class="improve-icon">â–³</span> Areas to Improve</h4>
      <ul id="feedbackImprovements"></ul>
    </div>

    <div id="feedbackExample" style="display:none;margin-top:20px;padding:15px;background:#1a1a2e;border-radius:8px">
      <div style="color:#8b5cf6;font-size:0.9em;margin-bottom:8px">Suggestion:</div>
      <div id="feedbackExampleText" style="color:#ddd;font-style:italic"></div>
    </div>

    <div style="display:flex;gap:15px;margin-top:25px;flex-wrap:wrap">
      <button onclick="nextQuestion()" class="success" id="nextQuestionBtn">Next Question</button>
      <button onclick="endSession()" class="secondary">End Session</button>
    </div>
  </div>
</div>

<!-- Session Summary -->
<div id="sessionSummary" class="session-summary" style="display:none">
  <h3>Practice Session Complete!</h3>
  <div class="session-stats">
    <div class="session-stat">
      <div class="session-stat-value" id="summaryQuestions">0</div>
      <div class="session-stat-label">Questions Answered</div>
    </div>
    <div class="session-stat">
      <div class="session-stat-value" id="summaryAvgScore">0%</div>
      <div class="session-stat-label">Average Score</div>
    </div>
  </div>
  <div id="summaryFeedback" style="color:#aaa;margin-bottom:25px;text-align:left;max-width:500px;margin-left:auto;margin-right:auto"></div>
  <button onclick="resetInterview()" class="generate-btn">Start New Session</button>
</div>
</div>

<!-- Experience Modal -->
<div class="modal" id="experienceModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="expModalTitle">Add Work Experience</h3>
<button class="modal-close" onclick="closeModal('experience')">&times;</button>
</div>
<input type="hidden" id="expEditIndex" value="-1">
<div class="form-group">
<label>Job Title</label>
<input type="text" id="expTitle" placeholder="Software Engineer">
</div>
<div class="form-group">
<label>Company</label>
<input type="text" id="expCompany" placeholder="Google">
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="expLocation" placeholder="Mountain View, CA">
</div>
<div class="grid">
<div class="form-group">
<label>Start Date</label>
<input type="month" id="expStart">
</div>
<div class="form-group">
<label>End Date</label>
<input type="month" id="expEnd">
<label style="display:flex;align-items:center;gap:6px;margin-top:6px;cursor:pointer;font-size:0.9em">
<input type="checkbox" id="expPresent" onchange="document.getElementById('expEnd').disabled = this.checked; if(this.checked) document.getElementById('expEnd').value = '';">
Currently working here
</label>
</div>
</div>
<div class="form-group">
<label>Bullet Points (one per line - rough notes OK, AI will enhance)</label>
<textarea id="expBullets" rows="6" placeholder="managed team of developers
built new features for the app
helped reduce bugs and improve performance
worked with clients on requirements"></textarea>
<div style="display:flex;gap:20px;margin-top:8px;margin-bottom:8px;flex-wrap:wrap">
  <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;color:#a5b4fc;font-size:0.9em">
    <input type="radio" name="enhanceMode" value="cleanup" style="margin-top:3px">
    <span><strong>Clean Up</strong><br><span style="color:#888;font-size:0.85em">Fix grammar, keep structure</span></span>
  </label>
  <label style="display:flex;align-items:flex-start;gap:8px;cursor:pointer;color:#a5b4fc;font-size:0.9em">
    <input type="radio" name="enhanceMode" value="supercharge" checked style="margin-top:3px">
    <span><strong>Supercharge</strong><br><span style="color:#888;font-size:0.85em">Rewrite for impact, can add metrics</span></span>
  </label>
</div>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
<button type="button" onclick="enhanceExpBullets()" class="secondary" style="background:linear-gradient(135deg,#8b5cf6,#6366f1)">
  <span id="enhanceBtnText">Enhance with AI</span>
</button>
<span id="enhanceStatus" style="font-size:0.85em;color:#888"></span>
</div>
<div id="enhancePreview" style="display:none;margin-top:15px;background:#1a1a2e;border-radius:8px;padding:15px;border:1px solid #8b5cf633">
<div style="color:#8b5cf6;font-weight:500;margin-bottom:10px">Enhanced Preview:</div>
<div id="enhancePreviewContent" style="color:#a5b4fc;font-size:0.9em;line-height:1.6"></div>
<div style="display:flex;gap:10px;margin-top:15px">
<button type="button" onclick="applyEnhanced()" style="background:#10b981">Apply Changes</button>
<button type="button" onclick="cancelEnhanced()" class="secondary">Keep Original</button>
</div>
</div>
</div>
<button onclick="saveExperience()">Save Experience</button>
</div>
</div>

<!-- Education Modal -->
<div class="modal" id="educationModal">
<div class="modal-content">
<div class="modal-header">
<h3 id="eduModalTitle">Add Education</h3>
<button class="modal-close" onclick="closeModal('education')">&times;</button>
</div>
<input type="hidden" id="eduEditIndex" value="-1">
<div class="form-group">
<label>Degree</label>
<input type="text" id="eduDegree" placeholder="Bachelor of Science in Computer Science">
</div>
<div class="form-group">
<label>Institution</label>
<input type="text" id="eduSchool" placeholder="University of California, Berkeley">
</div>
<div class="form-group">
<label>Location</label>
<input type="text" id="eduLocation" placeholder="Berkeley, CA">
</div>
<div class="grid">
<div class="form-group">
<label>Start Date</label>
<input type="text" id="eduStart" placeholder="2020 or May 2020">
</div>
<div class="form-group">
<label>End Date</label>
<input type="text" id="eduEnd" placeholder="2024 or May 2024">
<label style="display:flex;align-items:center;gap:6px;margin-top:6px;cursor:pointer;font-size:0.9em">
<input type="checkbox" id="eduPresent" onchange="document.getElementById('eduEnd').disabled = this.checked; if(this.checked) document.getElementById('eduEnd').value = '';">
Currently enrolled
</label>
</div>
</div>
<div class="form-group">
<label>GPA (optional)</label>
<input type="text" id="eduGPA" placeholder="3.8/4.0">
</div>
<div class="form-group">
<label>Relevant Coursework / Honors (optional)</label>
<textarea id="eduExtras" rows="3" placeholder="Dean's List, Data Structures, Machine Learning..."></textarea>
</div>
<button onclick="saveEducation()">Save Education</button>
</div>
</div>

<!-- Certification Modal -->
<div class="modal" id="certModal">
<div class="modal-content">
<div class="modal-header">
<h3>Add Certification</h3>
<button class="modal-close" onclick="closeModal('cert')">&times;</button>
</div>
<div class="form-group">
<label>Certification Name</label>
<input type="text" id="certName" placeholder="AWS Solutions Architect">
</div>
<div class="form-group">
<label>Issuing Organization</label>
<input type="text" id="certOrg" placeholder="Amazon Web Services">
</div>
<div class="form-group">
<label>Date Obtained</label>
<input type="month" id="certDate">
</div>
<div class="form-group">
<label>Credential ID (optional)</label>
<input type="text" id="certId" placeholder="ABC123XYZ">
</div>
<button onclick="saveCert()">Save Certification</button>
</div>
</div>

<!-- PDF Preview Modal -->
<div class="modal" id="pdfPreviewModal">
<div class="modal-content" style="max-width:900px;max-height:95vh;overflow-y:auto;padding:0">
<div class="modal-header" style="padding:15px 20px;background:#1a1a2e;position:sticky;top:0;z-index:10">
<h3>PDF Preview</h3>
<div style="display:flex;gap:10px;align-items:center">
<button onclick="downloadPDF()" class="secondary small" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Download PDF</button>
<button class="modal-close" onclick="closePDFPreview()">&times;</button>
</div>
</div>
<div id="pdfPreviewContent" style="background:#fff;padding:0.5in;min-height:11in"></div>
</div>
</div>

<!-- Cover Letter Editor Modal -->
<div class="modal" id="coverLetterEditorModal">
<div class="modal-content" style="max-width:800px;max-height:90vh;overflow-y:auto">
<div class="modal-header">
<h3>Edit Cover Letter</h3>
<button class="modal-close" onclick="closeCoverLetterEditor()">&times;</button>
</div>

<div style="margin-bottom:20px;padding:15px;background:#1a1a2e;border-radius:8px;border-left:4px solid #10b981">
<p style="margin:0;color:#6ee7b7;font-size:0.9em">Edit the cover letter below. Your changes will be used when you download the PDF.</p>
</div>

<div class="form-group">
<label style="color:#10b981">Cover Letter Body</label>
<textarea id="editCoverLetter" rows="15" style="font-size:0.95em;line-height:1.6"></textarea>
</div>

<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
<button onclick="saveCoverLetterEdits()" style="background:linear-gradient(135deg,#10b981,#059669)">Save & Update</button>
<button onclick="closeCoverLetterEditor()" class="secondary">Cancel</button>
<button onclick="downloadCoverLetterPDFFromEditor()" class="secondary" style="background:linear-gradient(135deg,#10b981,#059669)">Save & Download PDF</button>
</div>
</div>
</div>

<!-- Resume Editor Modal -->
<div class="modal" id="resumeEditorModal">
<div class="modal-content" style="max-width:900px;max-height:90vh;overflow-y:auto">
<div class="modal-header">
<h3>Edit Resume Before Export</h3>
<button class="modal-close" onclick="closeResumeEditor()">&times;</button>
</div>

<div style="margin-bottom:20px;padding:15px;background:#1a1a2e;border-radius:8px;border-left:4px solid #8b5cf6">
<p style="margin:0;color:#a5b4fc;font-size:0.9em">Edit the content below, then click "Save & Update" to apply changes. Your edits will be used when you download the PDF.</p>
</div>

<!-- Summary Section -->
<div class="form-group">
<label style="color:#00ff88">Professional Summary</label>
<textarea id="editSummary" rows="4" style="font-size:0.95em"></textarea>
</div>

<!-- Experience Sections -->
<div id="editExperienceContainer">
<label style="color:#00ff88;display:block;margin-bottom:10px">Experience</label>
<div id="editExperienceList"></div>
</div>

<!-- Skills Section -->
<div class="form-group" style="margin-top:20px">
<label style="color:#00ff88">Skills (comma separated)</label>
<input type="text" id="editSkills" placeholder="Python, JavaScript, AWS, etc.">
</div>

<!-- Projects Section -->
<div id="editProjectsContainer" style="margin-top:20px">
<label style="color:#00ff88;display:block;margin-bottom:10px">Projects</label>
<div id="editProjectsList"></div>
</div>

<!-- Action Buttons -->
<div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap">
<button onclick="saveResumeEdits()" style="background:linear-gradient(135deg,#10b981,#059669)">Save & Update</button>
<button onclick="closeResumeEditor()" class="secondary">Cancel</button>
<button onclick="downloadPDFFromEditor()" class="secondary" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Save & Download PDF</button>
</div>
</div>
</div>

<script>
// State
const state = {
  profile: JSON.parse(localStorage.getItem('resumeProfile') || '{}'),
  experience: JSON.parse(localStorage.getItem('resumeExperience') || '[]'),
  education: JSON.parse(localStorage.getItem('resumeEducation') || '[]'),
  certs: JSON.parse(localStorage.getItem('resumeCerts') || '[]'),
  skills: JSON.parse(localStorage.getItem('resumeSkills') || '{"technical":[],"soft":[],"tools":[],"interests":[]}'),
  projects: JSON.parse(localStorage.getItem('resumeProjects') || '[]'),
  instructionPresets: JSON.parse(localStorage.getItem('instructionPresets') || '[]'),
  questionPresets: JSON.parse(localStorage.getItem('questionPresets') || '[]'),
  featurePresets: JSON.parse(localStorage.getItem('featurePresets') || '{}'),
  lastGenerated: null,
  libraryStats: null
};

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    switchTab(tab.dataset.tab);
  });
});

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
  document.getElementById(tabName).classList.add('active');

  // Load data for specific tabs
  if (tabName === 'dashboard') {
    updateDashboard();
  } else if (tabName === 'library') {
    loadLibrary();
  }
}

// Dashboard functions
async function updateDashboard() {
  updateProfileCompleteness();

  if (!currentUser) {
    document.getElementById('statTotal').textContent = '0';
    document.getElementById('statAvgScore').textContent = '0%';
    document.getElementById('statApplied').textContent = '0';
    document.getElementById('statInterviewing').textContent = '0';
    document.getElementById('statOffered').textContent = '0';
    return;
  }

  try {
    const res = await fetch('/api/resumes/list?email=' + encodeURIComponent(currentUser.email));
    if (res.ok) {
      const data = await res.json();
      state.libraryStats = data.stats;

      document.getElementById('statTotal').textContent = data.stats.total || 0;
      document.getElementById('statAvgScore').textContent = (data.stats.avgScore || 0) + '%';
      document.getElementById('statApplied').textContent = data.stats.applied || 0;
      document.getElementById('statInterviewing').textContent = data.stats.interviewing || 0;
      document.getElementById('statOffered').textContent = data.stats.offered || 0;

      // Update library badge
      const badge = document.getElementById('libraryBadge');
      if (data.stats.total > 0) {
        badge.textContent = data.stats.total;
        badge.style.display = 'inline';
      } else {
        badge.style.display = 'none';
      }

      // Update recent activity
      updateRecentActivity(data.resumes.slice(0, 5));
    }
  } catch (e) {
    console.error('Failed to load stats:', e);
  }
}

function updateRecentActivity(resumes) {
  const container = document.getElementById('recentActivity');

  if (!resumes || resumes.length === 0) {
    container.innerHTML = `
      <div style="color:#666;padding:20px;text-align:center">
        <p>No recent activity</p>
        <p style="font-size:0.9em;margin-top:10px">Generate your first tailored resume to get started</p>
      </div>
    `;
    return;
  }

  container.innerHTML = resumes.map(r => `
    <div class="activity-item">
      <div class="activity-icon">${getStatusIcon(r.status)}</div>
      <div class="activity-content">
        <div class="activity-title">${r.company} - ${r.title}</div>
        <div class="activity-meta">
          <span class="status-badge ${r.status}">${r.status}</span>
          <span style="margin-left:10px">${formatDate(r.updatedAt || r.createdAt)}</span>
          <span style="margin-left:10px;color:${r.score >= 70 ? '#10b981' : r.score >= 50 ? '#f59e0b' : '#ef4444'}">${r.score}% match</span>
        </div>
      </div>
    </div>
  `).join('');
}

function getStatusIcon(status) {
  const icons = {
    generated: 'ðŸ“„',
    applied: 'ðŸ“¤',
    interviewing: 'ðŸŽ¤',
    offered: 'ðŸŽ‰',
    rejected: 'âŒ',
    withdrawn: 'â†©ï¸'
  };
  return icons[status] || 'ðŸ“„';
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);

  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return date.toLocaleDateString();
}

function formatExpDate(dateStr) {
  if (!dateStr || dateStr === 'Present') return dateStr || '';
  const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  // Handle YYYY-MM format from month input
  const ym = dateStr.match(/^(\d{4})-(\d{2})$/);
  if (ym) return `${months[parseInt(ym[2], 10) - 1]} ${ym[1]}`;
  // Handle already formatted dates (e.g. "March 2022", "Mar 2022", "03/2022")
  return dateStr;
}

function formatExpDateRange(start, end) {
  return `${formatExpDate(start)} - ${formatExpDate(end) || 'Present'}`;
}

function updateProfileCompleteness() {
  const checks = [
    { name: 'Full Name', value: state.profile.fullName },
    { name: 'Email', value: state.profile.email },
    { name: 'Phone', value: state.profile.phone },
    { name: 'Location', value: state.profile.location },
    { name: 'Summary', value: state.profile.summary },
    { name: 'Work Experience', value: state.experience.length > 0 },
    { name: 'Education', value: state.education.length > 0 },
    { name: 'Technical Skills', value: state.skills.technical?.length > 0 }
  ];

  const completed = checks.filter(c => c.value).length;
  const percent = Math.round((completed / checks.length) * 100);

  document.getElementById('completenessPercent').textContent = percent + '%';
  document.getElementById('completenessBar').style.width = percent + '%';

  const missing = checks.filter(c => !c.value).map(c => c.name);
  if (missing.length > 0) {
    document.getElementById('completenessHints').innerHTML = `
      <strong>Missing:</strong> ${missing.join(', ')}
    `;
  } else {
    document.getElementById('completenessHints').innerHTML = `
      <span style="color:#10b981">Profile complete! You're ready to generate tailored resumes.</span>
    `;
  }
}

// Load saved data into forms
function loadProfile() {
  if (state.profile.fullName) document.getElementById('fullName').value = state.profile.fullName;
  if (state.profile.email) document.getElementById('email').value = state.profile.email;
  if (state.profile.phone) document.getElementById('phone').value = state.profile.phone;
  if (state.profile.location) document.getElementById('location').value = state.profile.location;
  if (state.profile.linkedin) document.getElementById('linkedin').value = state.profile.linkedin;
  if (state.profile.github) document.getElementById('github').value = state.profile.github;
  if (state.profile.portfolio) document.getElementById('portfolio').value = state.profile.portfolio;
  if (state.profile.summary) document.getElementById('summary').value = state.profile.summary;
}

function saveProfile() {
  state.profile = {
    fullName: document.getElementById('fullName').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    location: document.getElementById('location').value,
    linkedin: document.getElementById('linkedin').value,
    github: document.getElementById('github').value,
    portfolio: document.getElementById('portfolio').value,
    summary: document.getElementById('summary').value
  };
  localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
  saveUserData();
  alert('Profile saved!');
}

// Modal functions
function openModal(type) {
  if (type === 'experience') {
    document.getElementById('expModalTitle').textContent = 'Add Work Experience';
    document.getElementById('expEditIndex').value = '-1';
    document.getElementById('expPresent').checked = false;
    document.getElementById('expEnd').disabled = false;
  }
  if (type === 'education') {
    document.getElementById('eduModalTitle').textContent = 'Add Education';
    document.getElementById('eduEditIndex').value = '-1';
    document.getElementById('eduPresent').checked = false;
    document.getElementById('eduEnd').disabled = false;
  }
  document.getElementById(type + 'Modal').classList.add('active');
}

function closeModal(type) {
  document.getElementById(type + 'Modal').classList.remove('active');
  // Clear form
  if (type === 'experience') {
    ['expTitle', 'expCompany', 'expLocation', 'expStart', 'expEnd', 'expBullets'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('expEditIndex').value = '-1';
    document.getElementById('expPresent').checked = false;
    document.getElementById('expEnd').disabled = false;
  }
  if (type === 'education') {
    ['eduDegree', 'eduSchool', 'eduLocation', 'eduStart', 'eduEnd', 'eduGPA', 'eduExtras'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('eduEditIndex').value = '-1';
    document.getElementById('eduPresent').checked = false;
    document.getElementById('eduEnd').disabled = false;
  }
}

// Experience functions
function renderExperience() {
  const list = document.getElementById('experienceList');
  list.innerHTML = state.experience.map((exp, i) => `
    <div class="item">
      <div class="item-header">
        <div>
          <div class="item-title">${exp.title} at ${exp.company}</div>
          <div class="item-subtitle">${exp.location} | ${formatExpDateRange(exp.start, exp.end)}</div>
        </div>
        <div class="item-actions">
          <button class="secondary" onclick="editExperience(${i})">Edit</button>
          <button class="danger" onclick="deleteExperience(${i})">Delete</button>
        </div>
      </div>
      <div class="bullets">
        ${exp.bullets.map(b => `<div class="bullet"><span class="bullet-dot">â€¢</span><span>${b}</span></div>`).join('')}
      </div>
    </div>
  `).join('');
}

function editExperience(i) {
  const exp = state.experience[i];
  document.getElementById('expModalTitle').textContent = 'Edit Work Experience';
  document.getElementById('expEditIndex').value = i;
  document.getElementById('expTitle').value = exp.title;
  document.getElementById('expCompany').value = exp.company;
  document.getElementById('expLocation').value = exp.location || '';
  document.getElementById('expStart').value = exp.start;
  const isPresent = !exp.end || exp.end === 'Present';
  document.getElementById('expPresent').checked = isPresent;
  document.getElementById('expEnd').disabled = isPresent;
  document.getElementById('expEnd').value = isPresent ? '' : exp.end;
  document.getElementById('expBullets').value = exp.bullets.join('\n');
  openModal('experience');
}

let pendingEnhancedBullets = null;

async function enhanceExpBullets() {
  const bullets = document.getElementById('expBullets').value;
  const title = document.getElementById('expTitle').value;
  const company = document.getElementById('expCompany').value;
  const status = document.getElementById('enhanceStatus');
  const btn = document.getElementById('enhanceBtnText');
  const preview = document.getElementById('enhancePreview');

  if (!bullets.trim()) {
    status.textContent = 'Add some bullet points first';
    status.style.color = '#ef4444';
    return;
  }

  btn.textContent = 'Enhancing...';
  status.textContent = '';
  preview.style.display = 'none';

  try {
    const enhanceMode = document.querySelector('input[name="enhanceMode"]:checked').value;
    const response = await fetch('/api/parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'enhance', bullets, title, company, enhanceMode })
    });

    const text = await response.text();
    if (!text) {
      throw new Error('Server returned empty response. Try again.');
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch (parseErr) {
      throw new Error('Invalid response from server: ' + text.substring(0, 100));
    }

    if (!response.ok) {
      throw new Error(data.error || 'Enhancement failed');
    }

    pendingEnhancedBullets = data.bullets;
    document.getElementById('enhancePreviewContent').innerHTML = data.bullets.map(b => `â€¢ ${b}`).join('<br>');
    preview.style.display = 'block';
    status.textContent = 'Review the enhanced version below';
    status.style.color = '#8b5cf6';

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  } finally {
    btn.textContent = 'Enhance with AI';
  }
}

function applyEnhanced() {
  if (pendingEnhancedBullets) {
    document.getElementById('expBullets').value = pendingEnhancedBullets.join('\n');
    document.getElementById('enhanceStatus').textContent = 'Applied!';
    document.getElementById('enhanceStatus').style.color = '#10b981';
  }
  document.getElementById('enhancePreview').style.display = 'none';
  pendingEnhancedBullets = null;
}

function cancelEnhanced() {
  document.getElementById('enhancePreview').style.display = 'none';
  document.getElementById('enhanceStatus').textContent = 'Kept original';
  document.getElementById('enhanceStatus').style.color = '#888';
  pendingEnhancedBullets = null;
}

function saveExperience() {
  const isPresent = document.getElementById('expPresent').checked;
  const exp = {
    title: document.getElementById('expTitle').value,
    company: document.getElementById('expCompany').value,
    location: document.getElementById('expLocation').value,
    start: document.getElementById('expStart').value,
    end: isPresent ? 'Present' : document.getElementById('expEnd').value,
    bullets: document.getElementById('expBullets').value.split('\n').filter(b => b.trim())
  };

  const editIndex = parseInt(document.getElementById('expEditIndex').value);
  if (editIndex >= 0) {
    state.experience[editIndex] = exp;
  } else {
    state.experience.push(exp);
  }

  localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
  closeModal('experience');
  renderExperience();
  saveUserData();
}

function deleteExperience(i) {
  if (confirm('Delete this experience?')) {
    state.experience.splice(i, 1);
    localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
    renderExperience();
    saveUserData();
  }
}

// Education functions
function renderEducation() {
  const list = document.getElementById('educationList');
  list.innerHTML = state.education.map((edu, i) => `
    <div class="item">
      <div class="item-header">
        <div>
          <div class="item-title">${edu.degree}</div>
          <div class="item-subtitle">${edu.school} | ${formatExpDate(edu.start)} - ${formatExpDate(edu.end)}${edu.gpa ? ' | GPA: ' + edu.gpa : ''}</div>
        </div>
        <div class="item-actions">
          <button class="secondary" onclick="editEducation(${i})">Edit</button>
          <button class="danger" onclick="deleteEducation(${i})">Delete</button>
        </div>
      </div>
      ${edu.extras ? `<div style="color:#888;margin-top:10px">${edu.extras}</div>` : ''}
    </div>
  `).join('');
}

function editEducation(i) {
  const edu = state.education[i];
  openModal('education');
  document.getElementById('eduModalTitle').textContent = 'Edit Education';
  document.getElementById('eduEditIndex').value = i;
  document.getElementById('eduDegree').value = edu.degree || '';
  document.getElementById('eduSchool').value = edu.school || '';
  document.getElementById('eduLocation').value = edu.location || '';
  document.getElementById('eduStart').value = edu.start || '';
  const isPresent = edu.end === 'Present' || !edu.end;
  document.getElementById('eduPresent').checked = edu.end === 'Present';
  document.getElementById('eduEnd').disabled = edu.end === 'Present';
  document.getElementById('eduEnd').value = edu.end === 'Present' ? '' : (edu.end || '');
  document.getElementById('eduGPA').value = edu.gpa || '';
  document.getElementById('eduExtras').value = edu.extras || '';
}

function saveEducation() {
  const isPresent = document.getElementById('eduPresent').checked;
  const edu = {
    degree: document.getElementById('eduDegree').value,
    school: document.getElementById('eduSchool').value,
    location: document.getElementById('eduLocation').value,
    start: document.getElementById('eduStart').value,
    end: isPresent ? 'Present' : document.getElementById('eduEnd').value,
    gpa: document.getElementById('eduGPA').value,
    extras: document.getElementById('eduExtras').value
  };

  const editIndex = parseInt(document.getElementById('eduEditIndex').value);
  if (editIndex >= 0) {
    state.education[editIndex] = edu;
  } else {
    state.education.push(edu);
  }

  localStorage.setItem('resumeEducation', JSON.stringify(state.education));
  closeModal('education');
  renderEducation();
  saveUserData();
  ['eduDegree', 'eduSchool', 'eduLocation', 'eduStart', 'eduEnd', 'eduGPA', 'eduExtras'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('eduEditIndex').value = '-1';
  document.getElementById('eduModalTitle').textContent = 'Add Education';
}

function deleteEducation(i) {
  if (confirm('Delete this education?')) {
    state.education.splice(i, 1);
    localStorage.setItem('resumeEducation', JSON.stringify(state.education));
    renderEducation();
    saveUserData();
  }
}

// Certification functions
function renderCerts() {
  const list = document.getElementById('certsList');
  list.innerHTML = state.certs.map((cert, i) => `
    <div class="item">
      <div class="item-header">
        <div>
          <div class="item-title">${cert.name}</div>
          <div class="item-subtitle">${cert.org} | ${cert.date}${cert.id ? ' | ID: ' + cert.id : ''}</div>
        </div>
        <div class="item-actions">
          <button class="danger" onclick="deleteCert(${i})">Delete</button>
        </div>
      </div>
    </div>
  `).join('');
}

function saveCert() {
  const cert = {
    name: document.getElementById('certName').value,
    org: document.getElementById('certOrg').value,
    date: document.getElementById('certDate').value,
    id: document.getElementById('certId').value
  };
  state.certs.push(cert);
  localStorage.setItem('resumeCerts', JSON.stringify(state.certs));
  closeModal('cert');
  renderCerts();
  saveUserData();
  ['certName', 'certOrg', 'certDate', 'certId'].forEach(id => document.getElementById(id).value = '');
}

function deleteCert(i) {
  if (confirm('Delete this certification?')) {
    state.certs.splice(i, 1);
    localStorage.setItem('resumeCerts', JSON.stringify(state.certs));
    renderCerts();
    saveUserData();
  }
}

// Skills functions
function renderSkills() {
  ['technical', 'soft', 'tools', 'interests'].forEach(type => {
    const container = document.getElementById(type === 'technical' ? 'technicalSkills' : type === 'soft' ? 'softSkills' : type);
    const skills = state.skills[type] || [];
    container.innerHTML = skills.map((s, i) => `
      <span class="tag">${s}<span class="tag-remove" onclick="removeSkill('${type}', ${i})">&times;</span></span>
    `).join('');
  });
}

function addSkill(type) {
  const inputId = type === 'technical' ? 'techSkillInput' : type === 'soft' ? 'softSkillInput' : type === 'tools' ? 'toolInput' : 'interestInput';
  const input = document.getElementById(inputId);
  const value = input.value.trim();
  if (value) {
    if (!state.skills[type]) state.skills[type] = [];
    state.skills[type].push(value);
    localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
    renderSkills();
    input.value = '';
    saveUserData();
  }
}

function removeSkill(type, i) {
  state.skills[type].splice(i, 1);
  localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
  renderSkills();
  saveUserData();
}

// Enter key for skill inputs
['techSkillInput', 'softSkillInput', 'toolInput', 'interestInput'].forEach(id => {
  document.getElementById(id).addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      const type = id === 'techSkillInput' ? 'technical' : id === 'softSkillInput' ? 'soft' : id === 'toolInput' ? 'tools' : 'interests';
      addSkill(type);
    }
  });
});

// Project functions
function renderProjects() {
  const list = document.getElementById('projectsList');
  list.innerHTML = state.projects.map((proj, i) => `
    <div class="item">
      <div class="item-header">
        <div style="flex:1">
          <div class="item-title" style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
            ${proj.name}
            ${proj.aiAssisted ? '<span class="ai-badge">Built with AI</span>' : ''}
          </div>
          <div class="item-subtitle">${proj.shortDesc || ''}</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
            ${proj.tech ? proj.tech.split(',').map(t => `<span class="tech-tag">${t.trim()}</span>`).join('') : ''}
          </div>
        </div>
        <div class="item-actions">
          <button class="secondary" onclick="editProject(${i})">Edit</button>
          <button class="danger" onclick="deleteProject(${i})">Delete</button>
        </div>
      </div>
      ${proj.features && proj.features.length ? `
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px">
          ${proj.features.map(f => `<span class="feature-chip">${f}</span>`).join('')}
        </div>
      ` : ''}
      <div style="display:flex;gap:15px;margin-top:10px;flex-wrap:wrap;align-items:center">
        ${proj.url ? `<a href="${proj.url}" target="_blank" style="color:#fff;font-size:0.9em;display:flex;align-items:center;gap:5px">${proj.url.includes('github') ? '<svg height="16" width="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg> GitHub' : 'ðŸ“ Repo'}</a>` : ''}
        ${proj.liveUrl ? `<a href="${proj.liveUrl}" target="_blank" style="color:#10b981;font-size:0.9em;display:flex;align-items:center;gap:5px"><svg height="14" width="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg> Live</a>` : ''}
      </div>
    </div>
  `).join('') || '<p style="color:#666;padding:20px;text-align:center">No projects added yet</p>';
}

function editProject(i) {
  const proj = state.projects[i];
  document.getElementById('projectModalTitle').textContent = 'Edit Project';
  document.getElementById('projectEditIndex').value = i;
  document.getElementById('projectName').value = proj.name || '';
  document.getElementById('projectShortDesc').value = proj.shortDesc || '';
  document.getElementById('projectTech').value = proj.tech || '';
  document.getElementById('projectUrl').value = proj.url || '';
  document.getElementById('projectLiveUrl').value = proj.liveUrl || '';
  document.getElementById('projectFeatures').value = (proj.features || []).join('\n');
  document.getElementById('projectContext').value = proj.context || '';
  document.getElementById('projectReadme').value = proj.readme || '';
  document.getElementById('projectAiAssisted').checked = proj.aiAssisted || false;
  openModal('project');
}

function saveProject() {
  const proj = {
    name: document.getElementById('projectName').value,
    shortDesc: document.getElementById('projectShortDesc').value,
    tech: document.getElementById('projectTech').value,
    url: document.getElementById('projectUrl').value,
    liveUrl: document.getElementById('projectLiveUrl').value,
    features: document.getElementById('projectFeatures').value.split('\n').filter(f => f.trim()),
    context: document.getElementById('projectContext').value,
    readme: document.getElementById('projectReadme').value,
    aiAssisted: document.getElementById('projectAiAssisted').checked
  };

  const editIndex = parseInt(document.getElementById('projectEditIndex').value);
  if (editIndex >= 0) {
    state.projects[editIndex] = proj;
  } else {
    state.projects.push(proj);
  }

  localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
  closeModal('project');
  renderProjects();
  saveUserData();

  // Clear form
  ['projectName', 'projectShortDesc', 'projectTech', 'projectUrl', 'projectLiveUrl', 'projectFeatures', 'projectContext', 'projectReadme'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('projectEditIndex').value = '-1';
  document.getElementById('projectAiAssisted').checked = false;
}

async function aiExtractFromReadme() {
  const readme = document.getElementById('projectReadme').value;
  const status = document.getElementById('extractStatus');
  const btn = document.getElementById('aiExtractBtnText');

  if (!readme.trim()) {
    status.textContent = 'Paste a README first';
    status.style.color = '#ef4444';
    return;
  }

  btn.textContent = 'Extracting...';
  status.textContent = '';

  try {
    const response = await fetch('/api/parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'extract', readme })
    });

    const text = await response.text();
    if (!text) {
      throw new Error('Server returned empty response. Try again.');
    }

    let extracted;
    try {
      extracted = JSON.parse(text);
    } catch (parseErr) {
      throw new Error('Invalid response from server: ' + text.substring(0, 100));
    }

    if (!response.ok) {
      const debugInfo = extracted.debug ? ` | Debug: ${JSON.stringify(extracted.debug)}` : '';
      throw new Error((extracted.error || 'AI extraction failed') + debugInfo);
    }

    // Populate short description if empty
    const shortDescField = document.getElementById('projectShortDesc');
    if (!shortDescField.value.trim() && extracted.shortDesc) {
      shortDescField.value = extracted.shortDesc;
    }

    // Populate features
    const featuresField = document.getElementById('projectFeatures');
    const existingFeatures = featuresField.value.split('\n').filter(f => f.trim());
    const newFeatures = [...new Set([...existingFeatures, ...extracted.features])];
    featuresField.value = newFeatures.join('\n');

    // Populate tech
    const techField = document.getElementById('projectTech');
    const existingTech = techField.value.split(',').map(t => t.trim()).filter(t => t);
    const newTech = [...new Set([...existingTech, ...extracted.technologies])];
    techField.value = newTech.join(', ');

    const parts = [];
    if (extracted.shortDesc) parts.push('description');
    if (extracted.features.length) parts.push(`${extracted.features.length} features`);
    if (extracted.technologies.length) parts.push(`${extracted.technologies.length} technologies`);

    status.textContent = `Extracted ${parts.join(', ')}!`;
    status.style.color = '#10b981';

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  } finally {
    btn.textContent = 'Extract with AI';
  }
}

function deleteProject(i) {
  if (confirm('Delete this project?')) {
    state.projects.splice(i, 1);
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
    renderProjects();
    saveUserData();
  }
}

function extractFromReadme(readme) {
  const features = [];
  const technologies = [];
  const lines = readme.split('\n');
  let currentSection = null;

  // Sections to extract features from
  const featureSections = /^#{1,3}\s*(features|key features|highlights|what it does|what is|core features|main features)/i;
  // Sections to extract technologies from
  const techSections = /^#{1,3}\s*(tech stack|technologies|built with|stack|why this stack)/i;
  // Sections to skip entirely
  const skipSections = /^#{1,3}\s*(roadmap|development roadmap|ui layout|layout|installation|setup|getting started|contributing|license|acknowledgments|credits|todo|future|planned|usage|example|api|bom|bill of materials|templates|configuration|config|how it works|formula|variance|production|sandbox|escalation|detailed)/i;

  // Pattern to detect code/formula-like content (not real features)
  const codePattern = /(\â†’|â†’|=>|=\s*\d|Ã—|\*\s*\d|ceil\(|floor\(|Math\.|^\d+\s*(oz|ml|g|kg|lb|towels?|applications?)|\$\{|function |const |let |var |import |export |class |handleof\.it|sampling\.|\.com|\.io|http)/i;

  // Pattern for feature-like content (has a dash separator with description)
  const featureWithDescPattern = /^(.+?)\s*[-â€“â€”]\s*(.+)$/;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    // Check for section headers
    if (/^#{1,3}\s+/.test(line)) {
      if (featureSections.test(line)) {
        currentSection = 'features';
      } else if (techSections.test(line)) {
        currentSection = 'tech';
      } else if (skipSections.test(line)) {
        currentSection = 'skip';
      } else {
        // Check for numbered feature headers like "1. Task Management"
        const numberedHeader = line.match(/^#{1,3}\s*\d+\.\s*(.+)/);
        if (numberedHeader && currentSection === 'features') {
          const headerFeature = numberedHeader[1].trim();
          if (headerFeature.length > 3 && headerFeature.length < 50 && !codePattern.test(headerFeature)) {
            features.push(headerFeature);
          }
        }
        // Don't change section for sub-headers within features
        if (currentSection !== 'features') {
          currentSection = null;
        }
      }
      continue;
    }

    // Skip if in a skip section
    if (currentSection === 'skip') continue;

    // Extract bullet points (- or * at start of line)
    const bulletMatch = line.match(/^[-*]\s+(.+)/);
    if (bulletMatch) {
      let item = bulletMatch[1].trim();
      // Clean up markdown formatting
      item = item.replace(/\*\*([^*]+)\*\*/g, '$1'); // Remove bold
      item = item.replace(/\[([^\]]+)\]\([^)]+\)/g, '$1'); // Clean links
      item = item.replace(/`([^`]+)`/g, '$1'); // Remove code backticks

      // Skip if it looks like code, formula, or technical spec
      if (codePattern.test(item)) continue;

      // Check if it's a "Feature - Description" format
      const featureDescMatch = item.match(featureWithDescPattern);
      if (featureDescMatch && currentSection === 'features') {
        const featureName = featureDescMatch[1].trim();
        const featureDesc = featureDescMatch[2].trim();
        if (featureName.length > 2 && featureDesc.length > 5) {
          features.push(`${featureName} - ${featureDesc}`);
          continue;
        }
      }

      if (currentSection === 'tech' && item.length > 1 && item.length < 100) {
        technologies.push(item);
      } else if (currentSection === 'features' && item.length > 10 && item.length < 200) {
        features.push(item);
      } else if (!currentSection && item.length > 20 && item.length < 200 && features.length < 4) {
        // Only add uncategorized bullets if they look like real features
        if (!/^(install|clone|run|npm|yarn|cd |git |mkdir|pip |python |docker |curl |wget )/i.test(item)) {
          features.push(item);
        }
      }
    }
  }

  return {
    features: [...new Set(features)].slice(0, 8),
    technologies: [...new Set(technologies)].slice(0, 15)
  };
}

async function fetchGitHubRepos() {
  const input = document.getElementById('githubUsername').value.trim();
  const status = document.getElementById('githubFetchStatus');
  const listEl = document.getElementById('githubReposList');

  if (!input) {
    status.textContent = 'Please enter a GitHub username';
    status.style.color = '#ef4444';
    return;
  }

  // Extract username from URL or use as-is
  let username = input;
  const urlMatch = input.match(/github\.com\/([^\/]+)/);
  if (urlMatch) username = urlMatch[1];

  status.textContent = 'Fetching repositories...';
  status.style.color = '#888';
  listEl.innerHTML = '';

  try {
    const res = await fetch(`https://api.github.com/users/${username}/repos?per_page=100&sort=updated`);
    if (!res.ok) throw new Error('User not found');
    const repos = await res.json();

    if (repos.length === 0) {
      status.textContent = 'No public repositories found';
      return;
    }

    status.textContent = `Found ${repos.length} public repositories`;
    status.style.color = '#10b981';

    // Check which repos are already imported
    const importedUrls = new Set(state.projects.map(p => p.url));

    listEl.innerHTML = repos.map(repo => {
      const isImported = importedUrls.has(repo.html_url);
      return `
        <div class="github-repo-item" style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#1a1a1a;border-radius:8px;margin-bottom:8px">
          <div style="flex:1;min-width:0">
            <div style="font-weight:500;color:#fff">${repo.name}</div>
            <div style="font-size:0.85em;color:#888;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${repo.description || 'No description'}</div>
            <div style="font-size:0.8em;color:#666;margin-top:4px">
              ${repo.language ? `<span style="color:#60a5fa">${repo.language}</span> Â· ` : ''}
              â­ ${repo.stargazers_count} Â· Updated ${new Date(repo.updated_at).toLocaleDateString()}
            </div>
          </div>
          <button
            onclick="importGitHubRepo('${username}', '${repo.name}')"
            class="${isImported ? '' : 'secondary'}"
            style="margin-left:10px;white-space:nowrap${isImported ? ';background:#333;color:#666;cursor:default' : ''}"
            ${isImported ? 'disabled' : ''}
          >${isImported ? 'Imported' : 'Import'}</button>
        </div>
      `;
    }).join('');

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  }
}

async function importGitHubRepo(owner, repoName) {
  // Find and update the button
  const buttons = document.querySelectorAll('.github-repo-item button');
  let btn = null;
  buttons.forEach(b => {
    if (b.onclick && b.onclick.toString().includes(repoName)) {
      btn = b;
    }
  });

  // Find button by checking parent content
  const items = document.querySelectorAll('.github-repo-item');
  items.forEach(item => {
    if (item.textContent.includes(repoName)) {
      btn = item.querySelector('button');
    }
  });

  if (btn) {
    btn.textContent = 'Importing...';
    btn.disabled = true;
  }

  try {
    // Fetch repo info
    const repoRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}`);
    if (!repoRes.ok) throw new Error('Repository not found');
    const repoData = await repoRes.json();

    // Try to fetch README
    let readme = '';
    let extractedFeatures = [];
    let extractedTech = [];
    try {
      const readmeRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}/readme`);
      if (readmeRes.ok) {
        const readmeData = await readmeRes.json();
        const binaryString = atob(readmeData.content.replace(/\n/g, ''));
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        readme = new TextDecoder('utf-8').decode(bytes);
        const extracted = extractFromReadme(readme);
        extractedFeatures = extracted.features;
        extractedTech = extracted.technologies;
      }
    } catch (e) {}

    // Fetch languages
    let apiLanguages = [];
    try {
      const langRes = await fetch(`https://api.github.com/repos/${owner}/${repoName}/languages`);
      if (langRes.ok) {
        const languages = await langRes.json();
        apiLanguages = Object.keys(languages);
      }
    } catch (e) {}

    const allTech = [...new Set([...apiLanguages, ...extractedTech])];

    const proj = {
      name: repoData.name,
      shortDesc: repoData.description || '',
      tech: allTech.join(', '),
      url: repoData.html_url,
      features: extractedFeatures,
      readme: readme
    };

    state.projects.push(proj);
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
    renderProjects();
    saveUserData();

    if (btn) {
      btn.textContent = 'Imported';
      btn.className = '';
      btn.style.background = '#333';
      btn.style.color = '#666';
    }

  } catch (e) {
    if (btn) {
      btn.textContent = 'Error';
      btn.style.background = '#ef4444';
    }
    console.error('Import error:', e);
  }
}

async function importFromGitHub() {
  const url = document.getElementById('githubRepoUrl')?.value?.trim();
  const status = document.getElementById('githubImportStatus');
  if (!status) return;

  if (!url) {
    status.textContent = 'Please enter a GitHub URL';
    status.style.color = '#ef4444';
    return;
  }

  // Extract owner/repo from URL
  const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
  if (!match) {
    status.textContent = 'Invalid GitHub URL';
    status.style.color = '#ef4444';
    return;
  }

  const [, owner, repo] = match;
  status.textContent = 'Fetching repository...';
  status.style.color = '#888';

  try {
    // Fetch repo info
    const repoRes = await fetch(`https://api.github.com/repos/${owner}/${repo.replace('.git', '')}`);
    if (!repoRes.ok) throw new Error('Repository not found or is private');
    const repoData = await repoRes.json();

    // Try to fetch README
    let readme = '';
    let extractedFeatures = [];
    let extractedTech = [];
    try {
      const readmeRes = await fetch(`https://api.github.com/repos/${owner}/${repo.replace('.git', '')}/readme`);
      if (readmeRes.ok) {
        const readmeData = await readmeRes.json();
        // Properly decode base64 with UTF-8 support (fixes emoji/special char issues)
        const binaryString = atob(readmeData.content.replace(/\n/g, ''));
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
          bytes[i] = binaryString.charCodeAt(i);
        }
        readme = new TextDecoder('utf-8').decode(bytes);

        // Extract features and technologies from README
        const extracted = extractFromReadme(readme);
        extractedFeatures = extracted.features;
        extractedTech = extracted.technologies;
      }
    } catch (e) {
      // README not found, that's okay
    }

    // Fetch languages from GitHub API
    let apiLanguages = [];
    try {
      const langRes = await fetch(`https://api.github.com/repos/${owner}/${repo.replace('.git', '')}/languages`);
      if (langRes.ok) {
        const languages = await langRes.json();
        apiLanguages = Object.keys(languages);
      }
    } catch (e) {}

    // Merge technologies: API languages + README tech stack (deduplicated)
    const allTech = [...new Set([...apiLanguages, ...extractedTech])];
    const tech = allTech.join(', ');

    // Create project
    const proj = {
      name: repoData.name,
      shortDesc: repoData.description || '',
      tech: tech,
      url: repoData.html_url,
      features: extractedFeatures,
      readme: readme
    };

    state.projects.push(proj);
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
    renderProjects();
    saveUserData();

    const featureCount = extractedFeatures.length;
    const techCount = allTech.length;
    const parts = [];
    if (featureCount > 0) parts.push(`${featureCount} features`);
    if (techCount > 0) parts.push(`${techCount} technologies`);
    status.textContent = parts.length > 0
      ? `Imported with ${parts.join(' and ')} extracted!`
      : 'Imported! Click Edit to add features/achievements.';
    status.style.color = '#10b981';
    document.getElementById('githubRepoUrl').value = '';

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
    status.style.color = '#ef4444';
  }
}

function copyCoverLetter() {
  const text = document.getElementById('coverLetterOutput').innerText || document.getElementById('coverLetterOutput').textContent;
  if (!text || text.trim() === '') {
    alert('No cover letter content to copy.');
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Cover letter copied!');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

// Fetch job from URL
// Instruction presets
function loadInstructionPresets() {
  const presets = state.instructionPresets || [];
  const container = document.getElementById('instructionPresets');

  if (presets.length === 0) {
    container.innerHTML = '<span style="color:#666;font-size:12px">No saved presets yet. Type instructions and click "Save as Preset".</span>';
    return;
  }

  container.innerHTML = presets.map((preset, idx) => `
    <div class="preset-chip" style="display:inline-flex;align-items:center;gap:6px;background:#2a2a3e;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid #444;transition:all 0.2s"
         onmouseenter="this.style.borderColor='#00ff88'"
         onmouseleave="this.style.borderColor='#444'">
      <span onclick="addPresetToInstructions(${idx})" style="color:#ddd">${escapeHtml(preset.name)}</span>
      <span onclick="deletePreset(${idx})" style="color:#888;font-size:14px;padding:0 2px" title="Delete preset">&times;</span>
    </div>
  `).join('');
}

function saveInstructionPreset() {
  const text = document.getElementById('additionalInstructions').value.trim();
  if (!text) {
    alert('Please enter some instructions first');
    return;
  }

  const name = prompt('Give this preset a short name:', text.substring(0, 30) + (text.length > 30 ? '...' : ''));
  if (!name) return;

  // Check for duplicate names
  if (state.instructionPresets.some(p => p.name.toLowerCase() === name.toLowerCase())) {
    if (!confirm('A preset with this name already exists. Replace it?')) return;
    const idx = state.instructionPresets.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
    state.instructionPresets[idx] = { name, text };
  } else {
    state.instructionPresets.push({ name, text });
  }

  // Save to localStorage (for non-logged-in users) and to account (if logged in)
  localStorage.setItem('instructionPresets', JSON.stringify(state.instructionPresets));
  saveUserData();
  loadInstructionPresets();
  alert('Preset saved!' + (currentUser ? ' Synced to your account.' : ''));
}

function addPresetToInstructions(idx) {
  const presets = state.instructionPresets || [];
  if (!presets[idx]) return;

  const textarea = document.getElementById('additionalInstructions');
  const currentText = textarea.value.trim();
  const presetText = presets[idx].text;

  // Add to existing instructions (avoid duplicates)
  if (currentText.includes(presetText)) {
    return; // Already added
  }

  textarea.value = currentText ? currentText + '\n\n' + presetText : presetText;
}

function deletePreset(idx) {
  if (!confirm('Delete this preset?')) return;

  state.instructionPresets.splice(idx, 1);
  localStorage.setItem('instructionPresets', JSON.stringify(state.instructionPresets));
  saveUserData();
  loadInstructionPresets();
}

// Question presets
function loadQuestionPresets() {
  const presets = state.questionPresets || [];
  const container = document.getElementById('questionPresets');

  if (presets.length === 0) {
    container.innerHTML = '<span style="color:#666;font-size:12px">No saved questions yet. Type a question and click "Save Current as Preset".</span>';
    return;
  }

  container.innerHTML = presets.map((preset, idx) => `
    <div class="preset-chip" style="display:inline-flex;align-items:center;gap:6px;background:#2a2a3e;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid #444;transition:all 0.2s"
         onmouseenter="this.style.borderColor='#00ff88'"
         onmouseleave="this.style.borderColor='#444'">
      <span onclick="addQuestionPreset(${idx})" style="color:#ddd">${escapeHtml(preset.name)}</span>
      <span onclick="deleteQuestionPreset(${idx})" style="color:#888;font-size:14px;padding:0 2px" title="Delete preset">&times;</span>
    </div>
  `).join('');
}

function saveQuestionPreset() {
  const text = document.getElementById('applicationQuestion').value.trim();
  if (!text) {
    alert('Please enter a question first');
    return;
  }

  const name = prompt('Give this question a short name:', text.substring(0, 30) + (text.length > 30 ? '...' : ''));
  if (!name) return;

  // Check for duplicate names
  if (state.questionPresets.some(p => p.name.toLowerCase() === name.toLowerCase())) {
    if (!confirm('A preset with this name already exists. Replace it?')) return;
    const idx = state.questionPresets.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
    state.questionPresets[idx] = { name, text };
  } else {
    state.questionPresets.push({ name, text });
  }

  localStorage.setItem('questionPresets', JSON.stringify(state.questionPresets));
  saveUserData();
  loadQuestionPresets();
  alert('Question preset saved!' + (currentUser ? ' Synced to your account.' : ''));
}

function addQuestionPreset(idx) {
  const presets = state.questionPresets || [];
  if (!presets[idx]) return;
  document.getElementById('applicationQuestion').value = presets[idx].text;
}

function deleteQuestionPreset(idx) {
  if (!confirm('Delete this question preset?')) return;

  state.questionPresets.splice(idx, 1);
  localStorage.setItem('questionPresets', JSON.stringify(state.questionPresets));
  saveUserData();
  loadQuestionPresets();
}

// Q&A Helper functions
function setQuestion(question) {
  document.getElementById('applicationQuestion').value = question;
}

async function generateAnswer() {
  const question = document.getElementById('applicationQuestion').value.trim();
  if (!question) {
    alert('Please enter a question');
    return;
  }

  const context = document.getElementById('questionContext').value.trim();
  const length = document.getElementById('answerLength').value;

  document.getElementById('answerLoading').classList.add('active');
  document.getElementById('answerOutput').style.display = 'none';

  const btn = document.getElementById('generateAnswerBtn');
  btn.disabled = true;

  try {
    const res = await fetch('/api/answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question,
        context,
        length,
        profile: state.profile,
        experience: state.experience,
        education: state.education,
        skills: state.skills,
        projects: state.projects
      })
    });

    if (!res.ok) throw new Error('Failed to generate answer');

    const data = await res.json();

    document.getElementById('answerText').textContent = data.answer;
    document.getElementById('answerTips').innerHTML = data.tips || '';
    document.getElementById('answerOutput').style.display = 'block';

  } catch (e) {
    alert('Error generating answer: ' + e.message);
  } finally {
    document.getElementById('answerLoading').classList.remove('active');
    btn.disabled = false;
  }
}

function copyAnswer() {
  const text = document.getElementById('answerText').textContent;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Answer copied!');
    }).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

// AI Detection Check
async function checkAI(type) {
  let text = '';
  let typeName = '';

  if (type === 'resume') {
    text = document.getElementById('resumeOutput').textContent;
    typeName = 'resume';
  } else if (type === 'coverLetter') {
    text = document.getElementById('coverLetterOutput').textContent;
    typeName = 'cover letter';
  } else if (type === 'answer') {
    text = document.getElementById('answerText').textContent;
    typeName = 'Q&A answer';
  }

  if (!text || text.trim().length < 50) {
    alert('Not enough text to analyze');
    return;
  }

  const modal = document.getElementById('aiCheckModal');
  const loading = document.getElementById('aiCheckLoading');
  const results = document.getElementById('aiCheckResults');

  modal.classList.add('active');
  loading.style.display = 'block';
  results.style.display = 'none';

  try {
    const res = await fetch('/api/ai-check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, type: typeName })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Check failed');

    // Display score with color
    const scoreEl = document.getElementById('aiCheckScore');
    scoreEl.textContent = data.score + '/10';
    if (data.score <= 3) {
      scoreEl.style.color = '#10b981'; // green - human
    } else if (data.score <= 6) {
      scoreEl.style.color = '#f59e0b'; // yellow - mixed
    } else {
      scoreEl.style.color = '#ef4444'; // red - AI
    }

    document.getElementById('aiCheckVerdict').textContent = data.verdict;

    // Red flags
    document.getElementById('aiCheckRedFlags').innerHTML =
      (data.redFlags || []).length > 0
        ? data.redFlags.map(f => `<li style="margin-bottom:8px">â€¢ ${f}</li>`).join('')
        : '<li style="color:#888">None detected</li>';

    // Human elements
    document.getElementById('aiCheckHuman').innerHTML =
      (data.humanElements || []).length > 0
        ? data.humanElements.map(h => `<li style="margin-bottom:8px">â€¢ ${h}</li>`).join('')
        : '<li style="color:#888">None detected</li>';

    // Suggestions
    document.getElementById('aiCheckSuggestions').innerHTML =
      (data.suggestions || []).length > 0
        ? data.suggestions.map(s => `<li style="margin-bottom:8px">â€¢ ${s}</li>`).join('')
        : '<li style="color:#888">No suggestions</li>';

    results.style.display = 'block';

  } catch (e) {
    alert('Error checking AI: ' + e.message);
    modal.classList.remove('active');
  } finally {
    loading.style.display = 'none';
  }
}

async function fetchJobFromUrl() {
  const urlInput = document.getElementById('jobUrl');
  const url = urlInput.value.trim();

  if (!url) {
    alert('Please enter a job posting URL');
    return;
  }

  const btn = document.getElementById('fetchJobBtn');
  const originalText = btn.textContent;
  btn.textContent = 'Fetching...';
  btn.disabled = true;

  try {
    const response = await fetch('/api/fetch-job', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });

    const data = await response.json();

    if (data.error) {
      alert('Error fetching job: ' + data.error);
      return;
    }

    // Populate the form fields
    if (data.description) {
      document.getElementById('jobDescription').value = data.description;
    }
    if (data.company) {
      document.getElementById('jobCompany').value = data.company;
    }
    if (data.title) {
      document.getElementById('targetRole').value = data.title;
    }

    // Show success message
    const msg = [];
    if (data.company) msg.push(data.company);
    if (data.title) msg.push(data.title);
    if (data.location) msg.push(data.location);

    if (msg.length > 0) {
      alert('Imported: ' + msg.join(' - '));
    } else if (data.description) {
      alert('Job description imported. Company/title could not be detected - please fill in manually.');
    }

  } catch (e) {
    alert('Error fetching job: ' + e.message);
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

// Generate resume
async function generateResume() {
  const jobDescription = document.getElementById('jobDescription').value.trim();
  if (!jobDescription) {
    alert('Please paste a job description');
    return;
  }

  document.getElementById('loading').classList.add('active');
  document.getElementById('output').style.display = 'none';

  const payload = {
    profile: state.profile,
    experience: state.experience,
    education: state.education,
    certs: state.certs,
    skills: state.skills,
    projects: state.projects,
    jobDescription: jobDescription,
    targetRole: document.getElementById('targetRole').value,
    additionalInstructions: document.getElementById('additionalInstructions').value,
    includeCoverLetter: document.getElementById('generateCoverLetter').checked
  };

  try {
    const res = await fetch('/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      throw new Error(errorData.error || 'API error: ' + res.status);
    }

    const data = await res.json();

    // Store for saving to library
    state.lastGenerated = {
      company: document.getElementById('jobCompany').value || 'Unknown Company',
      title: document.getElementById('targetRole').value || 'Position',
      jobDescription: jobDescription,
      jobUrl: document.getElementById('jobUrl').value || '',
      score: data.score,
      matchedKeywords: data.matchedKeywords,
      missingKeywords: data.missingKeywords,
      tailoredSummary: data.tailoredSummary,
      resume: data.resume,
      recruiterAssessment: data.recruiterAssessment,
      coverLetter: data.coverLetter
    };

    document.getElementById('atsScore').textContent = data.score + '%';
    document.getElementById('keywordAnalysis').innerHTML = `
      <div style="margin-top:15px">
        <strong style="display:block;margin-bottom:8px">Matched Keywords:</strong>
        <div style="display:flex;flex-wrap:wrap;gap:4px">
          ${data.matchedKeywords.map(k => `<span class="keyword-match">${k}</span>`).join('')}
        </div>
      </div>
      <div style="margin-top:15px">
        <strong style="display:block;margin-bottom:8px">Consider Adding:</strong>
        <div style="display:flex;flex-wrap:wrap;gap:4px">
          ${data.missingKeywords.map(k => `<span class="keyword-missing">${k}</span>`).join('')}
        </div>
      </div>
    `;
    document.getElementById('relevanceRankings').textContent = data.relevanceRankings || 'Not available';
    document.getElementById('tailoredSummary').textContent = data.tailoredSummary || 'Not available';
    document.getElementById('resumeOutput').textContent = data.resume;
    document.getElementById('recruiterAssessment').innerHTML = (data.recruiterAssessment || 'Not available').replace(/\n/g, '<br>');

    // Show cover letter if generated
    if (data.coverLetter) {
      document.getElementById('coverLetterOutput').textContent = data.coverLetter;
      document.getElementById('coverLetterSection').style.display = 'block';
      state.lastGenerated.coverLetter = data.coverLetter;
    } else {
      document.getElementById('coverLetterSection').style.display = 'none';
    }

    // Populate comparison view
    populateComparison(data);

    document.getElementById('output').style.display = 'block';
  } catch (e) {
    alert('Error generating resume: ' + e.message);
  } finally {
    document.getElementById('loading').classList.remove('active');
  }
}

function toggleComparison() {
  const details = document.getElementById('comparisonDetails');
  const btn = document.getElementById('toggleComparisonBtn');

  if (details.style.display === 'none') {
    details.style.display = 'block';
    btn.textContent = 'Hide Details';
  } else {
    details.style.display = 'none';
    btn.textContent = 'Show Details';
  }
}

function populateComparison(data) {
  const originalSummary = state.profile.summary || '';
  const tailoredSummary = data.tailoredSummary || '';

  // Summary comparison
  document.getElementById('originalSummary').textContent = originalSummary || '(No summary provided)';
  document.getElementById('newSummary').textContent = tailoredSummary || '(No tailored summary generated)';

  // Parse the generated resume to extract experience bullets
  const generatedBullets = extractBulletsFromResume(data.resume || '');

  // Build experience comparison
  let comparisonHtml = '';
  let totalOriginalBullets = 0;
  let changesCount = 0;

  state.experience.forEach((exp, idx) => {
    const originalBullets = exp.bullets || [];
    totalOriginalBullets += originalBullets.length;

    // Find matching experience in generated resume
    const matchedBullets = findMatchingExperience(exp.company, exp.title, generatedBullets);

    if (originalBullets.length > 0 || matchedBullets.length > 0) {
      comparisonHtml += `
        <div style="margin-bottom:20px;padding:15px;background:#111;border-radius:8px">
          <div style="color:#fff;font-weight:600;margin-bottom:12px">${exp.title} at ${exp.company}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
            <div>
              <div style="color:#888;font-size:11px;margin-bottom:8px;text-transform:uppercase">Original Bullets</div>
              <ul style="margin:0;padding-left:20px;color:#aaa;font-size:13px;line-height:1.8">
                ${originalBullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')}
              </ul>
            </div>
            <div>
              <div style="color:#00ff88;font-size:11px;margin-bottom:8px;text-transform:uppercase">Rewritten Bullets</div>
              <ul style="margin:0;padding-left:20px;color:#ddd;font-size:13px;line-height:1.8">
                ${matchedBullets.length > 0
                  ? matchedBullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')
                  : '<li style="color:#666">(Experience may have been condensed or reordered)</li>'}
              </ul>
            </div>
          </div>
        </div>
      `;

      if (matchedBullets.length > 0) {
        changesCount += Math.max(originalBullets.length, matchedBullets.length);
      }
    }
  });

  document.getElementById('experienceComparisonList').innerHTML = comparisonHtml || '<p style="color:#666">No experience to compare</p>';

  // Summary stats
  const summaryChanged = originalSummary !== tailoredSummary && tailoredSummary;
  const keywordsAdded = (data.matchedKeywords || []).length;

  document.getElementById('comparisonSummary').innerHTML = `
    <div style="display:flex;gap:20px;flex-wrap:wrap">
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#00ff88">${summaryChanged ? 'Yes' : 'No'}</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">Summary Tailored</div>
      </div>
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#8b5cf6">${totalOriginalBullets}</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">Original Bullets</div>
      </div>
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#f59e0b">${keywordsAdded}</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">Keywords Matched</div>
      </div>
      <div style="background:#1a1a2e;padding:12px 20px;border-radius:8px;text-align:center">
        <div style="font-size:24px;font-weight:700;color:#ec4899">${data.score || 0}%</div>
        <div style="font-size:11px;color:#888;text-transform:uppercase">ATS Score</div>
      </div>
    </div>
  `;

  // Reset comparison details to hidden
  document.getElementById('comparisonDetails').style.display = 'none';
  document.getElementById('toggleComparisonBtn').textContent = 'Show Details';
}

function extractBulletsFromResume(resumeText) {
  // Extract bullet points grouped by company/role
  const sections = {};
  const lines = resumeText.split('\n');
  let currentSection = null;
  let inExperienceSection = false;

  for (const line of lines) {
    const trimmed = line.trim();
    // Remove markdown bold markers for parsing
    const cleanLine = trimmed.replace(/\*\*/g, '').replace(/\*/g, '');

    // Detect major section headers (EXPERIENCE, EDUCATION, SKILLS, etc.)
    if (/^(PROFESSIONAL\s+)?EXPERIENCE/i.test(cleanLine) ||
        /^WORK\s+HISTORY/i.test(cleanLine)) {
      inExperienceSection = true;
      continue;
    }
    if (/^(EDUCATION|SKILLS|TECHNICAL\s+SKILLS|PROJECTS|CERTIFICATIONS|KEY\s+PROJECTS)/i.test(cleanLine)) {
      inExperienceSection = false;
      currentSection = null;
      continue;
    }

    // Only parse within experience section
    if (!inExperienceSection) continue;

    // Detect job headers - common formats:
    // "Title | Company | Location | Dates"
    // "Title at Company"
    // "Title - Company"
    const jobHeaderPatterns = [
      /^([A-Za-z\s\-]+)\s*\|\s*([A-Za-z\s\-&\.]+)\s*\|/i,  // Title | Company |
      /^([A-Za-z\s\-]+)\s+at\s+([A-Za-z\s\-&\.]+)/i,       // Title at Company
      /^([A-Za-z\s\-]+)\s*[-â€“â€”]\s*([A-Za-z\s\-&\.]+)/i,    // Title - Company
    ];

    let isJobHeader = false;
    for (const pattern of jobHeaderPatterns) {
      const match = cleanLine.match(pattern);
      if (match && match[1].length > 3 && match[2].length > 2) {
        // Make sure it's not a bullet point
        if (!trimmed.startsWith('â€¢') && !trimmed.startsWith('-') && !trimmed.match(/^\d+\./)) {
          currentSection = cleanLine.toLowerCase();
          sections[currentSection] = [];
          isJobHeader = true;
          break;
        }
      }
    }

    if (isJobHeader) continue;

    // Detect bullets - starts with â€¢, -, or * (but not ** which is bold)
    if (currentSection) {
      const bulletMatch = trimmed.match(/^[â€¢\-]\s*(.+)/) ||
                          (trimmed.startsWith('*') && !trimmed.startsWith('**') && trimmed.match(/^\*\s*(.+)/));
      if (bulletMatch) {
        const bullet = bulletMatch[1].replace(/\*\*/g, '').trim();
        if (bullet.length > 20) {  // Real bullets are usually longer
          sections[currentSection].push(bullet);
        }
      }
      // Also catch lines that start with action verbs (common in AI-generated resumes)
      else if (/^(Led|Managed|Developed|Built|Created|Designed|Implemented|Executed|Deployed|Configured|Conducted|Diagnosed|Served|Partnered|Optimized|Orchestrated|Collaborated|Applied|Established|Increased|Reduced)\s/i.test(cleanLine)) {
        if (cleanLine.length > 30) {
          sections[currentSection].push(cleanLine);
        }
      }
    }
  }

  return sections;
}

function findMatchingExperience(company, title, generatedBullets) {
  const companyLower = (company || '').toLowerCase().trim();
  const titleLower = (title || '').toLowerCase().trim();

  // First try exact matches
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;

    // Check if section contains both company and title
    if (section.includes(companyLower) && section.includes(titleLower)) {
      return bullets;
    }
  }

  // Try matching just company name
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;
    if (section.includes(companyLower)) {
      return bullets;
    }
  }

  // Try matching just title
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;
    if (section.includes(titleLower)) {
      return bullets;
    }
  }

  // Fuzzy match - check if any section contains significant parts of company or title
  for (const [section, bullets] of Object.entries(generatedBullets)) {
    if (bullets.length === 0) continue;

    // Split and check meaningful words (4+ chars)
    const companyParts = companyLower.split(/\s+/).filter(p => p.length >= 4);
    const titleParts = titleLower.split(/\s+/).filter(p => p.length >= 4);

    for (const part of companyParts) {
      if (section.includes(part)) {
        return bullets;
      }
    }
    for (const part of titleParts) {
      if (section.includes(part)) {
        return bullets;
      }
    }
  }

  return [];
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

async function saveCurrentResume() {
  if (!currentUser) {
    alert('Please sign in to save resumes');
    return;
  }

  if (!state.lastGenerated) {
    alert('No resume to save');
    return;
  }

  const btn = document.getElementById('saveToLibraryBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  try {
    const res = await fetch('/api/resumes/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        ...state.lastGenerated
      })
    });

    if (!res.ok) throw new Error('Failed to save');

    const data = await res.json();
    btn.textContent = 'Saved!';
    setTimeout(() => {
      btn.textContent = 'Save to Library';
      btn.disabled = false;
    }, 2000);

    // Update dashboard stats
    updateDashboard();
  } catch (e) {
    alert('Error saving resume: ' + e.message);
    btn.textContent = 'Save to Library';
    btn.disabled = false;
  }
}

function copyResume() {
  const text = document.getElementById('resumeOutput').innerText || document.getElementById('resumeOutput').textContent;
  if (!text || text.trim() === '') {
    alert('No resume content to copy. Please generate a resume first.');
    return;
  }

  // Try modern clipboard API first, fall back to execCommand
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard!');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  try {
    document.execCommand('copy');
    alert('Copied to clipboard!');
  } catch (err) {
    alert('Failed to copy. Please select and copy manually.');
  }
  document.body.removeChild(textarea);
}

// Batch processing functions
function addBatchJob() {
  const container = document.getElementById('batchJobsList');
  const jobs = container.querySelectorAll('.batch-job');

  if (jobs.length >= 5) {
    alert('Maximum 5 jobs allowed');
    return;
  }

  const index = jobs.length;
  const jobHtml = `
    <div class="batch-job" data-index="${index}">
      <div class="batch-job-header">
        <div class="batch-job-number">${index + 1}</div>
        <button class="remove-job" onclick="removeBatchJob(${index})">&times;</button>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label>Company Name</label>
          <input type="text" class="batch-company" placeholder="e.g., Google">
        </div>
        <div class="form-group">
          <label>Job Title</label>
          <input type="text" class="batch-title" placeholder="e.g., Software Engineer">
        </div>
      </div>
      <div class="form-group">
        <label>Job URL (optional)</label>
        <input type="url" class="batch-url" placeholder="https://...">
      </div>
      <div class="form-group">
        <label>Job Description</label>
        <textarea class="batch-jd" rows="6" placeholder="Paste the job description here..."></textarea>
      </div>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', jobHtml);

  // Show all remove buttons if more than 1 job
  if (jobs.length >= 1) {
    container.querySelectorAll('.remove-job').forEach(btn => btn.style.display = 'block');
  }

  // Hide add button if at max
  if (index >= 4) {
    document.getElementById('addJobBtn').style.display = 'none';
  }
}

function removeBatchJob(index) {
  const container = document.getElementById('batchJobsList');
  const job = container.querySelector(`[data-index="${index}"]`);
  if (job) job.remove();

  // Renumber remaining jobs
  const jobs = container.querySelectorAll('.batch-job');
  jobs.forEach((job, i) => {
    job.dataset.index = i;
    job.querySelector('.batch-job-number').textContent = i + 1;
    job.querySelector('.remove-job').setAttribute('onclick', `removeBatchJob(${i})`);
  });

  // Hide remove button if only 1 job left
  if (jobs.length <= 1) {
    jobs[0]?.querySelector('.remove-job')?.style.setProperty('display', 'none');
  }

  // Show add button
  document.getElementById('addJobBtn').style.display = 'block';
}

async function processBatchJobs() {
  const jobElements = document.querySelectorAll('.batch-job');
  const jobs = [];

  jobElements.forEach(el => {
    const jd = el.querySelector('.batch-jd').value.trim();
    if (jd) {
      jobs.push({
        company: el.querySelector('.batch-company').value.trim(),
        title: el.querySelector('.batch-title').value.trim(),
        url: el.querySelector('.batch-url').value.trim(),
        jobDescription: jd
      });
    }
  });

  if (jobs.length === 0) {
    alert('Please add at least one job description');
    return;
  }

  document.getElementById('batchLoading').classList.add('active');
  document.getElementById('batchResults').style.display = 'none';

  try {
    const res = await fetch('/api/batch/process', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        profile: state.profile,
        experience: state.experience,
        education: state.education,
        certs: state.certs,
        skills: state.skills,
        jobs
      })
    });

    if (!res.ok) throw new Error('Batch processing failed');

    const data = await res.json();
    displayBatchResults(data);
  } catch (e) {
    alert('Error processing jobs: ' + e.message);
  } finally {
    document.getElementById('batchLoading').classList.remove('active');
  }
}

function displayBatchResults(data) {
  document.getElementById('batchResults').style.display = 'block';

  // Summary
  document.getElementById('batchSummary').textContent = data.comparison.summary;
  document.getElementById('batchRecommendation').innerHTML = `
    <strong>Recommendation:</strong> ${data.comparison.recommendation}
    ${data.comparison.frequentlyMissing?.length > 0 ? `<br><br><strong>Skills to Develop:</strong> ${data.comparison.frequentlyMissing.join(', ')}` : ''}
  `;

  // Rankings
  document.getElementById('batchRankings').innerHTML = data.comparison.rankings.map(r => `
    <div class="ranking-item">
      <div class="ranking-position">#${r.rank}</div>
      <div class="ranking-details">
        <div class="ranking-company">${r.company}</div>
        <div class="ranking-title">${r.title}</div>
      </div>
      <div class="resume-score ${r.score >= 70 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</div>
      <span class="status-badge ${r.recommendation.toLowerCase().replace(' ', '-')}">${r.recommendation}</span>
    </div>
  `).join('');

  // Detailed results
  document.getElementById('batchDetailedResults').innerHTML = data.results.map((r, i) => `
    <div class="card" style="margin-bottom:20px">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:15px">
        <div>
          <h4 style="margin:0">${r.company} - ${r.title}</h4>
          ${r.url ? `<a href="${r.url}" target="_blank" style="color:#6366f1;font-size:0.9em">View Job Posting</a>` : ''}
        </div>
        <div class="resume-score ${r.score >= 70 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</div>
      </div>

      ${r.error ? `<div style="color:#ef4444">Error: ${r.error}</div>` : `
        <div style="margin-bottom:15px">
          <strong>Strengths:</strong>
          <ul style="margin:5px 0 0 20px;color:#aaa">
            ${r.strengths.map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>

        <div style="margin-bottom:15px">
          <strong>Concerns:</strong>
          <ul style="margin:5px 0 0 20px;color:#aaa">
            ${r.concerns.map(c => `<li>${c}</li>`).join('')}
          </ul>
        </div>

        <div style="margin-bottom:15px">
          <strong>Matched Keywords:</strong>
          <span style="color:#10b981">${r.matchedKeywords.slice(0, 10).join(', ')}</span>
        </div>

        <div style="margin-bottom:15px">
          <strong>Missing Keywords:</strong>
          <span style="color:#ef4444">${r.missingKeywords.slice(0, 10).join(', ')}</span>
        </div>

        <details>
          <summary style="cursor:pointer;color:#6366f1">View Tailored Resume</summary>
          <pre style="background:#222;padding:15px;border-radius:8px;margin-top:10px;white-space:pre-wrap;font-size:0.85em">${r.resume}</pre>
        </details>

        <div style="margin-top:15px">
          <button onclick="saveBatchResult(${i})" class="small success">Save to Library</button>
        </div>
      `}
    </div>
  `).join('');

  // Store results for saving
  state.batchResults = data.results;
}

async function saveBatchResult(index) {
  if (!currentUser) {
    alert('Please sign in to save resumes');
    return;
  }

  const result = state.batchResults[index];
  if (!result || result.error) return;

  try {
    const res = await fetch('/api/resumes/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        company: result.company,
        title: result.title,
        jobUrl: result.url,
        score: result.score,
        matchedKeywords: result.matchedKeywords,
        missingKeywords: result.missingKeywords,
        tailoredSummary: result.tailoredSummary,
        resume: result.resume,
        coverLetter: result.coverLetter,
        recruiterAssessment: result.recruiterAssessment
      })
    });

    if (!res.ok) throw new Error('Failed to save');
    alert('Saved to library!');
    updateDashboard();
  } catch (e) {
    alert('Error saving: ' + e.message);
  }
}

// Library functions
async function loadLibrary() {
  if (!currentUser) {
    document.getElementById('resumeList').innerHTML = `
      <div style="color:#666;padding:40px;text-align:center">
        <p>Please sign in to view your resume library</p>
      </div>
    `;
    return;
  }

  const status = document.getElementById('libraryStatusFilter').value;

  try {
    const res = await fetch(`/api/resumes/list?email=${encodeURIComponent(currentUser.email)}&status=${status}`);
    if (!res.ok) throw new Error('Failed to load');

    const data = await res.json();

    if (data.resumes.length === 0) {
      document.getElementById('resumeList').innerHTML = `
        <div style="color:#666;padding:40px;text-align:center">
          <p>No resumes found${status !== 'all' ? ' with this status' : ''}</p>
          <p style="font-size:0.9em;margin-top:10px">Generate and save resumes to build your library</p>
        </div>
      `;
      return;
    }

    document.getElementById('resumeList').innerHTML = data.resumes.map(r => `
      <div class="resume-card" onclick="viewResumeDetail('${r.id}')">
        <div class="resume-card-header">
          <div>
            <div class="resume-company">${r.company}</div>
            <div class="resume-title">${r.title}</div>
          </div>
          <div style="text-align:right">
            <div class="resume-score ${r.score >= 70 ? 'high' : r.score >= 50 ? 'medium' : 'low'}">${r.score}%</div>
            ${r.aiScores ? `
              <div style="font-size:1em;margin-top:8px;display:flex;gap:12px;justify-content:flex-end;font-weight:600">
                ${r.aiScores.resume ? `<span style="background:${r.aiScores.resume <= 3 ? '#10b98133' : r.aiScores.resume <= 6 ? '#f59e0b33' : '#ef444433'};color:${r.aiScores.resume <= 3 ? '#10b981' : r.aiScores.resume <= 6 ? '#f59e0b' : '#ef4444'};padding:4px 10px;border-radius:6px">ðŸ¤– R:${r.aiScores.resume}</span>` : ''}
                ${r.aiScores.coverLetter ? `<span style="background:${r.aiScores.coverLetter <= 3 ? '#10b98133' : r.aiScores.coverLetter <= 6 ? '#f59e0b33' : '#ef444433'};color:${r.aiScores.coverLetter <= 3 ? '#10b981' : r.aiScores.coverLetter <= 6 ? '#f59e0b' : '#ef4444'};padding:4px 10px;border-radius:6px">CL:${r.aiScores.coverLetter}</span>` : ''}
              </div>
            ` : ''}
          </div>
        </div>
        <div style="margin:10px 0;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <span class="status-badge ${r.status}">${r.status}</span>
          ${r.jobUrl ? `<a href="${r.jobUrl}" target="_blank" onclick="event.stopPropagation()" style="color:#6366f1;font-size:12px;text-decoration:none">View Job Posting â†—</a>` : ''}
        </div>
        <div class="resume-meta">
          <span>Created ${formatDate(r.createdAt)}</span>
          ${(r.matchedKeywordsCount || r.matchedKeywords?.length) > 0 ? `<span style="color:#10b981">${r.matchedKeywordsCount || r.matchedKeywords.length} matched</span>` : ''}
          ${(r.missingKeywordsCount || r.missingKeywords?.length) > 0 ? `<span style="color:#ef4444">${r.missingKeywordsCount || r.missingKeywords.length} missing</span>` : ''}
        </div>
      </div>
    `).join('');

  } catch (e) {
    console.error('Load library error:', e);
    document.getElementById('resumeList').innerHTML = `
      <div style="color:#ef4444;padding:20px;text-align:center">
        Error loading library: ${e.message}
      </div>
    `;
  }
}

async function viewResumeDetail(resumeId) {
  if (!currentUser) return;

  try {
    const res = await fetch('/api/resumes/list', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: currentUser.email, resumeId })
    });

    if (!res.ok) throw new Error('Failed to load resume');

    const resume = await res.json();

    // Parse cover letter from old format if embedded in resume text OR recruiter assessment
    if (!resume.coverLetter) {
      // Check in resume text
      if (resume.resume && resume.resume.includes('---COVER_LETTER---')) {
        const parts = resume.resume.split('---COVER_LETTER---');
        resume.resume = parts[0].trim();
        resume.coverLetter = parts[1] ? parts[1].replace('---END---', '').trim() : null;
      }
      // Check in recruiter assessment (sometimes it's appended there)
      if (!resume.coverLetter && resume.recruiterAssessment && resume.recruiterAssessment.includes('---COVER_LETTER---')) {
        const parts = resume.recruiterAssessment.split('---COVER_LETTER---');
        resume.recruiterAssessment = parts[0].trim();
        resume.coverLetter = parts[1] ? parts[1].replace('---END---', '').trim() : null;
      }
    }

    state.currentResumeDetail = resume;

    document.getElementById('resumeDetailTitle').textContent = `${resume.company} - ${resume.title}`;
    document.getElementById('resumeDetailContent').innerHTML = `
      <div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap">
        <div class="stat-card" style="flex:1;min-width:150px">
          <div class="stat-value" style="font-size:2em">${resume.score}%</div>
          <div class="stat-label">Match Score</div>
        </div>
        <div style="flex:2;min-width:200px">
          <label style="display:block;margin-bottom:8px;color:#888">Application Status</label>
          <select id="resumeStatusSelect" onchange="updateResumeStatus('${resumeId}')" style="width:auto;min-width:200px">
            <option value="generated" ${resume.status === 'generated' ? 'selected' : ''}>Generated</option>
            <option value="applied" ${resume.status === 'applied' ? 'selected' : ''}>Applied</option>
            <option value="interviewing" ${resume.status === 'interviewing' ? 'selected' : ''}>Interviewing</option>
            <option value="offered" ${resume.status === 'offered' ? 'selected' : ''}>Offered</option>
            <option value="rejected" ${resume.status === 'rejected' ? 'selected' : ''}>Rejected</option>
            <option value="withdrawn" ${resume.status === 'withdrawn' ? 'selected' : ''}>Withdrawn</option>
          </select>
        </div>
      </div>

      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:8px;color:#888">Job Posting URL</label>
        <div style="display:flex;gap:10px;align-items:center">
          <input type="url" id="resumeJobUrl" value="${resume.jobUrl || ''}" placeholder="https://..." style="flex:1">
          <button onclick="saveResumeJobUrl('${resumeId}')" class="secondary small">Save URL</button>
          ${resume.jobUrl ? `<a href="${resume.jobUrl}" target="_blank" style="color:#6366f1;font-size:12px">Open â†—</a>` : ''}
        </div>
      </div>

      <div style="margin-bottom:20px">
        <strong style="display:block;margin-bottom:8px">Matched Keywords (${(resume.matchedKeywords || []).length}):</strong>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${(resume.matchedKeywords || []).map(k => `<span style="display:inline-block;background:#10b981;color:#fff;padding:4px 12px;border-radius:15px;font-size:12px">${k}</span>`).join('')}
        </div>
      </div>

      <div style="margin-bottom:20px">
        <strong style="display:block;margin-bottom:8px">Missing Keywords (${(resume.missingKeywords || []).length}):</strong>
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${(resume.missingKeywords || []).map(k => `<span style="display:inline-block;background:#ef4444;color:#fff;padding:4px 12px;border-radius:15px;font-size:12px">${k}</span>`).join('')}
        </div>
      </div>

      ${resume.tailoredSummary ? `
        <div class="card" style="margin-bottom:20px">
          <h4 style="color:#6366f1;margin-bottom:10px">Tailored Summary</h4>
          <p style="color:#ddd;font-style:italic">${resume.tailoredSummary}</p>
        </div>
      ` : ''}

      <div class="card" style="margin-bottom:20px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
          <div style="display:flex;align-items:center;gap:12px">
            <h4 style="color:#00ff88;margin:0">Resume</h4>
            <span id="resumeWordCount" style="background:#1a2e1a;color:#00ff88;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600">${countPDFWords(resume)} words</span>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button onclick="editResumeFromLibrary()" class="secondary small" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">Edit</button>
            <button onclick="previewPDFFromLibrary()" class="secondary small" style="background:linear-gradient(135deg,#06b6d4,#0891b2)">Preview</button>
            <button onclick="copyResumeFromDetail()" class="secondary small">Copy</button>
            <button onclick="downloadPDFFromDetail()" class="secondary small" style="background:linear-gradient(135deg,#ef4444,#dc2626)">Download PDF</button>
            <label style="display:inline-flex;align-items:center;gap:4px;font-size:11px;color:#888;cursor:pointer"><input type="checkbox" id="pdfKeepTogetherLib" checked style="cursor:pointer"> Keep jobs on one page</label>
            <button onclick="checkAIBoth()" class="secondary small" style="background:linear-gradient(135deg,#f59e0b,#d97706)">ðŸ¤– AI Check</button>
          </div>
        </div>
        <pre id="libraryResumeContent" style="white-space:pre-wrap;font-family:'Courier New',monospace;line-height:1.8;color:#aaa">${resume.resume || 'No resume content'}</pre>
      </div>

      ${resume.coverLetter ? `
        <div class="card" style="margin-bottom:20px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <div style="display:flex;align-items:center;gap:12px">
              <h4 style="color:#10b981;margin:0">Cover Letter</h4>
              <span style="background:#1a2e2a;color:#10b981;padding:3px 10px;border-radius:12px;font-size:0.75em;font-weight:600">${resume.coverLetter.split(/\s+/).filter(w => w.length > 0).length} words</span>
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="editCoverLetterFromLibrary()" class="secondary small" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed)">Edit</button>
              <button onclick="copyCoverLetterFromDetail()" class="secondary small">Copy</button>
              <button onclick="downloadCoverLetterPDFFromDetail()" class="secondary small" style="background:linear-gradient(135deg,#10b981,#059669)">Download PDF</button>
            </div>
          </div>
          <pre id="libraryCoverLetterContent" style="white-space:pre-wrap;font-family:'Courier New',monospace;line-height:1.8;color:#aaa">${resume.coverLetter}</pre>
        </div>
      ` : ''}

      ${resume.recruiterAssessment ? `
        <div class="card" style="background:linear-gradient(135deg,#1a1a2e,#16213e)">
          <h4 style="color:#f59e0b;margin-bottom:10px">Recruiter Assessment</h4>
          <div style="white-space:pre-wrap;line-height:1.8">${resume.recruiterAssessment}</div>
        </div>
      ` : ''}

      <div class="form-group" style="margin-top:20px">
        <label>Notes</label>
        <textarea id="resumeNotes" rows="3" placeholder="Add notes about this application...">${resume.notes || ''}</textarea>
        <button onclick="saveResumeNotes('${resumeId}')" class="secondary small" style="margin-top:10px">Save Notes</button>
      </div>

      <div style="margin-top:30px;padding-top:20px;border-top:1px solid #333">
        <button onclick="deleteResume('${resumeId}')" class="danger">Delete Resume</button>
      </div>
    `;

    document.getElementById('resumeDetailModal').classList.add('active');

  } catch (e) {
    alert('Error loading resume: ' + e.message);
  }
}

function closeResumeDetail() {
  document.getElementById('resumeDetailModal').classList.remove('active');
}

function copyResumeFromDetail() {
  const text = state.currentResumeDetail?.resume;
  if (!text) {
    alert('No resume content to copy.');
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert('Copied to clipboard!');
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      fallbackCopy(text);
    });
  } else {
    fallbackCopy(text);
  }
}

function downloadPDFFromDetail() {
  console.log('downloadPDFFromDetail called');
  const resume = state.currentResumeDetail;
  console.log('currentResumeDetail:', resume);

  if (!resume || !resume.resume) {
    alert('No resume content to download.');
    return;
  }

  // Set lastGenerated with saved resume data for PDF generation, preserving editedProjects/Experience
  state.lastGenerated = {
    ...state.lastGenerated,
    resume: resume.resume,
    tailoredSummary: resume.tailoredSummary,
    company: resume.company,
    title: resume.title
  };

  console.log('Calling downloadPDF with lastGenerated:', state.lastGenerated);
  downloadPDF();
}

function downloadCoverLetterPDFFromDetail() {
  const resume = state.currentResumeDetail;
  if (!resume || !resume.coverLetter) {
    alert('No cover letter content to download.');
    return;
  }

  // Set lastGenerated with saved resume data for PDF generation
  state.lastGenerated = {
    ...state.lastGenerated,
    coverLetter: resume.coverLetter,
    company: resume.company,
    title: resume.title
  };

  downloadCoverLetterPDF();
}

// Toast notification
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.getElementById('toast');
  toast.className = `toast ${type}`;
  toast.innerHTML = type === 'info' ? `<div class="toast-spinner"></div>${message}` : message;
  toast.classList.add('show');

  if (duration > 0) {
    setTimeout(() => toast.classList.remove('show'), duration);
  }
  return toast;
}

function hideToast() {
  document.getElementById('toast').classList.remove('show');
}

// Copy cover letter from detail view
function copyCoverLetterFromDetail() {
  const text = state.currentResumeDetail?.coverLetter;
  if (!text) {
    alert('No cover letter to copy.');
    return;
  }
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('Cover letter copied!', 'success', 2000);
    }).catch(() => fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

// Store AI check results for saving
let currentAIResults = { resume: null, coverLetter: null };

async function checkAIBoth() {
  const resume = state.currentResumeDetail;
  if (!resume) {
    alert('No content to check.');
    return;
  }

  // Debug: log what data we have
  console.log('Resume data keys:', Object.keys(resume));
  console.log('Has resume text:', !!(resume.resume && resume.resume.length > 50));
  console.log('Has coverLetter:', !!(resume.coverLetter && resume.coverLetter.length > 50));
  console.log('CoverLetter value:', resume.coverLetter ? resume.coverLetter.substring(0, 100) + '...' : 'null/empty');

  // Show toast notification
  showToast('Analyzing resume & cover letter for AI patterns...', 'info', 0);

  const modal = document.getElementById('aiCheckModal');
  const loading = document.getElementById('aiCheckLoading');
  const loadingText = document.getElementById('aiCheckLoadingText');
  const results = document.getElementById('aiCheckResults');

  modal.classList.add('active');
  loading.style.display = 'block';
  results.style.display = 'none';
  currentAIResults = { resume: null, coverLetter: null };

  const hasCoverLetter = resume.coverLetter && resume.coverLetter.trim().length > 50;

  try {
    // Check resume
    loadingText.textContent = 'Analyzing resume...';
    if (resume.resume && resume.resume.trim().length > 50) {
      const resResume = await fetch('/api/ai-check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: resume.resume, type: 'resume' })
      });
      const resumeJson = await resResume.json();
      if (resResume.ok && resumeJson.score !== undefined) {
        currentAIResults.resume = resumeJson;
      } else {
        console.error('Resume AI check failed:', resumeJson.error || 'Unknown error');
      }
    }

    // Check cover letter if exists
    if (hasCoverLetter) {
      loadingText.textContent = 'Analyzing cover letter...';
      const resCover = await fetch('/api/ai-check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: resume.coverLetter, type: 'cover letter' })
      });
      const coverJson = await resCover.json();
      if (resCover.ok && coverJson.score !== undefined) {
        currentAIResults.coverLetter = coverJson;
      } else {
        console.error('Cover letter AI check failed:', coverJson.error || 'Unknown error');
      }
    }

    // Display results
    displayAIResults(hasCoverLetter);
    results.style.display = 'block';
    hideToast();
    showToast('AI check complete!', 'success', 2000);

  } catch (e) {
    hideToast();
    alert('Error checking AI: ' + e.message);
    modal.classList.remove('active');
  } finally {
    loading.style.display = 'none';
  }
}

function displayAIResults(hasCoverLetter) {
  const resumeData = currentAIResults.resume;
  const coverData = currentAIResults.coverLetter;

  // Resume score
  const resumeScoreEl = document.getElementById('aiResumeScore');
  if (resumeData) {
    resumeScoreEl.textContent = resumeData.score;
    resumeScoreEl.style.color = resumeData.score <= 3 ? '#10b981' : resumeData.score <= 6 ? '#f59e0b' : '#ef4444';
  } else {
    resumeScoreEl.textContent = '-';
  }

  // Cover letter score
  const coverBox = document.getElementById('aiCoverLetterBox');
  const coverScoreEl = document.getElementById('aiCoverLetterScore');
  const coverTab = document.getElementById('aiTabCover');

  if (coverData && coverData.score) {
    coverBox.style.display = 'block';
    coverTab.style.display = 'block';
    coverScoreEl.textContent = coverData.score;
    coverScoreEl.style.color = coverData.score <= 3 ? '#10b981' : coverData.score <= 6 ? '#f59e0b' : '#ef4444';
  } else {
    // Show N/A for no cover letter
    coverBox.style.display = 'block';
    coverScoreEl.textContent = 'N/A';
    coverScoreEl.style.color = '#666';
    coverTab.style.display = 'none';
    coverTab.style.display = 'none';
  }

  // Verdict
  let verdict = '';
  if (resumeData && resumeData.verdict) verdict = 'Resume: ' + resumeData.verdict;
  if (coverData && coverData.verdict) verdict += (verdict ? ' | ' : '') + 'Cover: ' + coverData.verdict;
  if (!verdict) verdict = 'No analysis results available';
  document.getElementById('aiCheckVerdict').textContent = verdict;

  // Resume details
  if (resumeData) {
    document.getElementById('aiCheckRedFlags').innerHTML =
      (resumeData.redFlags || []).length > 0
        ? resumeData.redFlags.map(f => `<li style="margin-bottom:6px">â€¢ ${f}</li>`).join('')
        : '<li style="color:#888">None detected</li>';
    document.getElementById('aiCheckHuman').innerHTML =
      (resumeData.humanElements || []).length > 0
        ? resumeData.humanElements.map(h => `<li style="margin-bottom:6px">â€¢ ${h}</li>`).join('')
        : '<li style="color:#888">None detected</li>';
    document.getElementById('aiCheckSuggestions').innerHTML =
      (resumeData.suggestions || []).length > 0
        ? resumeData.suggestions.map(s => `<li style="margin-bottom:6px">â€¢ ${s}</li>`).join('')
        : '<li style="color:#888">No suggestions</li>';
  }

  // Cover letter details
  if (coverData) {
    document.getElementById('aiCheckRedFlagsCover').innerHTML =
      (coverData.redFlags || []).length > 0
        ? coverData.redFlags.map(f => `<li style="margin-bottom:6px">â€¢ ${f}</li>`).join('')
        : '<li style="color:#888">None detected</li>';
    document.getElementById('aiCheckHumanCover').innerHTML =
      (coverData.humanElements || []).length > 0
        ? coverData.humanElements.map(h => `<li style="margin-bottom:6px">â€¢ ${h}</li>`).join('')
        : '<li style="color:#888">None detected</li>';
    document.getElementById('aiCheckSuggestionsCover').innerHTML =
      (coverData.suggestions || []).length > 0
        ? coverData.suggestions.map(s => `<li style="margin-bottom:6px">â€¢ ${s}</li>`).join('')
        : '<li style="color:#888">No suggestions</li>';
  }

  // Show resume tab by default
  showAITab('resume');
}

function showAITab(tab) {
  const resumeDetails = document.getElementById('aiResumeDetails');
  const coverDetails = document.getElementById('aiCoverDetails');
  const resumeTab = document.getElementById('aiTabResume');
  const coverTab = document.getElementById('aiTabCover');

  if (tab === 'resume') {
    resumeDetails.style.display = 'block';
    coverDetails.style.display = 'none';
    resumeTab.style.background = 'linear-gradient(135deg,#6366f1,#8b5cf6)';
    coverTab.style.background = '#333';
  } else {
    resumeDetails.style.display = 'none';
    coverDetails.style.display = 'block';
    resumeTab.style.background = '#333';
    coverTab.style.background = 'linear-gradient(135deg,#6366f1,#8b5cf6)';
  }
}

async function saveAIScores() {
  if (!currentUser || !state.currentResumeDetail) {
    alert('Please log in to save scores');
    return;
  }

  const resumeId = state.currentResumeDetail.id;
  const aiScores = {
    resume: currentAIResults.resume?.score || null,
    coverLetter: currentAIResults.coverLetter?.score || null
  };

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        aiScores
      })
    });

    if (!res.ok) throw new Error('Failed to save scores');

    alert('AI scores saved to library!');
    loadLibrary();
  } catch (e) {
    alert('Error saving scores: ' + e.message);
  }
}

function checkAIFromDetail(type) {
  checkAIBoth();
}

async function checkAIWithText(text, typeName) {
  currentAIResults = { resume: null, coverLetter: null };

  const modal = document.getElementById('aiCheckModal');
  const loading = document.getElementById('aiCheckLoading');
  const results = document.getElementById('aiCheckResults');

  modal.classList.add('active');
  loading.style.display = 'block';
  results.style.display = 'none';

  try {
    const res = await fetch('/api/ai-check', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, type: typeName })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Check failed');

    if (typeName === 'resume' || typeName === 'Q&A answer') {
      currentAIResults.resume = data;
    } else {
      currentAIResults.coverLetter = data;
    }

    displayAIResults(false);
    results.style.display = 'block';

  } catch (e) {
    alert('Error checking AI: ' + e.message);
    modal.classList.remove('active');
  } finally {
    loading.style.display = 'none';
  }
}

async function updateResumeStatus(resumeId) {
  if (!currentUser) return;

  const status = document.getElementById('resumeStatusSelect').value;

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        status
      })
    });

    if (!res.ok) throw new Error('Failed to update status');

    loadLibrary();
    updateDashboard();
  } catch (e) {
    alert('Error updating status: ' + e.message);
  }
}

async function saveResumeNotes(resumeId) {
  if (!currentUser) return;

  const notes = document.getElementById('resumeNotes').value;

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        notes
      })
    });

    if (!res.ok) throw new Error('Failed to save notes');

    alert('Notes saved!');
  } catch (e) {
    alert('Error saving notes: ' + e.message);
  }
}

async function saveResumeJobUrl(resumeId) {
  if (!currentUser) return;

  const jobUrl = document.getElementById('resumeJobUrl').value;

  try {
    const res = await fetch('/api/applications/update', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId,
        jobUrl
      })
    });

    if (!res.ok) throw new Error('Failed to save URL');

    alert('Job URL saved!');
    loadLibrary(); // Refresh library to show updated URL
  } catch (e) {
    alert('Error saving URL: ' + e.message);
  }
}

async function deleteResume(resumeId) {
  if (!currentUser) return;

  if (!confirm('Are you sure you want to delete this resume? This cannot be undone.')) {
    return;
  }

  try {
    const res = await fetch('/api/resumes/delete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        resumeId
      })
    });

    if (!res.ok) throw new Error('Failed to delete');

    closeResumeDetail();
    loadLibrary();
    updateDashboard();
  } catch (e) {
    alert('Error deleting resume: ' + e.message);
  }
}

// Auto-save on input change
function setupAutoSave() {
  // Profile fields
  ['fullName', 'email', 'phone', 'location', 'linkedin', 'github', 'portfolio', 'summary'].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', () => {
        state.profile[id] = el.value;
        localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
        showSaveStatus();
      });
    }
  });
}

function showSaveStatus() {
  const status = document.getElementById('saveStatus');
  if (status) {
    status.textContent = 'Saved!';
    setTimeout(() => { status.textContent = ''; }, 2000);
  }
}

// Parse resume with AI
async function parseResumeWithAI() {
  const text = document.getElementById('importResume').value.trim();
  if (!text) {
    alert('Please paste your resume text first');
    return;
  }

  const status = document.getElementById('parseStatus');
  status.textContent = 'Parsing with AI...';

  try {
    const res = await fetch('/api/parse', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ resumeText: text })
    });

    if (!res.ok) throw new Error('Parse failed: ' + res.status);

    const data = await res.json();

    // Fill in profile fields
    if (data.profile) {
      Object.keys(data.profile).forEach(key => {
        const el = document.getElementById(key);
        if (el && data.profile[key]) {
          el.value = data.profile[key];
          state.profile[key] = data.profile[key];
        }
      });
      localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
    }

    // Add experience
    if (data.experience && data.experience.length > 0) {
      state.experience = data.experience;
      localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
      renderExperience();
    }

    // Add education
    if (data.education && data.education.length > 0) {
      state.education = data.education;
      localStorage.setItem('resumeEducation', JSON.stringify(state.education));
      renderEducation();
    }

    // Add skills
    if (data.skills) {
      state.skills = { ...state.skills, ...data.skills };
      localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
      renderSkills();
    }

    status.textContent = 'Parsed successfully!';
    document.getElementById('resumeTextModal').classList.remove('active');
    saveUserData();
    setTimeout(() => { status.textContent = ''; }, 3000);

  } catch (e) {
    status.textContent = 'Error: ' + e.message;
  }
}

// Google OAuth
const GOOGLE_CLIENT_ID = '507770918834-2u3pd286qbnrars3vnmnms9i1sdmr952.apps.googleusercontent.com';
let currentUser = null;

async function loginWithGoogle() {
  const client = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: 'email profile',
    callback: async (response) => {
      if (response.access_token) {
        const userRes = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
          headers: { Authorization: 'Bearer ' + response.access_token }
        });
        const user = await userRes.json();
        currentUser = user;
        localStorage.setItem('user', JSON.stringify(user));
        updateAuthUI();
        loadUserData();
        updateDashboard();
      }
    }
  });
  client.requestAccessToken();
}

function logout() {
  currentUser = null;
  localStorage.removeItem('user');
  updateAuthUI();
  updateDashboard();
}

function updateAuthUI() {
  const authSection = document.getElementById('authSection');
  const userInfo = document.getElementById('userInfo');
  const userName = document.getElementById('userName');

  if (currentUser) {
    authSection.style.display = 'none';
    userInfo.style.display = 'block';
    userName.textContent = currentUser.name || currentUser.email;
  } else {
    authSection.style.display = 'block';
    userInfo.style.display = 'none';
  }
}

async function loadUserData() {
  if (!currentUser) return;
  try {
    const res = await fetch('/api/user/load?email=' + encodeURIComponent(currentUser.email));
    if (res.ok) {
      const data = await res.json();
      if (data.profile) state.profile = data.profile;
      if (data.experience) state.experience = data.experience;
      if (data.education) state.education = data.education;
      if (data.certs) state.certs = data.certs;
      if (data.skills) state.skills = data.skills;
      if (data.projects) state.projects = data.projects;
      if (data.instructionPresets) state.instructionPresets = data.instructionPresets;
      if (data.questionPresets) state.questionPresets = data.questionPresets;
      if (data.featurePresets) state.featurePresets = data.featurePresets;

      // Persist cloud data to localStorage so it survives page refreshes on any device
      localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
      localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
      localStorage.setItem('resumeEducation', JSON.stringify(state.education));
      localStorage.setItem('resumeCerts', JSON.stringify(state.certs));
      localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
      localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
      localStorage.setItem('instructionPresets', JSON.stringify(state.instructionPresets));
      localStorage.setItem('questionPresets', JSON.stringify(state.questionPresets));
      localStorage.setItem('featurePresets', JSON.stringify(state.featurePresets));

      loadProfile();
      renderExperience();
      renderEducation();
      renderCerts();
      renderSkills();
      renderProjects();
      loadInstructionPresets();
      loadQuestionPresets();
    }
  } catch (e) {
    console.log('No saved data found');
  }
}

async function saveUserData() {
  if (!currentUser) return;
  try {
    await fetch('/api/user/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        email: currentUser.email,
        profile: state.profile,
        experience: state.experience,
        education: state.education,
        certs: state.certs,
        skills: state.skills,
        projects: state.projects,
        instructionPresets: state.instructionPresets,
        questionPresets: state.questionPresets,
        featurePresets: state.featurePresets
      })
    });
  } catch (e) {
    console.error('Save failed:', e);
  }
}

// Export for browser extension
function exportForExtension() {
  const profile = state.profile || {};
  const extensionData = {
    fullName: profile.fullName || '',
    email: profile.email || '',
    phone: profile.phone || '',
    location: profile.location || '',
    linkedin: profile.linkedin || '',
    website: profile.github || profile.portfolio || '',
    workAuth: 'yes',
    sponsorship: 'no'
  };

  const jsonStr = JSON.stringify(extensionData);
  navigator.clipboard.writeText(jsonStr).then(() => {
    const status = document.getElementById('importStatus');
    status.innerHTML = '<strong>Copied!</strong> Go to extension â†’ My Profile â†’ click "Import from Clipboard"';
    setTimeout(() => status.textContent = '', 5000);
  }).catch(() => {
    prompt('Copy this data manually:', jsonStr);
  });
}

// LinkedIn ZIP Parser
async function parseLinkedInZip(file) {
  if (!file) return;
  const status = document.getElementById('importStatus');
  status.textContent = 'Reading LinkedIn data...';

  try {
    const JSZip = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
    const zip = await JSZip.default.loadAsync(file);

    let profileData = {};
    let positions = [];
    let education = [];
    let skills = [];

    // Parse Profile.csv
    const profileFile = zip.file(/Profile\.csv/i)[0];
    if (profileFile) {
      const text = await profileFile.async('text');
      const lines = text.split('\n');
      if (lines.length > 1) {
        const headers = parseCSVLine(lines[0]);
        const values = parseCSVLine(lines[1]);
        headers.forEach((h, i) => {
          if (h.toLowerCase().includes('first')) profileData.firstName = values[i];
          if (h.toLowerCase().includes('last')) profileData.lastName = values[i];
          if (h.toLowerCase().includes('headline')) profileData.summary = values[i];
          if (h.toLowerCase().includes('email')) profileData.email = values[i];
        });
      }
    }

    // Parse Positions.csv
    const positionsFile = zip.file(/Positions\.csv/i)[0];
    if (positionsFile) {
      const text = await positionsFile.async('text');
      const lines = text.split('\n');
      if (lines.length > 1) {
        const headers = parseCSVLine(lines[0]);
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const pos = {};
          headers.forEach((h, idx) => {
            const hl = h.toLowerCase();
            if (hl.includes('company')) pos.company = values[idx];
            if (hl.includes('title')) pos.title = values[idx];
            if (hl.includes('description')) pos.description = values[idx];
            if (hl.includes('location')) pos.location = values[idx];
            if (hl.includes('started on')) pos.start = values[idx];
            if (hl.includes('finished on')) pos.end = values[idx];
          });
          if (pos.company || pos.title) positions.push(pos);
        }
      }
    }

    // Parse Education.csv
    const eduFile = zip.file(/Education\.csv/i)[0];
    if (eduFile) {
      const text = await eduFile.async('text');
      const lines = text.split('\n');
      if (lines.length > 1) {
        const headers = parseCSVLine(lines[0]);
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = parseCSVLine(lines[i]);
          const edu = {};
          headers.forEach((h, idx) => {
            const hl = h.toLowerCase();
            if (hl.includes('school')) edu.school = values[idx];
            if (hl.includes('degree')) edu.degree = values[idx];
            if (hl.includes('start')) edu.start = values[idx];
            if (hl.includes('end')) edu.end = values[idx];
          });
          if (edu.school) education.push(edu);
        }
      }
    }

    // Parse Skills.csv
    const skillsFile = zip.file(/Skills\.csv/i)[0];
    if (skillsFile) {
      const text = await skillsFile.async('text');
      const lines = text.split('\n');
      for (let i = 1; i < lines.length; i++) {
        const skill = lines[i].trim().replace(/"/g, '');
        if (skill) skills.push(skill);
      }
    }

    // Apply to state
    if (profileData.firstName) {
      state.profile.fullName = (profileData.firstName + ' ' + (profileData.lastName || '')).trim();
    }
    if (profileData.email) state.profile.email = profileData.email;
    if (profileData.summary) state.profile.summary = profileData.summary;
    loadProfile();

    if (positions.length > 0) {
      state.experience = positions.map(p => ({
        title: p.title || '',
        company: p.company || '',
        location: p.location || '',
        start: p.start || '',
        end: p.end || '',
        bullets: p.description ? p.description.split(/[.;]\s+/).filter(b => b.trim()) : []
      }));
      localStorage.setItem('resumeExperience', JSON.stringify(state.experience));
      renderExperience();
    }

    if (education.length > 0) {
      state.education = education.map(e => ({
        degree: e.degree || '',
        school: e.school || '',
        start: e.start || '',
        end: e.end || '',
        location: '',
        gpa: '',
        extras: ''
      }));
      localStorage.setItem('resumeEducation', JSON.stringify(state.education));
      renderEducation();
    }

    if (skills.length > 0) {
      state.skills.technical = [...new Set([...state.skills.technical, ...skills])];
      localStorage.setItem('resumeSkills', JSON.stringify(state.skills));
      renderSkills();
    }

    localStorage.setItem('resumeProfile', JSON.stringify(state.profile));
    status.textContent = 'LinkedIn data imported! Found ' + positions.length + ' positions, ' + education.length + ' education, ' + skills.length + ' skills';
    saveUserData();

  } catch (e) {
    status.textContent = 'Error parsing ZIP: ' + e.message;
    console.error(e);
  }
}

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }
  result.push(current.trim());
  return result;
}

// ============ Interview Practice Functions ============

// Interview state
const interviewState = {
  active: false,
  jobContext: '',
  totalQuestions: 5,
  currentIndex: 0,
  questions: [],
  answers: [],
  scores: [],
  recognition: null,
  isRecording: false,
  synthesis: window.speechSynthesis
};

// Check for speech recognition support
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasSpeechRecognition = !!SpeechRecognition;

// Show browser warning if needed
function checkInterviewBrowserSupport() {
  const warning = document.getElementById('browserWarning');
  if (!hasSpeechRecognition && warning) {
    warning.style.display = 'block';
  }
}

// Start a new interview session
async function startInterviewSession() {
  const jobContext = document.getElementById('interviewJobContext').value.trim();
  if (!jobContext) {
    alert('Please enter a job description or interview context');
    return;
  }

  interviewState.active = true;
  interviewState.jobContext = jobContext;
  interviewState.totalQuestions = parseInt(document.getElementById('interviewQuestionCount').value);
  interviewState.currentIndex = 0;
  interviewState.questions = [];
  interviewState.answers = [];
  interviewState.scores = [];

  // Hide setup, show active
  document.getElementById('interviewSetup').classList.add('hidden');
  document.getElementById('interviewActive').classList.add('active');
  document.getElementById('sessionSummary').style.display = 'none';

  // Generate first question
  await generateInterviewQuestion();
}

// Generate next interview question
async function generateInterviewQuestion() {
  const questionCard = document.getElementById('questionCard');
  questionCard.style.opacity = '0.5';
  document.getElementById('questionText').textContent = 'Generating question...';

  try {
    const res = await fetch('/api/interview-questions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        jobDescription: interviewState.jobContext,
        profile: state.profile,
        experience: state.experience,
        skills: state.skills,
        projects: state.projects,
        questionNumber: interviewState.currentIndex + 1,
        previousQuestions: interviewState.questions
      })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Failed to generate question');

    interviewState.questions.push(data.question);

    // Update UI
    document.getElementById('questionNumber').textContent =
      `Question ${interviewState.currentIndex + 1} of ${interviewState.totalQuestions}`;
    document.getElementById('questionText').textContent = data.question;
    document.getElementById('questionType').textContent = data.type || 'behavioral';
    document.getElementById('questionTime').textContent = `Suggested: ${data.timeHint || '1-2 minutes'}`;
    document.getElementById('questionTip').textContent = data.tip ? `Tip: ${data.tip}` : '';

    // Reset answer area
    document.getElementById('transcriptArea').textContent = 'Click "Record Answer" to speak, or type your response below...';
    document.getElementById('transcriptArea').classList.add('empty');
    document.getElementById('answerInput').value = '';
    document.getElementById('feedbackCard').style.display = 'none';
    document.getElementById('hintCard').style.display = 'none';
    document.getElementById('submitAnswerBtn').disabled = false;

    questionCard.style.opacity = '1';

  } catch (e) {
    alert('Error generating question: ' + e.message);
    questionCard.style.opacity = '1';
  }
}

// Text-to-speech for the question
function speakQuestion() {
  const text = document.getElementById('questionText').textContent;
  if (!text || text === 'Loading question...' || text === 'Generating question...') return;

  const btn = document.getElementById('speakBtn');
  const btnText = document.getElementById('speakBtnText');

  // Stop any ongoing speech
  if (interviewState.synthesis.speaking) {
    interviewState.synthesis.cancel();
    btn.classList.remove('speaking');
    btnText.textContent = 'Hear Question';
    return;
  }

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.rate = 0.9;
  utterance.pitch = 1;

  utterance.onstart = () => {
    btn.classList.add('speaking');
    btnText.textContent = 'Stop';
  };

  utterance.onend = () => {
    btn.classList.remove('speaking');
    btnText.textContent = 'Hear Question';
  };

  utterance.onerror = () => {
    btn.classList.remove('speaking');
    btnText.textContent = 'Hear Question';
  };

  interviewState.synthesis.speak(utterance);
}

// Toggle voice recording
function toggleRecording() {
  if (!hasSpeechRecognition) {
    alert('Voice recording is not supported in your browser. Please type your answer instead.');
    return;
  }

  if (interviewState.isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

// Start voice recording
function startRecording() {
  if (!hasSpeechRecognition) return;

  const recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = 'en-US';

  const transcriptArea = document.getElementById('transcriptArea');
  const recordBtn = document.getElementById('recordBtn');
  const recordBtnText = document.getElementById('recordBtnText');
  const recordingStatus = document.getElementById('recordingStatus');

  let finalTranscript = document.getElementById('answerInput').value;

  recognition.onstart = () => {
    interviewState.isRecording = true;
    recordBtn.classList.add('recording');
    recordBtnText.textContent = 'Stop Recording';
    transcriptArea.classList.remove('empty');
    transcriptArea.classList.add('recording');
    recordingStatus.textContent = 'â— Recording...';
  };

  recognition.onresult = (event) => {
    let interimTranscript = '';
    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        finalTranscript += transcript + ' ';
      } else {
        interimTranscript += transcript;
      }
    }
    transcriptArea.textContent = finalTranscript + interimTranscript;
    document.getElementById('answerInput').value = finalTranscript.trim();
  };

  recognition.onerror = (event) => {
    console.error('Speech recognition error:', event.error);
    if (event.error !== 'aborted') {
      recordingStatus.textContent = 'Error: ' + event.error;
    }
    stopRecording();
  };

  recognition.onend = () => {
    if (interviewState.isRecording) {
      // Restart if still supposed to be recording
      try {
        recognition.start();
      } catch (e) {
        stopRecording();
      }
    }
  };

  try {
    recognition.start();
    interviewState.recognition = recognition;
  } catch (e) {
    alert('Could not start recording: ' + e.message);
  }
}

// Stop voice recording
function stopRecording() {
  if (interviewState.recognition) {
    interviewState.isRecording = false;
    interviewState.recognition.stop();
    interviewState.recognition = null;
  }

  const recordBtn = document.getElementById('recordBtn');
  const recordBtnText = document.getElementById('recordBtnText');
  const recordingStatus = document.getElementById('recordingStatus');
  const transcriptArea = document.getElementById('transcriptArea');

  recordBtn.classList.remove('recording');
  recordBtnText.textContent = 'Record Answer';
  recordingStatus.textContent = '';
  transcriptArea.classList.remove('recording');
}

// Submit answer for feedback
async function submitAnswer() {
  const answer = document.getElementById('answerInput').value.trim() ||
                 document.getElementById('transcriptArea').textContent.trim();

  if (!answer || answer === 'Click "Record Answer" to speak, or type your response below...') {
    alert('Please provide an answer first');
    return;
  }

  // Stop recording if active
  if (interviewState.isRecording) {
    stopRecording();
  }

  const currentQuestion = interviewState.questions[interviewState.currentIndex];
  interviewState.answers.push(answer);

  document.getElementById('submitAnswerBtn').disabled = true;
  document.getElementById('feedbackLoading').classList.add('active');
  document.getElementById('feedbackCard').style.display = 'none';

  try {
    const res = await fetch('/api/interview-feedback', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: currentQuestion,
        answer: answer,
        jobDescription: interviewState.jobContext,
        profile: state.profile,
        experience: state.experience,
        skills: state.skills,
        projects: state.projects
      })
    });

    if (!res.ok) throw new Error('Failed to get feedback');

    const data = await res.json();
    interviewState.scores.push(data.score);

    // Display feedback
    showFeedback(data);

  } catch (e) {
    alert('Error getting feedback: ' + e.message);
    document.getElementById('submitAnswerBtn').disabled = false;
  } finally {
    document.getElementById('feedbackLoading').classList.remove('active');
  }
}

// Display feedback
function showFeedback(data) {
  const feedbackCard = document.getElementById('feedbackCard');
  const scoreEl = document.getElementById('feedbackScore');

  // Score with color
  scoreEl.textContent = data.score + '/100';
  scoreEl.className = 'feedback-score';
  if (data.score >= 75) scoreEl.classList.add('high');
  else if (data.score >= 50) scoreEl.classList.add('medium');
  else scoreEl.classList.add('low');

  // Overall feedback
  document.getElementById('feedbackOverall').textContent = data.overallFeedback || '';

  // Strengths
  const strengthsList = document.getElementById('feedbackStrengths');
  strengthsList.innerHTML = (data.strengths || []).map(s =>
    `<li><span class="strength-icon">âœ“</span> ${s}</li>`
  ).join('') || '<li>No specific strengths noted</li>';

  // Improvements
  const improvementsList = document.getElementById('feedbackImprovements');
  improvementsList.innerHTML = (data.improvements || []).map(i =>
    `<li><span class="improve-icon">â–³</span> ${i}</li>`
  ).join('') || '<li>No specific improvements noted</li>';

  // Example answer
  const exampleSection = document.getElementById('feedbackExample');
  if (data.exampleAnswer) {
    document.getElementById('feedbackExampleText').textContent = data.exampleAnswer;
    exampleSection.style.display = 'block';
  } else {
    exampleSection.style.display = 'none';
  }

  // Update next button
  const nextBtn = document.getElementById('nextQuestionBtn');
  if (interviewState.currentIndex >= interviewState.totalQuestions - 1) {
    nextBtn.textContent = 'Finish Session';
    nextBtn.onclick = endSession;
  } else {
    nextBtn.textContent = 'Next Question';
    nextBtn.onclick = nextQuestion;
  }

  feedbackCard.style.display = 'block';
}

// Get hint for current question
async function getAnswerHint() {
  const currentQuestion = interviewState.questions[interviewState.currentIndex];
  if (!currentQuestion) return;

  const hintBtn = document.getElementById('hintBtn');
  const hintCard = document.getElementById('hintCard');
  const hintContent = document.getElementById('hintContent');

  hintBtn.disabled = true;
  hintBtn.textContent = 'Thinking...';
  hintCard.style.display = 'none';

  try {
    const res = await fetch('/api/interview-hint', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: currentQuestion,
        jobDescription: interviewState.jobContext,
        profile: state.profile,
        experience: state.experience,
        skills: state.skills,
        projects: state.projects
      })
    });

    if (!res.ok) throw new Error('Failed to get hint');

    const data = await res.json();

    hintContent.innerHTML = data.hints.map(h => `â€¢ ${h}`).join('<br>');
    hintCard.style.display = 'block';

  } catch (e) {
    alert('Error getting hint: ' + e.message);
  } finally {
    hintBtn.disabled = false;
    hintBtn.innerHTML = 'ðŸ’¡ Get Hint';
  }
}

// Skip current question
function skipQuestion() {
  if (confirm('Skip this question? It won\'t count towards your score.')) {
    if (interviewState.currentIndex >= interviewState.totalQuestions - 1) {
      endSession();
    } else {
      nextQuestion();
    }
  }
}

// Move to next question
async function nextQuestion() {
  interviewState.currentIndex++;

  if (interviewState.currentIndex >= interviewState.totalQuestions) {
    endSession();
    return;
  }

  await generateInterviewQuestion();
}

// End the interview session
function endSession() {
  interviewState.active = false;

  // Stop any recording
  if (interviewState.isRecording) {
    stopRecording();
  }

  // Stop any speech
  if (interviewState.synthesis.speaking) {
    interviewState.synthesis.cancel();
  }

  // Calculate stats
  const answeredCount = interviewState.scores.length;
  const avgScore = answeredCount > 0
    ? Math.round(interviewState.scores.reduce((a, b) => a + b, 0) / answeredCount)
    : 0;

  // Generate summary feedback
  let summaryFeedback = '';
  if (avgScore >= 80) {
    summaryFeedback = 'Excellent performance! You demonstrated strong interview skills. Keep practicing to maintain this level.';
  } else if (avgScore >= 60) {
    summaryFeedback = 'Good effort! You have solid foundations. Focus on adding more specific examples and quantifiable results.';
  } else if (avgScore >= 40) {
    summaryFeedback = 'You\'re on the right track. Practice structuring your answers using the STAR method and include concrete examples.';
  } else {
    summaryFeedback = 'Keep practicing! Focus on preparing specific stories from your experience that you can adapt to different questions.';
  }

  // Show summary
  document.getElementById('interviewActive').classList.remove('active');
  document.getElementById('sessionSummary').style.display = 'block';
  document.getElementById('summaryQuestions').textContent = answeredCount;
  document.getElementById('summaryAvgScore').textContent = avgScore + '%';
  document.getElementById('summaryFeedback').textContent = summaryFeedback;
}

// Reset interview for new session
function resetInterview() {
  interviewState.active = false;
  interviewState.questions = [];
  interviewState.answers = [];
  interviewState.scores = [];
  interviewState.currentIndex = 0;

  document.getElementById('interviewSetup').classList.remove('hidden');
  document.getElementById('interviewActive').classList.remove('active');
  document.getElementById('sessionSummary').style.display = 'none';
}

// Initialize browser support check when tab is opened
document.querySelector('[data-tab="interview"]')?.addEventListener('click', checkInterviewBrowserSupport);

// Check for saved user on load
const savedUser = localStorage.getItem('user');
if (savedUser) {
  currentUser = JSON.parse(savedUser);
  updateAuthUI();
  loadUserData();
}

// Initialize
loadProfile();
renderExperience();
renderEducation();
renderCerts();
renderSkills();
renderProjects();
loadInstructionPresets();
loadQuestionPresets();
setupAutoSave();
updateDashboard();
checkInterviewBrowserSupport();
console.log('Claude Resume initialized v4');
</script>

<!-- Hidden PDF Template -->
<div id="pdfTemplate" style="display:none">
<div id="pdfContent" style="font-family:Arial,Helvetica,sans-serif;color:#1a1a1a;line-height:1.5;max-width:8.5in;margin:0 auto;padding:0;background:#fff">
<!-- Header -->
<div id="pdfHeader" style="text-align:center;padding-bottom:6px;margin-bottom:8px">
<h1 id="pdfName" style="font-size:24px;font-weight:700;color:#1a1a1a;margin:0 0 6px 0;background:none;-webkit-background-clip:unset;-webkit-text-fill-color:#1a1a1a"></h1>
<div id="pdfContact" style="font-size:11px;color:#4b5563"></div>
</div>
<!-- Summary -->
<div id="pdfSummarySection" style="margin-bottom:10px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:3px;margin:0 0 4px 0;page-break-after:avoid">Professional Summary</h2>
<p id="pdfSummary" style="font-size:11px;margin:4px 0 0 0;text-align:justify"></p>
</div>
<!-- Experience -->
<div id="pdfExperienceSection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:3px;margin:0 0 4px 0;page-break-after:avoid">Professional Experience</h2>
<div id="pdfExperience"></div>
</div>
<!-- Education -->
<div id="pdfEducationSection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:3px;margin:0 0 4px 0;page-break-after:avoid">Education</h2>
<div id="pdfEducation"></div>
</div>
<!-- Skills -->
<div id="pdfSkillsSection" style="margin-bottom:20px">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:3px;margin:0 0 4px 0;page-break-after:avoid">Skills</h2>
<p id="pdfSkills" style="font-size:11px;margin:0"></p>
</div>
<!-- Projects -->
<div id="pdfProjectsSection" style="margin-bottom:20px;display:none">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:3px;margin:0 0 4px 0;page-break-after:avoid">Projects</h2>
<div id="pdfProjects"></div>
</div>
<!-- Certifications -->
<div id="pdfCertsSection" style="margin-bottom:20px;display:none">
<h2 style="font-size:14px;font-weight:700;color:#2563eb;text-transform:uppercase;border-bottom:1px solid #e5e7eb;padding-bottom:3px;margin:0 0 4px 0;page-break-after:avoid">Certifications</h2>
<div id="pdfCerts"></div>
</div>
</div>
</div>

<!-- Hidden Cover Letter PDF Template -->
<div id="coverLetterPdfTemplate" style="display:none">
<div id="coverLetterPdfContent" style="font-family:Arial,Helvetica,sans-serif;color:#1a1a1a;line-height:1.6;max-width:8.5in;margin:0 auto;padding:0.75in 1in;background:#fff">
<!-- Header -->
<div id="clPdfHeader" style="margin-bottom:30px">
<div id="clPdfName" style="font-size:18px;font-weight:700;color:#1a1a1a;margin-bottom:5px"></div>
<div id="clPdfContact" style="font-size:11px;color:#4b5563"></div>
</div>
<!-- Date -->
<div id="clPdfDate" style="font-size:11px;margin-bottom:25px"></div>
<!-- Recipient -->
<div id="clPdfRecipient" style="font-size:11px;margin-bottom:25px">
<div id="clPdfCompany" style="font-weight:600"></div>
<div id="clPdfPosition"></div>
</div>
<!-- Salutation -->
<div style="font-size:11px;margin-bottom:15px">Dear Hiring Manager,</div>
<!-- Body -->
<div id="clPdfBody" style="font-size:11px;text-align:justify"></div>
<!-- Closing -->
<div style="font-size:11px;margin-top:25px">
<div>Sincerely,</div>
<div style="margin-top:30px;font-weight:600" id="clPdfSignature"></div>
</div>
</div>
</div>

<script>
// ============ Resume Editor Functions ============

// Store parsed experience and projects data for editing
let editableExperience = [];
let editableProjects = [];

function openResumeEditor() {
  if (!state.lastGenerated || !state.lastGenerated.resume) {
    alert('Please generate a resume first');
    return;
  }

  // Parse the generated resume to extract editable sections
  const resumeText = state.lastGenerated.resume;

  // Extract summary (usually first paragraph after contact info)
  const summary = state.lastGenerated.tailoredSummary || state.profile.summary || '';
  document.getElementById('editSummary').value = summary;

  // Parse experience from the resume text
  editableExperience = parseExperienceFromResume(resumeText);
  renderEditableExperience();

  // Skills
  const allSkills = [
    ...(state.skills.technical || []),
    ...(state.skills.tools || [])
  ];
  document.getElementById('editSkills').value = allSkills.join(', ');

  // Projects - map from state.projects format, pre-select only first maxFeatures
  editableProjects = (state.projects || []).map(p => {
    const maxF = p.maxFeatures || 3;
    return {
      name: p.name || '',
      shortDesc: p.shortDesc || '',
      tech: p.tech || '',
      url: p.url || '',
      liveUrl: p.liveUrl || '',
      features: (p.features || []).slice(0, maxF),
      maxFeatures: maxF
    };
  });
  renderEditableProjects();

  document.getElementById('resumeEditorModal').classList.add('active');
}

function parseExperienceFromResume(resumeText) {
  const experiences = [];
  const lines = resumeText.split('\n');

  let currentExp = null;
  let inExperience = false;
  let skipSection = false;

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i].trim();

    // Detect section headers
    if (/^(EDUCATION|SKILLS|TECHNICAL\s+SKILLS|PROJECTS|CERTIFICATIONS)/i.test(line)) {
      if (currentExp && currentExp.bullets.length > 0) {
        experiences.push(currentExp);
        currentExp = null;
      }
      skipSection = true;
      inExperience = false;
      continue;
    }

    if (/^(EXPERIENCE|PROFESSIONAL\s+EXPERIENCE|WORK\s+EXPERIENCE)/i.test(line)) {
      inExperience = true;
      skipSection = false;
      continue;
    }

    if (skipSection) continue;

    // Look for job title patterns (Title at Company or Title | Company)
    const jobMatch = line.match(/^(.+?)\s+(?:at|@|\|)\s+(.+?)(?:\s*[\|,]\s*(.+))?$/i);
    if (jobMatch && !line.startsWith('â€¢') && !line.startsWith('-')) {
      if (currentExp && currentExp.bullets.length > 0) {
        experiences.push(currentExp);
      }
      currentExp = {
        title: jobMatch[1].trim(),
        company: jobMatch[2].trim(),
        dates: jobMatch[3] ? jobMatch[3].trim() : '',
        bullets: []
      };
      continue;
    }

    // Look for date line after company
    if (currentExp && !currentExp.dates && /\d{4}/.test(line) && line.length < 50) {
      currentExp.dates = line;
      continue;
    }

    // Collect bullet points
    if (currentExp && (line.startsWith('â€¢') || line.startsWith('-') || line.startsWith('*'))) {
      currentExp.bullets.push(line.replace(/^[â€¢\-\*]\s*/, ''));
    }
  }

  // Push last experience
  if (currentExp && currentExp.bullets.length > 0) {
    experiences.push(currentExp);
  }

  // If parsing failed, fall back to state.experience
  if (experiences.length === 0 && state.experience.length > 0) {
    return state.experience.map(exp => ({
      title: exp.title,
      company: exp.company,
      dates: formatExpDateRange(exp.start, exp.end),
      bullets: exp.bullets || []
    }));
  }

  return experiences;
}

function renderEditableExperience() {
  const container = document.getElementById('editExperienceList');

  container.innerHTML = editableExperience.map((exp, i) => `
    <div class="card" style="margin-bottom:15px;padding:15px;background:#16213e">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
        <div style="flex:1">
          <input type="text" value="${escapeHtml(exp.title)}"
                 onchange="editableExperience[${i}].title = this.value"
                 style="font-weight:600;margin-bottom:5px;width:100%"
                 placeholder="Job Title">
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <input type="text" value="${escapeHtml(exp.company)}"
                   onchange="editableExperience[${i}].company = this.value"
                   style="flex:1;min-width:150px"
                   placeholder="Company">
            <input type="text" value="${escapeHtml(exp.dates)}"
                   onchange="editableExperience[${i}].dates = this.value"
                   style="width:150px"
                   placeholder="Dates">
          </div>
        </div>
        <button onclick="removeEditableExp(${i})" class="danger small" style="margin-left:10px">&times;</button>
      </div>
      <label style="font-size:0.85em;color:#888">Bullet Points (one per line)</label>
      <textarea rows="4" style="font-size:0.9em"
                onchange="editableExperience[${i}].bullets = this.value.split('\\n').filter(b => b.trim())"
      >${exp.bullets.join('\n')}</textarea>
    </div>
  `).join('');

  // Add "Add Experience" buttons
  const savedExps = state.experience || [];
  container.innerHTML += `
    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center">
      <button onclick="addEditableExp()" class="secondary small">+ Add Experience</button>
      ${savedExps.length > 0 ? `
        <div style="position:relative;display:inline-block">
          <button onclick="toggleExpPicker()" class="small" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">+ From My Experience</button>
          <div id="expPickerDropdown" style="display:none;position:absolute;left:0;top:100%;margin-top:6px;background:#1a1a1a;border:1px solid #444;border-radius:8px;min-width:320px;max-height:250px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.5)">
            ${savedExps.map((exp, i) => `
              <div onclick="addExpFromSaved(${i})" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid #333;transition:background 0.15s"
                   onmouseover="this.style.background='#2a2a3e'" onmouseout="this.style.background='transparent'">
                <div style="font-weight:600;color:#fff;font-size:0.9em">${escapeHtml(exp.title)}</div>
                <div style="color:#888;font-size:0.8em">${escapeHtml(exp.company)} | ${formatExpDateRange(exp.start, exp.end)}</div>
                <div style="color:#666;font-size:0.75em;margin-top:2px">${exp.bullets.length} bullet point${exp.bullets.length !== 1 ? 's' : ''}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function removeEditableExp(index) {
  editableExperience.splice(index, 1);
  renderEditableExperience();
}

function addEditableExp() {
  editableExperience.push({
    title: '',
    company: '',
    dates: '',
    bullets: []
  });
  renderEditableExperience();
}

function renderEditableProjects() {
  const container = document.getElementById('editProjectsList');

  container.innerHTML = editableProjects.map((proj, i) => `
    <div class="card" style="margin-bottom:15px;padding:15px;background:#16213e">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
        <div style="flex:1">
          <input type="text" value="${escapeHtml(proj.name)}"
                 onchange="editableProjects[${i}].name = this.value"
                 style="font-weight:600;margin-bottom:5px;width:100%"
                 placeholder="Project Name">
          <input type="text" value="${escapeHtml(proj.tech)}"
                 onchange="editableProjects[${i}].tech = this.value"
                 style="margin-bottom:5px;width:100%;font-size:0.9em"
                 placeholder="Technologies (e.g., React, Node.js, AWS)">
        </div>
        <button onclick="removeEditableProject(${i})" class="danger small" style="margin-left:10px">&times;</button>
      </div>
      <textarea rows="2" style="font-size:0.9em;margin-bottom:8px"
                onchange="editableProjects[${i}].shortDesc = this.value"
                placeholder="Project description..."
      >${escapeHtml(proj.shortDesc)}</textarea>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
        <label style="font-size:0.85em;color:#888;margin:0">Key Features for PDF</label>
        <label style="font-size:0.8em;color:#888;display:flex;align-items:center;gap:4px;margin:0">
          Max:
          <input type="number" min="1" max="20" value="${proj.maxFeatures || 3}"
                 onchange="updateMaxFeatures(${i}, parseInt(this.value) || 3)"
                 style="width:50px;padding:4px 6px;font-size:0.9em;text-align:center">
        </label>
      </div>
      ${renderFeaturePresetChips(proj.name, i)}
      ${renderFeatureCheckboxes(proj, i)}
    </div>
  `).join('');

  // Add "Add Project" buttons
  const savedProjs = state.projects || [];
  container.innerHTML += `
    <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;align-items:center">
      <button onclick="addEditableProject()" class="secondary small">+ Add Project</button>
      ${savedProjs.length > 0 ? `
        <div style="position:relative;display:inline-block">
          <button onclick="toggleProjPicker()" class="small" style="background:linear-gradient(135deg,#6366f1,#8b5cf6)">+ From My Projects</button>
          <div id="projPickerDropdown" style="display:none;position:absolute;left:0;top:100%;margin-top:6px;background:#1a1a1a;border:1px solid #444;border-radius:8px;min-width:320px;max-height:250px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.5)">
            ${savedProjs.map((proj, i) => `
              <div onclick="addProjFromSaved(${i})" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid #333;transition:background 0.15s"
                   onmouseover="this.style.background='#2a2a3e'" onmouseout="this.style.background='transparent'">
                <div style="font-weight:600;color:#fff;font-size:0.9em">${escapeHtml(proj.name)}</div>
                <div style="color:#888;font-size:0.8em">${escapeHtml(proj.shortDesc || '')}</div>
                ${proj.tech ? `<div style="color:#60a5fa;font-size:0.75em;margin-top:2px">${escapeHtml(proj.tech)}</div>` : ''}
                <div style="color:#666;font-size:0.75em;margin-top:2px">${(proj.features || []).length} feature${(proj.features || []).length !== 1 ? 's' : ''}</div>
              </div>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

function removeEditableProject(index) {
  editableProjects.splice(index, 1);
  renderEditableProjects();
}

function addEditableProject() {
  editableProjects.push({
    name: '',
    shortDesc: '',
    tech: '',
    url: '',
    liveUrl: '',
    features: []
  });
  renderEditableProjects();
}

function toggleExpPicker() {
  const dd = document.getElementById('expPickerDropdown');
  const projDd = document.getElementById('projPickerDropdown');
  if (projDd) projDd.style.display = 'none';
  dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
}

function toggleProjPicker() {
  const dd = document.getElementById('projPickerDropdown');
  const expDd = document.getElementById('expPickerDropdown');
  if (expDd) expDd.style.display = 'none';
  dd.style.display = dd.style.display === 'none' ? 'block' : 'none';
}

function addExpFromSaved(index) {
  const exp = state.experience[index];
  if (!exp) return;
  editableExperience.push({
    title: exp.title,
    company: exp.company,
    dates: formatExpDateRange(exp.start, exp.end),
    bullets: [...(exp.bullets || [])]
  });
  renderEditableExperience();
}

function addProjFromSaved(index) {
  const proj = state.projects[index];
  if (!proj) return;
  const maxF = 3;
  editableProjects.push({
    name: proj.name || '',
    shortDesc: proj.shortDesc || '',
    tech: proj.tech || '',
    url: proj.url || '',
    liveUrl: proj.liveUrl || '',
    features: (proj.features || []).slice(0, maxF),
    maxFeatures: maxF
  });
  renderEditableProjects();
}

// Close picker dropdowns when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('#expPickerDropdown') && !e.target.closest('[onclick="toggleExpPicker()"]')) {
    const dd = document.getElementById('expPickerDropdown');
    if (dd) dd.style.display = 'none';
  }
  if (!e.target.closest('#projPickerDropdown') && !e.target.closest('[onclick="toggleProjPicker()"]')) {
    const dd = document.getElementById('projPickerDropdown');
    if (dd) dd.style.display = 'none';
  }
});

function getAllFeaturesForProject(projName) {
  const baseProj = state.projects.find(p => p.name === projName);
  return baseProj ? (baseProj.features || []) : [];
}

function renderFeatureCheckboxes(proj, projIdx) {
  const allFeatures = getAllFeaturesForProject(proj.name);
  const selected = proj.features || [];
  const maxFeatures = proj.maxFeatures || 3;
  const atMax = selected.length >= maxFeatures;

  if (allFeatures.length === 0) {
    return `<textarea rows="3" style="font-size:0.9em"
                onchange="editableProjects[${projIdx}].features = this.value.split('\\n').filter(f => f.trim())"
                placeholder="Real-time data sync&#10;User authentication&#10;Export to PDF"
      >${selected.join('\n')}</textarea>`;
  }

  return `<div id="featureCheckboxes-${projIdx}" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px">
    ${allFeatures.map(f => {
      const checked = selected.includes(f);
      const disabled = !checked && atMax;
      return `<label style="display:flex;align-items:start;gap:6px;font-size:0.85em;color:${disabled ? '#666' : '#ddd'};cursor:${disabled ? 'not-allowed' : 'pointer'};line-height:1.3">
        <input type="checkbox" ${checked ? 'checked' : ''} ${disabled ? 'disabled' : ''}
               onchange="toggleProjectFeature(${projIdx}, this, '${f.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}')"
               style="accent-color:#00ff88;width:auto;min-width:16px;margin-top:2px;flex-shrink:0">
        ${escapeHtml(f)}
      </label>`;
    }).join('')}
  </div>
  <button onclick="saveFeaturePreset(${projIdx})" class="secondary small" style="font-size:0.8em;padding:4px 10px">Save Selection as Preset</button>`;
}

function renderFeaturePresetChips(projName, projIdx) {
  const presets = (state.featurePresets[projName] || []);
  if (presets.length === 0) return '';

  return `<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">
    ${presets.map((preset, pIdx) => `
      <div style="display:inline-flex;align-items:center;gap:4px;background:#2a2a3e;padding:4px 10px;border-radius:16px;font-size:0.8em;cursor:pointer;border:1px solid #444;transition:all 0.2s"
           onmouseenter="this.style.borderColor='#00ff88'"
           onmouseleave="this.style.borderColor='#444'">
        <span onclick="loadFeaturePreset(${projIdx}, ${pIdx})" style="color:#ddd">${escapeHtml(preset.name)}</span>
        <span onclick="deleteFeaturePreset('${projName.replace(/\\/g, '\\\\').replace(/'/g, "\\'")}', ${pIdx})" style="color:#888;font-size:13px;padding:0 2px" title="Delete preset">&times;</span>
      </div>
    `).join('')}
  </div>`;
}

function updateMaxFeatures(projIdx, newMax) {
  const proj = editableProjects[projIdx];
  proj.maxFeatures = newMax;
  const allFeatures = getAllFeaturesForProject(proj.name);
  if (proj.features && proj.features.length > newMax) {
    // Trim if over the new max
    proj.features = proj.features.slice(0, newMax);
  } else if (proj.features && proj.features.length < newMax && allFeatures.length > 0) {
    // Auto-fill up to the new max from available features
    for (const f of allFeatures) {
      if (proj.features.length >= newMax) break;
      if (!proj.features.includes(f)) {
        proj.features.push(f);
      }
    }
  }
  // Sync to state.projects so PDF always has it and it persists
  const match = state.projects.find(p => p.name === proj.name);
  if (match) {
    match.maxFeatures = newMax;
    localStorage.setItem('resumeProjects', JSON.stringify(state.projects));
  }
  renderEditableProjects();
}

function toggleProjectFeature(projIdx, checkbox, featureText) {
  const proj = editableProjects[projIdx];
  const features = proj.features || [];
  const maxFeatures = proj.maxFeatures || 3;
  const idx = features.indexOf(featureText);

  if (idx >= 0) {
    features.splice(idx, 1);
  } else if (features.length < maxFeatures) {
    features.push(featureText);
  } else {
    checkbox.checked = false;
    return;
  }

  proj.features = features;
  renderEditableProjects();
}

function saveFeaturePreset(projIdx) {
  const proj = editableProjects[projIdx];
  if (!proj.features || proj.features.length === 0) {
    alert('Please select at least one feature first');
    return;
  }

  const name = prompt('Name this preset:');
  if (!name) return;

  if (!state.featurePresets[proj.name]) {
    state.featurePresets[proj.name] = [];
  }

  const existing = state.featurePresets[proj.name];
  const dupIdx = existing.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
  if (dupIdx >= 0) {
    if (!confirm('A preset with this name already exists. Replace it?')) return;
    existing[dupIdx] = { name, features: [...proj.features] };
  } else {
    existing.push({ name, features: [...proj.features] });
  }

  localStorage.setItem('featurePresets', JSON.stringify(state.featurePresets));
  saveUserData();
  renderEditableProjects();
  alert('Preset saved!' + (currentUser ? ' Synced to your account.' : ''));
}

function loadFeaturePreset(projIdx, presetIdx) {
  const proj = editableProjects[projIdx];
  const presets = state.featurePresets[proj.name] || [];
  if (!presets[presetIdx]) return;

  proj.features = [...presets[presetIdx].features];
  renderEditableProjects();
}

function deleteFeaturePreset(projName, presetIdx) {
  if (!confirm('Delete this preset?')) return;

  const presets = state.featurePresets[projName];
  if (!presets) return;

  presets.splice(presetIdx, 1);
  if (presets.length === 0) delete state.featurePresets[projName];

  localStorage.setItem('featurePresets', JSON.stringify(state.featurePresets));
  saveUserData();
  renderEditableProjects();
}

async function saveResumeEdits() {
  // Update the summary
  state.lastGenerated.tailoredSummary = document.getElementById('editSummary').value;

  // Rebuild the resume text from edited content
  let newResume = '';

  // Header
  const profile = state.profile;
  newResume += `${profile.fullName || 'Your Name'}\n`;
  newResume += [profile.email, profile.phone, profile.location].filter(Boolean).join(' | ') + '\n';
  if (profile.linkedin) newResume += profile.linkedin + '\n';
  if (profile.github) newResume += profile.github + '\n';
  newResume += '\n';

  // Summary
  const summary = document.getElementById('editSummary').value;
  if (summary) {
    newResume += 'PROFESSIONAL SUMMARY\n';
    newResume += summary + '\n\n';
  }

  // Experience
  if (editableExperience.length > 0) {
    newResume += 'PROFESSIONAL EXPERIENCE\n\n';
    editableExperience.forEach(exp => {
      newResume += `${exp.title} at ${exp.company}`;
      if (exp.dates) newResume += ` | ${exp.dates}`;
      newResume += '\n';
      exp.bullets.forEach(bullet => {
        newResume += `â€¢ ${bullet}\n`;
      });
      newResume += '\n';
    });
  }

  // Skills
  const skills = document.getElementById('editSkills').value;
  if (skills) {
    newResume += 'SKILLS\n';
    newResume += skills + '\n\n';
  }

  // Education
  if (state.education.length > 0) {
    newResume += 'EDUCATION\n';
    state.education.forEach(edu => {
      newResume += `${edu.degree} - ${edu.school}`;
      if (edu.start || edu.end) newResume += ` | ${formatExpDate(edu.start)} - ${formatExpDate(edu.end)}`;
      newResume += '\n';
    });
    newResume += '\n';
  }

  // Projects
  if (editableProjects.length > 0) {
    newResume += 'PROJECTS\n\n';
    editableProjects.forEach(proj => {
      if (proj.name) {
        newResume += `${proj.name}`;
        if (proj.tech) newResume += ` | ${proj.tech}`;
        newResume += '\n';
        if (proj.shortDesc) newResume += `${proj.shortDesc}\n`;
        newResume += '\n';
      }
    });
  }

  // Sync maxFeatures back to state.projects so PDF always respects it
  editableProjects.forEach(ep => {
    const match = state.projects.find(p => p.name === ep.name);
    if (match) {
      match.maxFeatures = ep.maxFeatures || 3;
    }
  });
  localStorage.setItem('resumeProjects', JSON.stringify(state.projects));

  // Update state
  state.lastGenerated.resume = newResume;
  state.lastGenerated.editedExperience = editableExperience;
  state.lastGenerated.editedProjects = editableProjects;
  state.lastGenerated.tailoredSummary = document.getElementById('editSummary').value;

  // Update the display
  const resumeOutput = document.getElementById('resumeOutput');
  if (resumeOutput) resumeOutput.textContent = newResume;

  // Also update library display if open
  const libraryContent = document.getElementById('libraryResumeContent');
  if (libraryContent) libraryContent.textContent = newResume;

  // Persist to database if this is a library resume
  if (currentUser && state.currentResumeDetail && state.currentResumeDetail.id) {
    try {
      const res = await fetch('/api/applications/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: currentUser.email,
          resumeId: state.currentResumeDetail.id,
          resume: newResume,
          tailoredSummary: state.lastGenerated.tailoredSummary
        })
      });
      if (!res.ok) throw new Error('Failed to save');
      state.currentResumeDetail.resume = newResume;
      state.currentResumeDetail.tailoredSummary = state.lastGenerated.tailoredSummary;
      showToast('Resume saved!', 'success', 2000);
    } catch (e) {
      console.error('Error saving resume edits:', e);
      alert('Resume updated locally but failed to save to server: ' + e.message);
    }
  } else {
    alert('Resume updated! You can now download the PDF.');
  }

  closeResumeEditor();
}

function closeResumeEditor() {
  document.getElementById('resumeEditorModal').classList.remove('active');
}

function downloadPDFFromEditor() {
  saveResumeEdits();
  downloadPDF();
}

// ============ Cover Letter Editor Functions ============

function openCoverLetterEditor() {
  if (!state.lastGenerated || !state.lastGenerated.coverLetter) {
    alert('Please generate a cover letter first');
    return;
  }

  document.getElementById('editCoverLetter').value = state.lastGenerated.coverLetter;
  document.getElementById('coverLetterEditorModal').classList.add('active');
}

async function saveCoverLetterEdits() {
  const editedLetter = document.getElementById('editCoverLetter').value;
  state.lastGenerated.coverLetter = editedLetter;

  // Update the display
  const coverLetterOutput = document.getElementById('coverLetterOutput');
  if (coverLetterOutput) coverLetterOutput.textContent = editedLetter;

  // Also update library display if open
  const libraryContent = document.getElementById('libraryCoverLetterContent');
  if (libraryContent) libraryContent.textContent = editedLetter;

  // Persist to database if this is a library resume
  if (currentUser && state.currentResumeDetail && state.currentResumeDetail.id) {
    try {
      const res = await fetch('/api/applications/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: currentUser.email,
          resumeId: state.currentResumeDetail.id,
          coverLetter: editedLetter
        })
      });
      if (!res.ok) throw new Error('Failed to save');
      state.currentResumeDetail.coverLetter = editedLetter;
      showToast('Cover letter saved!', 'success', 2000);
    } catch (e) {
      console.error('Error saving cover letter edits:', e);
      alert('Cover letter updated locally but failed to save to server: ' + e.message);
    }
  } else {
    alert('Cover letter updated!');
  }

  closeCoverLetterEditor();
}

function closeCoverLetterEditor() {
  document.getElementById('coverLetterEditorModal').classList.remove('active');
}

function downloadCoverLetterPDFFromEditor() {
  saveCoverLetterEdits();
  downloadCoverLetterPDF();
}

// ============ PDF Preview Functions ============

function previewPDF() {
  if (!state.lastGenerated || !state.lastGenerated.resume) {
    alert('Please generate a resume first');
    return;
  }

  // Populate the template
  populatePDFTemplate();

  // Clone the PDF content into preview
  const pdfContent = document.getElementById('pdfContent');
  const previewContent = document.getElementById('pdfPreviewContent');
  previewContent.innerHTML = pdfContent.innerHTML;

  // Copy styles
  previewContent.style.fontFamily = 'Arial, Helvetica, sans-serif';
  previewContent.style.color = '#1a1a1a';
  previewContent.style.lineHeight = '1.5';

  document.getElementById('pdfPreviewModal').classList.add('active');
}

function closePDFPreview() {
  document.getElementById('pdfPreviewModal').classList.remove('active');
}

// ============ Library Edit/Preview Functions ============

function editResumeFromLibrary() {
  const resume = state.currentResumeDetail;
  if (!resume || !resume.resume) {
    alert('No resume content to edit.');
    return;
  }

  // Set up lastGenerated with library data
  state.lastGenerated = {
    resume: resume.resume,
    tailoredSummary: resume.tailoredSummary,
    company: resume.company,
    title: resume.title,
    coverLetter: resume.coverLetter
  };

  openResumeEditor();
}

function previewPDFFromLibrary() {
  const resume = state.currentResumeDetail;
  if (!resume || !resume.resume) {
    alert('No resume content to preview.');
    return;
  }

  // Set up lastGenerated with library data
  state.lastGenerated = {
    resume: resume.resume,
    tailoredSummary: resume.tailoredSummary,
    company: resume.company,
    title: resume.title,
    coverLetter: resume.coverLetter
  };

  previewPDF();
}

function editCoverLetterFromLibrary() {
  const resume = state.currentResumeDetail;
  if (!resume || !resume.coverLetter) {
    alert('No cover letter content to edit.');
    return;
  }

  // Set up lastGenerated with library data
  state.lastGenerated = {
    ...state.lastGenerated,
    resume: resume.resume,
    coverLetter: resume.coverLetter,
    company: resume.company,
    title: resume.title
  };

  openCoverLetterEditor();
}

// Update library display after saving edits
function updateLibraryDisplay() {
  if (state.lastGenerated) {
    const resumeContent = document.getElementById('libraryResumeContent');
    if (resumeContent && state.lastGenerated.resume) {
      resumeContent.textContent = state.lastGenerated.resume;
    }
    const coverLetterContent = document.getElementById('libraryCoverLetterContent');
    if (coverLetterContent && state.lastGenerated.coverLetter) {
      coverLetterContent.textContent = state.lastGenerated.coverLetter;
    }
  }
}

function countPDFWords(resume) {
  // Count all words that actually appear in the PDF (not just the text blob)
  const parts = [];
  const profile = state.profile || {};
  if (profile.fullName) parts.push(profile.fullName);
  if (profile.email) parts.push(profile.email);
  if (profile.phone) parts.push(profile.phone);
  if (profile.location) parts.push(profile.location);
  const summary = (resume && resume.tailoredSummary) || profile.summary || '';
  if (summary) parts.push(summary);
  const exps = (resume && resume.editedExperience && resume.editedExperience.length > 0)
    ? resume.editedExperience
    : state.experience.map(e => ({ title: e.title, company: e.company, dates: `${e.start} ${e.end}`, bullets: e.bullets || [] }));
  exps.forEach(exp => {
    if (exp.title) parts.push(exp.title);
    if (exp.company) parts.push(exp.company);
    if (exp.dates) parts.push(exp.dates);
    (exp.bullets || []).forEach(b => parts.push(b));
  });
  state.education.forEach(edu => {
    if (edu.degree) parts.push(edu.degree);
    if (edu.school) parts.push(edu.school);
    if (edu.extras) parts.push(edu.extras);
  });
  const allSkills = [...(state.skills.technical || []), ...(state.skills.tools || [])];
  if (allSkills.length > 0) parts.push(allSkills.join(', '));
  const projs = (resume && resume.editedProjects && resume.editedProjects.length > 0)
    ? resume.editedProjects : state.projects;
  (projs || []).forEach(proj => {
    if (proj.name) parts.push(proj.name);
    if (proj.tech) parts.push(proj.tech);
    if (proj.shortDesc) parts.push(proj.shortDesc);
    const maxF = proj.maxFeatures || 3;
    (proj.features || []).slice(0, maxF).forEach(f => parts.push(f));
  });
  (state.certs || []).forEach(cert => {
    if (cert.name) parts.push(cert.name);
    if (cert.org) parts.push(cert.org);
  });
  return parts.join(' ').split(/\s+/).filter(w => w.length > 0).length;
}

// ============ PDF Export Functions (ATS-Friendly Text-Based) ============

function downloadPDF() {
  if (!state.lastGenerated || !state.lastGenerated.resume) {
    alert('Please generate a resume first');
    return;
  }

  try {
    const jsPDFClass = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
    if (!jsPDFClass) { alert('PDF library not loaded. Please refresh the page.'); return; }
    const doc = new jsPDFClass({ unit: 'pt', format: 'letter' });
    const pageW = doc.internal.pageSize.getWidth();   // 612
    const pageH = doc.internal.pageSize.getHeight();  // 792
    const mL = 40, mR = 40, mT = 36, mB = 36;
    const contentW = pageW - mL - mR;
    let y = mT;

    const generated = state.lastGenerated;
    const profile = state.profile;

    // Sanitize text for jsPDF (built-in fonts only support WinAnsi/Latin1)
    function sanitize(text) {
      if (!text) return '';
      return text
        .replace(/[\u2018\u2019\u201A]/g, "'")   // smart single quotes
        .replace(/[\u201C\u201D\u201E]/g, '"')    // smart double quotes
        .replace(/\u2026/g, '...')                 // ellipsis
        .replace(/[\u2013\u2014]/g, '-')           // en/em dash
        .replace(/\u2192/g, '->')                  // right arrow
        .replace(/\u2190/g, '<-')                  // left arrow
        .replace(/[\u2022\u2023\u25E6\u2043]/g, '-') // various bullets
        .replace(/[\u25B8\u25B9\u25BA\u25BB]/g, '-') // triangle bullets
        .replace(/\u2264/g, '<=')                  // less than or equal
        .replace(/\u2265/g, '>=')                  // greater than or equal
        .replace(/\u2260/g, '!=')                  // not equal
        .replace(/[\u00A0]/g, ' ')                 // non-breaking space
        .replace(/[^\x00-\xFF]/g, '');             // strip anything outside Latin1
    }

    function checkPage(needed) {
      if (y + needed > pageH - mB) { doc.addPage(); y = mT; }
    }

    function drawLine() {
      doc.setDrawColor(200, 200, 200);
      doc.setLineWidth(0.5);
      doc.line(mL, y, pageW - mR, y);
      y += 6;
    }

    function sectionHeader(title) {
      checkPage(20);
      y += 2;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(10);
      doc.setTextColor(37, 99, 235);
      doc.text(title.toUpperCase(), mL, y);
      y += 2;
      doc.setDrawColor(200, 210, 230);
      doc.setLineWidth(0.5);
      doc.line(mL, y, pageW - mR, y);
      y += 8;
      doc.setTextColor(30, 30, 30);
    }

    function wrappedText(text, x, fontSize, style, maxW, color) {
      if (!text) return;
      doc.setFont('helvetica', style || 'normal');
      doc.setFontSize(fontSize);
      if (color) doc.setTextColor(...color); else doc.setTextColor(30, 30, 30);
      const lines = doc.splitTextToSize(sanitize(text), maxW || contentW);
      const lineH = fontSize * 1.2;
      for (const line of lines) {
        checkPage(lineH);
        doc.text(line, x, y);
        y += lineH;
      }
    }

    // â”€â”€ NAME â”€â”€
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.setTextColor(30, 30, 30);
    const name = profile.fullName || 'Your Name';
    const nameW = doc.getTextWidth(name);
    doc.text(name, (pageW - nameW) / 2, y);
    y += 14;

    // â”€â”€ CONTACT INFO â”€â”€
    const contactParts = [];
    if (profile.email) contactParts.push(profile.email);
    if (profile.phone) contactParts.push(profile.phone);
    if (profile.location) contactParts.push(profile.location);
    if (profile.linkedin) contactParts.push(profile.linkedin.replace('https://', ''));
    if (profile.github) contactParts.push(profile.github.replace('https://', ''));
    if (contactParts.length > 0) {
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(9);
      doc.setTextColor(75, 85, 99);
      const contactStr = contactParts.join('  |  ');
      const contactW = doc.getTextWidth(contactStr);
      // If contact line is too wide, split into multiple lines
      if (contactW > contentW) {
        const cLines = doc.splitTextToSize(contactParts.join(' | '), contentW);
        for (const cl of cLines) {
          const clW = doc.getTextWidth(cl);
          doc.text(cl, (pageW - clW) / 2, y);
          y += 11;
        }
      } else {
        doc.text(contactStr, (pageW - contactW) / 2, y);
        y += 11;
      }

      // Add clickable links
      doc.setFontSize(9);
      let linkX = (pageW - contactW) / 2;
      contactParts.forEach((part, idx) => {
        const partW = doc.getTextWidth(part);
        const sepW = idx < contactParts.length - 1 ? doc.getTextWidth('  |  ') : 0;
        if (part.includes('@')) {
          doc.link(linkX, y - 18, partW, 12, { url: 'mailto:' + part });
        } else if (part.includes('linkedin.com')) {
          doc.link(linkX, y - 18, partW, 12, { url: 'https://' + part });
        } else if (part.includes('github.com')) {
          doc.link(linkX, y - 18, partW, 12, { url: 'https://' + part });
        }
        linkX += partW + sepW;
      });
    }
    y += 2;

    // â”€â”€ SUMMARY â”€â”€
    const summary = generated.tailoredSummary || profile.summary || '';
    if (summary) {
      sectionHeader('Professional Summary');
      wrappedText(summary, mL, 9.5, 'normal', contentW, [60, 60, 60]);
      y += 3;
    }

    // â”€â”€ EXPERIENCE â”€â”€
    let experiences = [];
    if (generated.editedExperience && generated.editedExperience.length > 0) {
      experiences = generated.editedExperience;
    } else if (state.experience.length > 0) {
      experiences = state.experience.map(exp => ({
        title: exp.title, company: exp.company,
        dates: formatExpDateRange(exp.start, exp.end),
        bullets: exp.bullets || []
      }));
    }
    if (experiences.length > 0) {
      sectionHeader('Professional Experience');
      experiences.forEach(exp => {
        checkPage(24);
        // Title â€” Company | Dates
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(30, 30, 30);
        const titleStr = sanitize(`${exp.title} - ${exp.company}`);
        doc.text(titleStr, mL, y);
        if (exp.dates) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9.5);
          doc.setTextColor(107, 114, 128);
          const datesStr = sanitize(exp.dates);
          const datesW = doc.getTextWidth(datesStr);
          doc.text(datesStr, pageW - mR - datesW, y);
        }
        y += 12;
        // Bullets
        (exp.bullets || []).forEach(bullet => {
          checkPage(11);
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9);
          doc.setTextColor(55, 55, 55);
          const cleanBullet = bullet.replace(/^[\-\u2022\u2023\u25E6â€¢*]\s*/, '');
          const bulletLines = doc.splitTextToSize(sanitize(cleanBullet), contentW - 12);
          bulletLines.forEach((bl, bIdx) => {
            checkPage(10);
            if (bIdx === 0) {
              doc.text('-', mL + 4, y);
            }
            doc.text(bl, mL + 12, y);
            y += 10;
          });
        });
        y += 3;
      });
    }

    // â”€â”€ EDUCATION â”€â”€
    if (state.education.length > 0) {
      sectionHeader('Education');
      state.education.forEach(edu => {
        checkPage(18);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(30, 30, 30);
        doc.text(sanitize(edu.degree || ''), mL, y);
        if (edu.start || edu.end) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(9.5);
          doc.setTextColor(107, 114, 128);
          const dateStr = sanitize(`${formatExpDate(edu.start)} - ${formatExpDate(edu.end)}`);
          const datesW = doc.getTextWidth(dateStr);
          doc.text(dateStr, pageW - mR - datesW, y);
        }
        y += 11;
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(75, 85, 99);
        let schoolLine = sanitize((edu.school || '') + (edu.location ? ', ' + edu.location : '') + (edu.gpa ? ' | GPA: ' + edu.gpa : ''));
        doc.text(schoolLine, mL, y);
        y += 11;
        if (edu.extras) {
          checkPage(12);
          doc.setFontSize(8.5);
          // Split text into segments: course codes bold, everything else normal
          const fullText = 'Relevant Courses: ' + edu.extras;
          const segments = [];
          let last = 0;
          const codeRe = /[A-Z]{2,5}\s*\d{3,5}[A-Z]?/g;
          let cm;
          while ((cm = codeRe.exec(fullText)) !== null) {
            if (cm.index > last) segments.push({ text: fullText.slice(last, cm.index), bold: false });
            segments.push({ text: cm[0], bold: true });
            last = cm.index + cm[0].length;
          }
          if (last < fullText.length) segments.push({ text: fullText.slice(last), bold: false });
          // Render segments with word wrapping
          let cx = mL;
          segments.forEach(seg => {
            doc.setFont('helvetica', seg.bold ? 'bold' : 'normal');
            const words = sanitize(seg.text).split(/(\s+)/);
            words.forEach(word => {
              if (!word) return;
              const ww = doc.getTextWidth(word);
              if (cx + ww > pageW - mR && word.trim()) {
                y += 10; checkPage(10); cx = mL;
              }
              doc.text(word, cx, y);
              cx += ww;
            });
          });
          y += 10;
        }
        y += 2;
      });
    }

    // â”€â”€ SKILLS â”€â”€
    const allSkills = [...(state.skills.technical || []), ...(state.skills.tools || [])];
    if (allSkills.length > 0) {
      sectionHeader('Skills');
      wrappedText(sanitize(allSkills.join(', ')), mL, 9, 'normal', contentW, [55, 55, 55]);
      y += 3;
    }

    // â”€â”€ PROJECTS â”€â”€
    const projectsToUse = (generated.editedProjects && generated.editedProjects.length > 0)
      ? generated.editedProjects : state.projects;
    const validProjects = (projectsToUse || []).filter(p => p.name);
    if (validProjects.length > 0) {
      sectionHeader('Projects');
      validProjects.forEach(proj => {
        checkPage(24);
        // Project name
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(30, 30, 30);
        const projNameText = sanitize(proj.name);
        doc.text(projNameText, mL, y);
        const projNameW = doc.getTextWidth(projNameText);
        // Tech - same line if fits, otherwise next line
        const techArr = (proj.tech || '').split(',').map(t => t.trim()).filter(t => t);
        if (techArr.length > 0) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8.5);
          doc.setTextColor(107, 114, 128);
          const availW = contentW - projNameW - 12;
          let techStr = sanitize(techArr.join(', '));
          // Truncate to fit on one line, drop items that don't fit
          while (techStr && doc.getTextWidth(techStr) > availW) {
            const lastComma = techStr.lastIndexOf(',');
            if (lastComma === -1) { techStr = ''; break; }
            techStr = techStr.substring(0, lastComma);
          }
          if (techStr) {
            const techW = doc.getTextWidth(techStr);
            doc.text(techStr, pageW - mR - techW, y);
          }
        }
        y += 11;
        // Links
        const linkParts = [];
        if (proj.url) linkParts.push(proj.url.replace('https://', ''));
        if (proj.liveUrl) linkParts.push(proj.liveUrl.replace('https://', '').replace('http://', ''));
        if (linkParts.length > 0) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(37, 99, 235);
          let lx = mL;
          if (proj.url) {
            const urlText = proj.url.replace('https://', '');
            doc.text(urlText, lx, y);
            const uw = doc.getTextWidth(urlText);
            doc.link(lx, y - 8, uw, 10, { url: proj.url });
            lx += uw;
          }
          if (proj.url && proj.liveUrl) {
            doc.setTextColor(107, 114, 128);
            doc.text('  |  ', lx, y);
            lx += doc.getTextWidth('  |  ');
          }
          if (proj.liveUrl) {
            doc.setTextColor(16, 185, 129);
            const liveText = proj.liveUrl.replace('https://', '').replace('http://', '');
            doc.text(liveText, lx, y);
            const lw = doc.getTextWidth(liveText);
            doc.link(lx, y - 8, lw, 10, { url: proj.liveUrl });
          }
          y += 10;
        }
        // Description
        if (proj.shortDesc) {
          wrappedText(proj.shortDesc, mL, 9, 'normal', contentW, [75, 85, 99]);
        }
        // Features (respecting maxFeatures)
        const maxF = proj.maxFeatures || 3;
        const features = (proj.features || []).slice(0, maxF);
        if (features.length > 0) {
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8.5);
          doc.setTextColor(55, 55, 55);
          checkPage(11);
          features.forEach(f => {
            checkPage(10);
            const cleanF = f.replace(/^[\-\u2022\u2023\u25E6â€¢*]\s*/, '');
            const fLines = doc.splitTextToSize(sanitize(cleanF), contentW - 12);
            fLines.forEach((fl, fi) => {
              checkPage(10);
              if (fi === 0) doc.text('-', mL + 4, y);
              doc.text(fl, mL + 12, y);
              y += 10;
            });
          });
        }
        y += 3;
      });
    }

    // â”€â”€ CERTIFICATIONS â”€â”€
    if (state.certs && state.certs.length > 0) {
      sectionHeader('Certifications');
      state.certs.forEach(cert => {
        checkPage(12);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(9.5);
        doc.setTextColor(30, 30, 30);
        let certStr = sanitize(cert.name);
        doc.text(certStr, mL, y);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(75, 85, 99);
        const orgStr = sanitize(` - ${cert.org}${cert.date ? ' (' + cert.date + ')' : ''}`);
        doc.text(orgStr, mL + doc.getTextWidth(certStr), y);
        y += 11;
      });
    }

    // Save
    const safeName = (profile.fullName || 'Resume').replace(/[^a-zA-Z0-9]/g, '_');
    const safeCompany = (generated.company || 'Resume').replace(/[^a-zA-Z0-9]/g, '_');
    doc.save(`${safeName}_${safeCompany}.pdf`);

  } catch (err) {
    console.error('PDF generation error:', err);
    alert('Error generating PDF: ' + err.message);
  }
}

function populatePDFTemplate() {
  const profile = state.profile;
  const generated = state.lastGenerated;

  // Header
  document.getElementById('pdfName').textContent = profile.fullName || 'Your Name';

  // Contact info with clickable links (open in new tab)
  const contactParts = [];
  if (profile.email) contactParts.push(`<a href="mailto:${profile.email}" target="_blank" style="color:#4b5563;text-decoration:none">${profile.email}</a>`);
  if (profile.phone) contactParts.push(profile.phone);
  if (profile.location) contactParts.push(profile.location);
  if (profile.linkedin) contactParts.push(`<a href="${profile.linkedin}" target="_blank" style="color:#2563eb;text-decoration:none">${profile.linkedin.replace('https://', '')}</a>`);
  if (profile.github) contactParts.push(`<a href="${profile.github}" target="_blank" style="color:#2563eb;text-decoration:none">${profile.github.replace('https://', '')}</a>`);
  document.getElementById('pdfContact').innerHTML = contactParts.join(' | ');

  // Summary - use tailored summary if available
  const summary = generated.tailoredSummary || profile.summary || '';
  document.getElementById('pdfSummary').textContent = summary;
  document.getElementById('pdfSummarySection').style.display = summary ? 'block' : 'none';

  // Experience - use edited experience if available, otherwise parse from resume text
  let expHtml = '';
  if (generated.editedExperience && generated.editedExperience.length > 0) {
    expHtml = generated.editedExperience.map(exp => `
      <div style="margin-bottom:12px">
        <div style="font-size:11px;page-break-after:avoid"><strong>${exp.title}</strong> â€” ${exp.company} <span style="color:#6b7280;white-space:nowrap">| ${exp.dates || ''}</span></div>
        <ul style="margin:4px 0 0 0;padding-left:18px;font-size:10px">
          ${exp.bullets.map(b => `<li style="margin-bottom:3px;page-break-inside:avoid">${b}</li>`).join('')}
        </ul>
      </div>
    `).join('');
  } else {
    expHtml = parseResumeExperience(generated.resume);
  }
  document.getElementById('pdfExperience').innerHTML = expHtml;
  document.getElementById('pdfExperienceSection').style.display = expHtml ? 'block' : 'none';

  // Education with relevant courses on separate line
  const eduHtml = state.education.map(edu => `
    <div style="margin-bottom:10px;page-break-inside:avoid">
      <div style="font-size:11px"><strong>${edu.degree}</strong> <span style="color:#6b7280;white-space:nowrap">| ${formatExpDate(edu.start)} - ${formatExpDate(edu.end)}</span></div>
      <div style="font-size:10px;color:#4b5563">${edu.school}${edu.location ? ', ' + edu.location : ''}${edu.gpa ? ' | GPA: ' + edu.gpa : ''}</div>
      ${edu.extras ? `<div style="font-size:10px;color:#4b5563;margin-top:4px"><strong style="color:#374151">Relevant Courses:</strong> ${edu.extras.replace(/\b([A-Z]{2,5}\s?\d{3,5}[A-Z]?)\b/g, '<strong style="color:#1a1a1a">$1</strong>')}</div>` : ''}
    </div>
  `).join('');
  document.getElementById('pdfEducation').innerHTML = eduHtml;
  document.getElementById('pdfEducationSection').style.display = eduHtml ? 'block' : 'none';

  // Skills
  const allSkills = [
    ...(state.skills.technical || []),
    ...(state.skills.tools || [])
  ];
  document.getElementById('pdfSkills').textContent = allSkills.join(', ');
  document.getElementById('pdfSkillsSection').style.display = allSkills.length ? 'block' : 'none';

  // Projects - use edited projects if available
  const projectsToUse = (generated.editedProjects && generated.editedProjects.length > 0)
    ? generated.editedProjects
    : state.projects;

  if (projectsToUse && projectsToUse.length > 0) {
    const projHtml = projectsToUse.filter(p => p.name).map(proj => {
      // Limit tech to first 5 items
      const techArr = (proj.tech || '').split(',').map(t => t.trim()).filter(t => t);
      const techStr = techArr.slice(0, 5).join(', ');
      const maxF = proj.maxFeatures || 3;
      const features = (proj.features || []).slice(0, maxF);
      // Build links line: GitHub + Live
      const links = [];
      if (proj.url) {
        const shortGh = proj.url.replace('https://', '');
        links.push(`<a href="${proj.url}" target="_blank" style="color:#2563eb;text-decoration:none">${shortGh}</a>`);
      }
      if (proj.liveUrl) {
        const shortLive = proj.liveUrl.replace('https://', '').replace('http://', '');
        links.push(`<a href="${proj.liveUrl}" target="_blank" style="color:#10b981;text-decoration:none">${shortLive}</a>`);
      }
      return `
        <div style="margin-bottom:10px;page-break-inside:avoid">
          <div style="font-size:11px;page-break-after:avoid"><strong>${proj.name}</strong></div>
          ${links.length > 0 ? `<div style="font-size:10px;margin:1px 0">${links.join(' | ')}</div>` : ''}
          <div style="font-size:10px;color:#4b5563;margin:2px 0">${proj.shortDesc || ''}</div>
          ${features.length > 0 ? `
            <div style="display:flex;flex-wrap:wrap;gap:4px;margin:4px 0 0 0">
              ${features.map(f => `<span style="font-size:9px;color:#1e40af;background:#dbeafe;padding:2px 7px;border-radius:3px;display:inline-block;line-height:1.3">${f}</span>`).join('')}
            </div>
          ` : ''}
          ${techStr ? `<div style="font-size:10px;color:#6b7280;margin-top:2px"><strong>Tech:</strong> ${techStr}</div>` : ''}
        </div>
      `;
    }).join('');
    document.getElementById('pdfProjects').innerHTML = projHtml;
    document.getElementById('pdfProjectsSection').style.display = 'block';
  } else {
    document.getElementById('pdfProjectsSection').style.display = 'none';
  }

  // Certifications
  if (state.certs && state.certs.length > 0) {
    const certHtml = state.certs.map(cert => `
      <div style="margin-bottom:8px;font-size:11px">
        <strong>${cert.name}</strong> - ${cert.org}${cert.date ? ` (${cert.date})` : ''}
      </div>
    `).join('');
    document.getElementById('pdfCerts').innerHTML = certHtml;
    document.getElementById('pdfCertsSection').style.display = 'block';
  } else {
    document.getElementById('pdfCertsSection').style.display = 'none';
  }
}

function parseResumeExperience(resumeText) {
  if (!resumeText) return '';

  // Parse the plain text resume to extract experience section
  const lines = resumeText.split('\n');
  let inExperience = false;
  let expHtml = '';
  let currentJob = null;
  let bullets = [];

  for (const line of lines) {
    const trimmed = line.trim();
    // Remove markdown bold markers for parsing
    const cleanLine = trimmed.replace(/\*\*/g, '').replace(/\*/g, '');

    // Detect section headers
    if (/^(EXPERIENCE|PROFESSIONAL EXPERIENCE|WORK EXPERIENCE|WORK HISTORY)/i.test(cleanLine)) {
      inExperience = true;
      continue;
    }
    if (/^(EDUCATION|SKILLS|PROJECTS|CERTIFICATIONS|TECHNICAL SKILLS|KEY PROJECTS)/i.test(cleanLine)) {
      // Save last job before exiting
      if (currentJob) {
        expHtml += formatJobEntry(currentJob, bullets);
      }
      inExperience = false;
      currentJob = null;
      bullets = [];
      continue;
    }

    if (inExperience && cleanLine) {
      // Check if this is a new job entry
      const hasPipe = cleanLine.includes('|');
      const isNotBullet = !trimmed.startsWith('-') && !trimmed.startsWith('â€¢') && !trimmed.match(/^\d+\./);

      if (hasPipe && isNotBullet) {
        // Save previous job
        if (currentJob) {
          expHtml += formatJobEntry(currentJob, bullets);
          bullets = [];
        }
        const parts = cleanLine.split('|').map(p => p.trim());
        currentJob = {
          title: parts[0] || '',
          company: parts[1] || '',
          location: parts[2] || '',
          dates: parts[3] || ''
        };
      } else if (isNotBullet && /^[A-Z][a-z]+\s+(at|@)\s+[A-Z]/i.test(cleanLine)) {
        // Pattern: "Title at Company"
        if (currentJob) {
          expHtml += formatJobEntry(currentJob, bullets);
          bullets = [];
        }
        const match = cleanLine.match(/^(.+?)\s+(?:at|@)\s+(.+?)(?:\s*[,|]\s*(.+?))?(?:\s*[,|]\s*(.+))?$/i);
        if (match) {
          currentJob = {
            title: match[1] || '',
            company: match[2] || '',
            location: match[3] || '',
            dates: match[4] || ''
          };
        }
      } else if (currentJob) {
        // Check for bullets
        if (trimmed.startsWith('-') || trimmed.startsWith('â€¢')) {
          const bullet = trimmed.replace(/^[-â€¢]\s*/, '').replace(/\*\*/g, '');
          if (bullet.length > 10) {
            bullets.push(bullet);
          }
        }
        // Also catch lines starting with action verbs
        else if (/^(Led|Managed|Developed|Built|Created|Designed|Implemented|Executed|Deployed|Configured|Conducted|Diagnosed|Served|Partnered|Optimized|Orchestrated|Collaborated|Applied|Established|Increased|Reduced)\s/i.test(cleanLine)) {
          if (cleanLine.length > 30) {
            bullets.push(cleanLine);
          }
        }
      }
    }
  }

  // Don't forget the last job
  if (currentJob) {
    expHtml += formatJobEntry(currentJob, bullets);
  }

  return expHtml;
}

function formatJobEntry(job, bullets) {
  return `
    <div style="margin-bottom:12px">
      <div style="font-size:11px;page-break-after:avoid"><strong>${job.title}</strong> â€” ${job.company}${job.location ? ', ' + job.location : ''} <span style="color:#6b7280;white-space:nowrap">| ${job.dates}</span></div>
      <ul style="margin:4px 0 0 0;padding-left:18px;font-size:10px">
        ${bullets.map(b => `<li style="margin-bottom:3px;page-break-inside:avoid">${b}</li>`).join('')}
      </ul>
    </div>
  `;
}

// ============ Cover Letter PDF Export (ATS-Friendly Text-Based) ============

function downloadCoverLetterPDF() {
  if (!state.lastGenerated || !state.lastGenerated.coverLetter) {
    alert('No cover letter available. Generate a resume with the cover letter option enabled.');
    return;
  }

  try {
    const jsPDFClass = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
    if (!jsPDFClass) { alert('PDF library not loaded. Please refresh the page.'); return; }
    const doc = new jsPDFClass({ unit: 'pt', format: 'letter' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const mL = 72, mR = 72, mT = 54, mB = 54; // 1 inch margins
    const contentW = pageW - mL - mR;
    let y = mT;

    const profile = state.profile;
    const generated = state.lastGenerated;

    // â”€â”€ HEADER â”€â”€
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(14);
    doc.setTextColor(30, 30, 30);
    doc.text(profile.fullName || 'Your Name', mL, y);
    y += 16;

    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(75, 85, 99);
    const contactParts = [];
    if (profile.email) contactParts.push(profile.email);
    if (profile.phone) contactParts.push(profile.phone);
    if (profile.location) contactParts.push(profile.location);
    if (contactParts.length > 0) {
      doc.text(contactParts.join(' | '), mL, y);
      y += 14;
    }

    // â”€â”€ DATE â”€â”€
    y += 10;
    const today = new Date();
    doc.setFontSize(10);
    doc.setTextColor(30, 30, 30);
    doc.text(today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), mL, y);
    y += 24;

    // â”€â”€ RECIPIENT â”€â”€
    if (generated.company) {
      doc.setFont('helvetica', 'bold');
      doc.text(generated.company, mL, y);
      y += 14;
    }
    if (generated.title) {
      doc.setFont('helvetica', 'normal');
      doc.text(generated.title, mL, y);
      y += 14;
    }
    y += 10;

    // â”€â”€ SALUTATION â”€â”€
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(30, 30, 30);
    doc.text('Dear Hiring Manager,', mL, y);
    y += 20;

    // â”€â”€ BODY â”€â”€
    let bodyText = (generated.coverLetter || '')
      .replace(/^Dear[^,]*,?\s*/i, '')
      .replace(/\s*Sincerely,?\s*[\s\S]*$/i, '')
      .replace(/\s*Best regards,?\s*[\s\S]*$/i, '')
      .replace(/\s*Kind regards,?\s*[\s\S]*$/i, '')
      .trim();

    const paragraphs = bodyText.split(/\n\n+/).filter(p => p.trim());
    paragraphs.forEach(para => {
      const text = para.replace(/\n/g, ' ').trim();
      const lines = doc.splitTextToSize(text, contentW);
      lines.forEach(line => {
        if (y + 14 > pageH - mB) { doc.addPage(); y = mT; }
        doc.text(line, mL, y);
        y += 14;
      });
      y += 8; // paragraph gap
    });

    // â”€â”€ CLOSING â”€â”€
    y += 10;
    if (y + 50 > pageH - mB) { doc.addPage(); y = mT; }
    doc.text('Sincerely,', mL, y);
    y += 30;
    doc.setFont('helvetica', 'bold');
    doc.text(profile.fullName || 'Your Name', mL, y);

    // Save
    const safeName = (profile.fullName || 'Cover_Letter').replace(/[^a-zA-Z0-9]/g, '_');
    const safeCompany = (generated.company || '').replace(/[^a-zA-Z0-9]/g, '_');
    doc.save(`Cover_Letter_${safeName}_${safeCompany}.pdf`);

  } catch (err) {
    console.error('Cover letter PDF generation error:', err);
    alert('Error generating PDF: ' + err.message);
  }
}

function populateCoverLetterPDFTemplate() {
  const profile = state.profile;
  const generated = state.lastGenerated;

  // Header
  document.getElementById('clPdfName').textContent = profile.fullName || 'Your Name';

  // Contact info
  const contactParts = [];
  if (profile.email) contactParts.push(profile.email);
  if (profile.phone) contactParts.push(profile.phone);
  if (profile.location) contactParts.push(profile.location);
  document.getElementById('clPdfContact').textContent = contactParts.join(' | ');

  // Date
  const today = new Date();
  const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('clPdfDate').textContent = dateStr;

  // Recipient
  document.getElementById('clPdfCompany').textContent = generated.company || '';
  document.getElementById('clPdfPosition').textContent = generated.title || '';

  // Body - parse cover letter and convert to paragraphs
  const coverLetter = generated.coverLetter || '';
  // Remove common salutation and closing if present (we add our own)
  let bodyText = coverLetter
    .replace(/^Dear[^,]*,?\s*/i, '')
    .replace(/\s*Sincerely,?\s*[\s\S]*$/i, '')
    .replace(/\s*Best regards,?\s*[\s\S]*$/i, '')
    .replace(/\s*Kind regards,?\s*[\s\S]*$/i, '')
    .trim();

  // Convert to paragraphs
  const paragraphs = bodyText.split(/\n\n+/).filter(p => p.trim());
  document.getElementById('clPdfBody').innerHTML = paragraphs
    .map(p => `<p style="margin:0 0 12px 0">${p.replace(/\n/g, ' ')}</p>`)
    .join('');

  // Signature
  document.getElementById('clPdfSignature').textContent = profile.fullName || 'Your Name';
}

// ============ Google Docs Export Functions ============

// CONFIGURATION: Replace with your Google Cloud OAuth Client ID
// Follow these steps to get your client ID:
// 1. Go to console.cloud.google.com
// 2. Create a new project (or select existing)
// 3. Enable Google Docs API and Google Drive API
// 4. Go to Credentials > Create Credentials > OAuth Client ID
// 5. Select "Web application" and add your domain to authorized JavaScript origins
// 6. Copy the client ID and paste it below (already configured above)

let googleAccessToken = null;

async function exportToGoogleDocs() {
  if (!state.lastGenerated || !state.lastGenerated.resume) {
    alert('Please generate a resume first');
    return;
  }

  // Check if user is signed in with Google
  if (!googleAccessToken) {
    // Trigger Google sign-in
    await signInWithGoogle();
    if (!googleAccessToken) {
      return; // User cancelled or error
    }
  }

  const btn = document.getElementById('googleDocsBtn');
  const originalText = btn.textContent;
  btn.textContent = 'Creating...';
  btn.disabled = true;

  try {
    const response = await fetch('/api/google-docs', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        accessToken: googleAccessToken,
        resumeData: {
          fullName: state.profile.fullName || 'Your Name',
          email: state.profile.email || '',
          phone: state.profile.phone || '',
          location: state.profile.location || '',
          linkedin: state.profile.linkedin || '',
          github: state.profile.github || '',
          summary: state.lastGenerated.tailoredSummary || state.profile.summary || '',
          resume: state.lastGenerated.resume,
          coverLetter: state.lastGenerated.coverLetter || null,
          company: state.lastGenerated.company || 'Resume',
          title: state.lastGenerated.title || 'Position',
          experience: state.experience,
          education: state.education,
          skills: state.skills,
          projects: state.projects,
          certs: state.certs
        }
      })
    });

    const data = await response.json();

    if (data.error) {
      if (data.error.includes('token')) {
        // Token expired, clear and retry
        googleAccessToken = null;
        alert('Google session expired. Please sign in again.');
      } else {
        alert('Error creating Google Doc: ' + data.error);
      }
      return;
    }

    if (data.docUrl) {
      // Success - open the document
      window.open(data.docUrl, '_blank');
      alert('Resume exported to Google Docs successfully!');
    }
  } catch (err) {
    console.error('Google Docs export error:', err);
    alert('Error exporting to Google Docs. Please try again.');
  } finally {
    btn.textContent = originalText;
    btn.disabled = false;
  }
}

function signInWithGoogle() {
  return new Promise((resolve) => {
    // Check if google.accounts is available
    if (typeof google === 'undefined' || !google.accounts) {
      alert('Google Sign-In is not available. Please refresh the page and try again.');
      resolve();
      return;
    }

    // Check if Google Client ID is configured
    if (GOOGLE_CLIENT_ID === 'YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com') {
      alert('Google Docs export requires configuration.\n\nPlease set up a Google Cloud project and update GOOGLE_CLIENT_ID in the code.\n\nSee: console.cloud.google.com');
      resolve();
      return;
    }

    const client = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/documents https://www.googleapis.com/auth/drive.file',
      callback: (response) => {
        if (response.access_token) {
          googleAccessToken = response.access_token;
          resolve();
        } else {
          console.error('No access token in response');
          resolve();
        }
      },
      error_callback: (error) => {
        console.error('Google sign-in error:', error);
        if (error.type === 'popup_closed') {
          // User closed the popup
        } else {
          alert('Google sign-in failed. Please check your Google Cloud project configuration.');
        }
        resolve();
      }
    });

    client.requestAccessToken();
  });
}
</script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- Prospect Tool React Component -->
<script type="text/babel">
const { useState, useEffect } = React;

const STAGES = {
  IDLE: "idle",
  DISCOVERING: "discovering",
  READY: "ready",
  SEARCHING: "searching",
  DONE: "done",
  ERROR: "error",
};

function extractJSON(text) {
  const match = text.match(/\[[\s\S]*?\]/);
  if (match) {
    try { return JSON.parse(match[0]); } catch (e) {}
  }
  try { return JSON.parse(text.replace(/```json|```/g, "").trim()); } catch (e) {}
  return null;
}

function guessCompanyDomain(company) {
  return company.trim().toLowerCase().replace(/[^a-z0-9\s]/g, "").replace(/\s+/g, "") + ".com";
}

function generateEmailGuesses(name, companyDomain) {
  if (!name || !companyDomain) return [];
  const parts = name.trim().toLowerCase().split(/\s+/);
  if (parts.length < 2) return [`${parts[0]}@${companyDomain}`];
  const first = parts[0], last = parts[parts.length - 1];
  return [
    `${first}@${companyDomain}`,
    `${first}.${last}@${companyDomain}`,
    `${first}${last}@${companyDomain}`,
    `${first[0]}${last}@${companyDomain}`,
    `${first}_${last}@${companyDomain}`,
  ];
}

async function callClaude(apiKey, messages, { system, tools, maxTokens = 4096 } = {}) {
  const body = {
    model: "claude-sonnet-4-20250514",
    max_tokens: maxTokens,
    messages,
  };
  if (system) body.system = system;
  if (tools) body.tools = tools;
  const res = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-api-key": apiKey,
      "anthropic-version": "2023-06-01",
      "anthropic-dangerous-direct-browser-access": "true"
    },
    body: JSON.stringify(body),
  });
  const data = await res.json();
  if (data.error) throw new Error(data.error.message);
  return data.content
    .map((b) => (b.type === "text" ? b.text : ""))
    .filter(Boolean)
    .join("\n");
}

async function parseOrRetry(apiKey, rawText, retryPrompt) {
  let parsed = extractJSON(rawText);
  if (parsed && parsed.length > 0) return parsed;
  try {
    const fixText = await callClaude(apiKey,
      [{ role: "user", content: retryPrompt + "\n\nText:\n" + rawText }],
      { maxTokens: 2048 }
    );
    return extractJSON(fixText) || [];
  } catch (e) {
    return [];
  }
}

function EmailGuesses({ name, company }) {
  const [show, setShow] = useState(false);
  const [copied, setCopied] = useState(null);
  const domain = guessCompanyDomain(company);
  const guesses = generateEmailGuesses(name, domain);
  const copy = (email, idx) => {
    navigator.clipboard.writeText(email);
    setCopied(idx);
    setTimeout(() => setCopied(null), 1500);
  };
  if (!guesses.length) return null;
  return (
    <div style={{ marginTop: "8px" }}>
      <button onClick={() => setShow(!show)} style={{
        background: "none", border: "none", color: "#6366f199", fontSize: "12px",
        cursor: "pointer", padding: "2px 0", textDecoration: "underline",
      }}>
        {show ? "Hide" : "ðŸ”® Guess"} email patterns
      </button>
      {show && (
        <div style={{ marginTop: "6px", display: "flex", flexWrap: "wrap", gap: "6px" }}>
          {guesses.map((g, i) => (
            <button key={i} onClick={() => copy(g, i)} style={{
              background: copied === i ? "#10b981" : "#1a1a1a",
              color: copied === i ? "#fff" : "#888",
              border: "1px solid #333", borderRadius: "4px",
              padding: "4px 10px", fontSize: "12px", cursor: "pointer",
              fontFamily: "monospace", transition: "all 0.15s",
            }}>
              {copied === i ? "âœ“ copied" : g}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

function PersonCard({ person, company, onGenerateMessage }) {
  const [showMsg, setShowMsg] = useState(false);
  const [msg, setMsg] = useState(null);
  const [loading, setLoading] = useState(false);
  const [msgType, setMsgType] = useState("casual");
  const [copied, setCopied] = useState(false);

  const generate = async (type) => {
    setMsgType(type); setLoading(true); setShowMsg(true); setCopied(false);
    try { setMsg(await onGenerateMessage(person, company, type)); }
    catch (e) { setMsg("Failed to generate â€” try again."); }
    setLoading(false);
  };

  return (
    <div style={{
      background: "#1a1a1a", border: "1px solid #333", borderRadius: "12px",
      padding: "24px", marginBottom: "16px", transition: "border-color 0.2s",
    }}
    onMouseEnter={e => e.currentTarget.style.borderColor = "#6366f1"}
    onMouseLeave={e => e.currentTarget.style.borderColor = "#333"}
    >
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", flexWrap: "wrap", gap: "12px" }}>
        <div style={{ flex: 1, minWidth: "200px" }}>
          <h3 style={{ margin: 0, fontSize: "20px", color: "#fff" }}>{person.name}</h3>
          <p style={{ margin: "4px 0 0", color: "#6366f1", fontSize: "14px", fontWeight: 600 }}>{person.role}</p>
        </div>
        <div style={{ display: "flex", gap: "8px", flexWrap: "wrap" }}>
          {person.email && (
            <a href={`mailto:${person.email}`} style={{
              background: "#6366f1", color: "#fff", padding: "6px 14px",
              borderRadius: "6px", fontSize: "13px", textDecoration: "none", fontWeight: 600,
            }}>âœ‰ {person.email}</a>
          )}
          {person.twitter && (
            <a href={`https://x.com/${person.twitter.replace("@","")}`} target="_blank" style={{
              background: "#1a1a1a", color: "#aaa", padding: "6px 14px",
              borderRadius: "6px", fontSize: "13px", textDecoration: "none", border: "1px solid #333",
            }}>ð• {person.twitter}</a>
          )}
          {person.linkedin && (
            <a href={person.linkedin} target="_blank" style={{
              background: "#1a1a1a", color: "#aaa", padding: "6px 14px",
              borderRadius: "6px", fontSize: "13px", textDecoration: "none", border: "1px solid #333",
            }}>in LinkedIn</a>
          )}
        </div>
      </div>
      {!person.email && <EmailGuesses name={person.name} company={company} />}
      {person.interests && (
        <p style={{ color: "#888", fontSize: "14px", margin: "12px 0 0", lineHeight: 1.6 }}>
          <span style={{ color: "#6366f1" }}>Interests:</span> {person.interests}
        </p>
      )}
      {person.background && (
        <p style={{ color: "#888", fontSize: "14px", margin: "8px 0 0", lineHeight: 1.6 }}>
          <span style={{ color: "#6366f1" }}>Background:</span> {person.background}
        </p>
      )}
      {person.source && <p style={{ color: "#555", fontSize: "12px", margin: "8px 0 0" }}>Source: {person.source}</p>}

      <div style={{ marginTop: "16px", display: "flex", gap: "8px", flexWrap: "wrap" }}>
        {[
          { key: "casual", label: "ðŸ’¬ Casual intro" },
          { key: "job", label: "ðŸŽ¯ Job inquiry" },
          { key: "interest", label: "ðŸ§  Common interest" },
        ].map(({ key, label }) => (
          <button key={key} onClick={() => generate(key)} style={{
            background: showMsg && msgType === key ? "#6366f1" : "transparent",
            color: showMsg && msgType === key ? "#fff" : "#6366f1",
            border: "1px solid #6366f1", padding: "8px 16px", borderRadius: "6px",
            cursor: "pointer", fontSize: "13px", fontWeight: 600, transition: "all 0.15s",
          }}>{label}</button>
        ))}
      </div>

      {showMsg && (
        <div style={{
          marginTop: "16px", background: "#111", border: "1px solid #333",
          borderRadius: "8px", padding: "16px",
        }}>
          {loading ? (
            <div style={{ display: "flex", alignItems: "center", gap: "8px" }}>
              <span style={{ animation: "pulse 1.5s infinite" }}>âœï¸</span>
              <p style={{ color: "#888", margin: 0, fontStyle: "italic" }}>Writing message...</p>
            </div>
          ) : (
            <>
              <p style={{ color: "#ccc", margin: 0, fontSize: "14px", lineHeight: 1.7, whiteSpace: "pre-wrap" }}>{msg}</p>
              <button onClick={() => { navigator.clipboard.writeText(msg); setCopied(true); setTimeout(() => setCopied(false), 2000); }} style={{
                marginTop: "12px", background: copied ? "#10b981" : "#333",
                color: copied ? "#fff" : "#aaa", border: "none", padding: "6px 14px",
                borderRadius: "6px", cursor: "pointer", fontSize: "12px",
                fontWeight: copied ? 700 : 400, transition: "all 0.2s",
              }}>{copied ? "âœ“ Copied!" : "ðŸ“‹ Copy to clipboard"}</button>
            </>
          )}
        </div>
      )}
    </div>
  );
}

function SavedSearches({ onLoad, onDelete, activeCompany }) {
  const [searches, setSearches] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => { loadSearches(); }, []);

  const loadSearches = async () => {
    setLoading(true);
    try {
      const stored = localStorage.getItem('prospectSearches');
      if (stored) {
        const items = JSON.parse(stored);
        items.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        setSearches(items);
      }
    } catch (e) {}
    setLoading(false);
  };

  const handleDelete = async (company) => {
    try {
      const stored = localStorage.getItem('prospectSearches');
      if (stored) {
        let items = JSON.parse(stored);
        items = items.filter(s => s.company !== company);
        localStorage.setItem('prospectSearches', JSON.stringify(items));
        setSearches(items);
      }
      onDelete(company);
    } catch (e) {}
  };

  if (loading) return <p style={{ color: "#555", fontSize: "13px" }}>Loading saved searches...</p>;
  if (!searches.length) return null;

  return (
    <div style={{
      background: "#1a1a1a", border: "1px solid #333", borderRadius: "12px",
      padding: "20px 24px", marginBottom: "24px",
    }}>
      <h3 style={{ margin: "0 0 16px", fontSize: "16px", color: "#fff" }}>
        ðŸ“‚ Saved Searches <span style={{ color: "#555", fontSize: "12px", fontWeight: 400 }}>({searches.length})</span>
      </h3>
      <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
        {searches.map((s) => (
          <div key={s.company} style={{
            display: "flex", alignItems: "center", gap: "4px",
            background: activeCompany === s.company ? "#6366f1" : "#111",
            border: "1px solid #333", borderRadius: "8px", overflow: "hidden",
          }}>
            <button onClick={() => onLoad(s)} style={{
              background: "none", border: "none", color: activeCompany === s.company ? "#fff" : "#ccc",
              padding: "8px 12px", cursor: "pointer", fontSize: "13px", fontWeight: 600,
            }}>
              {s.company} <span style={{ color: activeCompany === s.company ? "#c7d2fe" : "#666", fontSize: "11px", marginLeft: "6px" }}>{s.people.length} people</span>
            </button>
            <button onClick={() => handleDelete(s.company)} style={{
              background: "none", border: "none", borderLeft: "1px solid #333",
              color: "#555", padding: "8px 10px", cursor: "pointer", fontSize: "12px",
            }}>âœ•</button>
          </div>
        ))}
      </div>
    </div>
  );
}

function ProspectTool() {
  const [apiKey, setApiKey] = useState(() => localStorage.getItem('anthropicApiKey') || '');
  const [company, setCompany] = useState("");
  const [stage, setStage] = useState(STAGES.IDLE);
  const [departments, setDepartments] = useState([]);
  const [selectedDepts, setSelectedDepts] = useState([]);
  const [people, setPeople] = useState([]);
  const [jobs, setJobs] = useState([]);
  const [jobsLoading, setJobsLoading] = useState(false);
  const [showJobs, setShowJobs] = useState(false);
  const [error, setError] = useState("");
  const [statusMsg, setStatusMsg] = useState("");
  const [searchCount, setSearchCount] = useState(0);
  const [savedKey, setSavedKey] = useState(0);
  const [activeCompany, setActiveCompany] = useState("");
  const [justSaved, setJustSaved] = useState(false);
  const [companyInfo, setCompanyInfo] = useState("");

  const saveApiKey = (key) => {
    setApiKey(key);
    localStorage.setItem('anthropicApiKey', key);
  };

  const toggleDept = (d) => {
    setSelectedDepts(prev => prev.includes(d) ? prev.filter(x => x !== d) : [...prev, d]);
  };

  const saveSearch = async (companyName, peopleData) => {
    try {
      const stored = localStorage.getItem('prospectSearches');
      let items = stored ? JSON.parse(stored) : [];
      const existing = items.findIndex(s => s.company === companyName);
      const newItem = { company: companyName, people: peopleData, departments, timestamp: Date.now() };
      if (existing >= 0) {
        items[existing] = newItem;
      } else {
        items.push(newItem);
      }
      localStorage.setItem('prospectSearches', JSON.stringify(items));
      setSavedKey(prev => prev + 1);
      setJustSaved(true);
      setTimeout(() => setJustSaved(false), 2000);
    } catch (e) {}
  };

  const loadSearch = (saved) => {
    setCompany(saved.company);
    setPeople(saved.people);
    setDepartments(saved.departments || []);
    setActiveCompany(saved.company);
    setStage(STAGES.DONE);
    setStatusMsg(`ðŸ“‚ Loaded ${saved.people.length} people from saved search`);
    setJobs([]); setShowJobs(false);
  };

  const discoverCompany = async () => {
    if (!company.trim() || !apiKey) return;
    setStage(STAGES.DISCOVERING);
    setDepartments([]); setSelectedDepts([]); setPeople([]); setJobs([]);
    setError(""); setShowJobs(false); setActiveCompany("");
    setStatusMsg(`ðŸ¢ Discovering teams at ${company}...`);

    try {
      const raw = await callClaude(apiKey,
        [{ role: "user", content: `Research the company "${company}" and identify their actual teams and departments. Check their careers page, about page, team page, job listings, and any public info.

Return a JSON array of department/team names that actually exist at this company. Be specific to the company â€” don't use generic categories.

Also include a one-line description of the company.

Format â€” respond with ONLY this JSON, nothing else:
{"company_description": "one line about what they do", "departments": ["Dept 1", "Dept 2", "Dept 3", ...]}` }],
        {
          system: "You are a research assistant. Respond with ONLY valid JSON. No prose, no markdown, no explanation.",
        }
      );

      let result = null;
      try {
        const cleaned = raw.replace(/```json|```/g, "").trim();
        result = JSON.parse(cleaned);
      } catch (e) {
        const objMatch = raw.match(/\{[\s\S]*\}/);
        if (objMatch) {
          try { result = JSON.parse(objMatch[0]); } catch (e2) {}
        }
      }

      if (!result) {
        try {
          const fixText = await callClaude(apiKey,
            [{ role: "user", content: `Extract the company description and departments list from this text into JSON.\n\nText: ${raw}\n\nRespond with ONLY: {"company_description":"...","departments":["...","..."]}` }],
            { maxTokens: 2048 }
          );
          const cleaned = fixText.replace(/```json|```/g, "").trim();
          result = JSON.parse(cleaned);
        } catch (e) {}
      }

      if (result && result.departments && result.departments.length > 0) {
        setDepartments(result.departments);
        setCompanyInfo(result.company_description || "");
        setStage(STAGES.READY);
        setStatusMsg(`Found ${result.departments.length} teams at ${company}`);
      } else {
        setError("Couldn't identify departments. Try a different company name or check the spelling.");
        setStage(STAGES.ERROR);
      }
    } catch (e) {
      setError("Discovery failed: " + e.message);
      setStage(STAGES.ERROR);
    }
  };

  const searchPeople = async () => {
    if (!selectedDepts.length || !apiKey) return;
    setStage(STAGES.SEARCHING);
    setPeople([]);
    setError("");
    setStatusMsg(`ðŸ” Finding people in ${selectedDepts.join(", ")} at ${company}...`);

    try {
      const raw = await callClaude(apiKey,
        [{ role: "user", content: `Find 2-4 real people who work at ${company} in these specific teams/departments: ${selectedDepts.join(", ")}.

STRICT RULES:
- ONLY include people who work in the selected departments
- Do NOT include founders, CEOs, or C-suite unless their role directly matches a selected department
- Find mid-level to senior people in those specific teams

For each person find:
- Full name and role/title
- Email (check public sources, company email patterns)
- Twitter/X handle, LinkedIn URL if available
- 1 sentence on background, 1 sentence on interests
- Source

Respond with ONLY a JSON array:
[{"name":"...","role":"...","email":"...or null","twitter":"...or null","linkedin":"...or null","background":"...","interests":"...","source":"..."}]` }],
        {
          system: "You are a research assistant. Respond with ONLY a valid JSON array. No prose or explanation.",
        }
      );

      const parsed = await parseOrRetry(apiKey, raw,
        `Extract people from this text into a JSON array. Apply any email patterns found.\n\nRespond with ONLY a JSON array:\n[{"name":"...","role":"...","email":"...or null","twitter":"...or null","linkedin":"...or null","background":"...","interests":"...","source":"..."}]`
      );

      if (parsed.length > 0) {
        setPeople(parsed);
        setStage(STAGES.DONE);
        setActiveCompany(company);
        setStatusMsg(`âœ… Found ${parsed.length} people at ${company}`);
        setSearchCount(prev => prev + 1);
      } else {
        setError("No people found for those departments. Try selecting different teams.");
        setStage(STAGES.READY);
      }
    } catch (e) {
      setError("Search failed: " + e.message);
      setStage(STAGES.READY);
    }
  };

  const searchJobs = async () => {
    if (!apiKey) return;
    setJobsLoading(true); setShowJobs(true);
    try {
      const raw = await callClaude(apiKey,
        [{ role: "user", content: `Find current open job listings at ${company}. Check their careers page, Ashby, Lever, Greenhouse, LinkedIn jobs, and website.\n\nReturn ONLY a JSON array:\n[{"title":"...","department":"...","location":"...","url":"...or null","type":"full-time/part-time/contract/unknown"}]\n\nIf none found: []` }],
        {
          system: "Respond with ONLY a valid JSON array.",
        }
      );
      const parsed = await parseOrRetry(apiKey, raw,
        `Extract job listings into JSON array:\n[{"title":"...","department":"...","location":"...","url":"...or null","type":"..."}]\nIf none: []`
      );
      setJobs(parsed || []);
    } catch (e) {}
    setJobsLoading(false);
  };

  const generateMessage = async (person, companyName, type) => {
    const jobContext = jobs.length > 0
      ? `\n\nOpen roles at ${companyName} that might be relevant: ${jobs.slice(0, 5).map(j => j.title).join(", ")}. You can reference a specific open role if it feels natural.`
      : "";

    const prompts = {
      casual: `Write a very short, casual cold email (4-6 sentences) to ${person.name} (${person.role} at ${companyName}). Interests: ${person.interests || "unknown"}. Background: ${person.background || "unknown"}. Be natural, not a bot. Reference something specific about them. End with an open question.${jobContext}`,
      job: `Write a very short cold email (5-7 sentences) to ${person.name} (${person.role} at ${companyName}). You're interested in opportunities there but keep it chill. Mention why ${companyName} interests you. Their background: ${person.background || "unknown"}. Ask about roles or hiring.${jobContext}`,
      interest: `Write a very short cold email (4-6 sentences) to ${person.name} at ${companyName}. Their interests: ${person.interests || "unknown"}. Background: ${person.background || ""}. Find a natural connection point and start a genuine conversation.${jobContext}`,
    };

    const raw = await callClaude(apiKey,
      [{ role: "user", content: prompts[type] + "\n\nSign off with [Your name]. Write ONLY the email body." }],
      { maxTokens: 2048 }
    );
    return raw.trim();
  };

  const isReady = stage === STAGES.READY || stage === STAGES.DONE;

  return (
    <div style={{ color: "#e0e0e0" }}>
      <h2 style={{ marginBottom: "20px" }}>Prospect Finder</h2>
      <p style={{ color: "#888", marginBottom: "20px" }}>Search company â†’ pick their teams â†’ find people â†’ send outreach.</p>

      {/* API Key Input */}
      <div style={{ background: "#1a1a1a", borderRadius: "12px", padding: "20px", border: "1px solid #333", marginBottom: "24px" }}>
        <label style={{ display: "block", marginBottom: "8px", color: "#888", fontSize: "0.9em" }}>Anthropic API Key</label>
        <div style={{ display: "flex", gap: "10px" }}>
          <input
            type="password"
            placeholder="sk-ant-api..."
            value={apiKey}
            onChange={(e) => saveApiKey(e.target.value)}
            style={{
              flex: 1, background: "#111", border: "1px solid #333",
              borderRadius: "8px", padding: "12px", color: "#fff", fontSize: "14px",
            }}
          />
        </div>
        {!apiKey && <p style={{ color: "#f59e0b", fontSize: "12px", marginTop: "8px" }}>âš ï¸ API key required for prospect searches</p>}
      </div>

      <SavedSearches key={savedKey} onLoad={loadSearch} onDelete={(c) => { if (activeCompany === c) { setPeople([]); setStage(STAGES.IDLE); } }} activeCompany={activeCompany} />

      {/* Company Search */}
      <div style={{ background: "#1a1a1a", borderRadius: "12px", padding: "24px", border: "1px solid #333" }}>
        <div style={{ display: "flex", gap: "12px", marginBottom: isReady ? "16px" : "0" }}>
          <input
            type="text"
            placeholder="Company name (e.g. Meter, Ramp, Figma...)"
            value={company}
            onChange={(e) => setCompany(e.target.value)}
            onKeyDown={(e) => e.key === "Enter" && discoverCompany()}
            style={{
              flex: 1, background: "#111", border: "1px solid #333",
              borderRadius: "8px", padding: "14px 16px", color: "#fff", fontSize: "15px",
            }}
          />
          <button
            onClick={discoverCompany}
            disabled={stage === STAGES.DISCOVERING || !company.trim() || !apiKey}
            style={{
              background: stage === STAGES.DISCOVERING || !apiKey ? "#333" : "#6366f1",
              color: "#fff", border: "none", borderRadius: "8px",
              padding: "14px 28px", fontSize: "15px", fontWeight: 700,
              cursor: stage === STAGES.DISCOVERING || !apiKey ? "not-allowed" : "pointer", whiteSpace: "nowrap",
              opacity: !apiKey ? 0.5 : 1
            }}
          >
            {stage === STAGES.DISCOVERING ? "Discovering..." : "Discover Teams"}
          </button>
        </div>

        {companyInfo && isReady && (
          <p style={{ color: "#666", fontSize: "13px", margin: "0 0 16px", fontStyle: "italic" }}>
            {companyInfo}
          </p>
        )}

        {departments.length > 0 && isReady && (
          <div>
            <p style={{ color: "#666", fontSize: "12px", margin: "0 0 10px", textTransform: "uppercase", letterSpacing: "1px" }}>
              Teams at {company} <span style={{ color: "#444" }}>(select which to search)</span>
            </p>
            <div style={{ display: "flex", flexWrap: "wrap", gap: "8px" }}>
              {departments.map((dept) => {
                const active = selectedDepts.includes(dept);
                return (
                  <button key={dept} onClick={() => toggleDept(dept)} style={{
                    background: active ? "#6366f1" : "#111",
                    color: active ? "#fff" : "#888",
                    border: active ? "1px solid #6366f1" : "1px solid #333",
                    borderRadius: "20px", padding: "7px 14px", fontSize: "13px",
                    cursor: "pointer", fontWeight: active ? 600 : 400, transition: "all 0.15s",
                  }}>
                    {dept}
                  </button>
                );
              })}
            </div>
            <div style={{ display: "flex", gap: "12px", alignItems: "center", marginTop: "14px" }}>
              {selectedDepts.length > 0 && (
                <>
                  <button onClick={searchPeople} disabled={stage === STAGES.SEARCHING} style={{
                    background: stage === STAGES.SEARCHING ? "#333" : "#6366f1",
                    color: "#fff", border: "none", borderRadius: "8px",
                    padding: "10px 24px", fontSize: "14px", fontWeight: 700,
                    cursor: stage === STAGES.SEARCHING ? "wait" : "pointer",
                  }}>
                    {stage === STAGES.SEARCHING ? "Searching..." : `Find People in ${selectedDepts.length} team${selectedDepts.length > 1 ? "s" : ""}`}
                  </button>
                  <button onClick={() => setSelectedDepts([])} style={{
                    background: "none", border: "none", color: "#555",
                    fontSize: "12px", cursor: "pointer", textDecoration: "underline",
                  }}>Clear</button>
                </>
              )}
            </div>
          </div>
        )}
      </div>

      {statusMsg && (
        <p style={{
          color: stage === STAGES.DONE ? "#10b981" : "#888",
          fontSize: "14px", margin: "16px 0",
          fontStyle: [STAGES.DISCOVERING, STAGES.SEARCHING].includes(stage) ? "italic" : "normal",
        }}>
          {[STAGES.DISCOVERING, STAGES.SEARCHING].includes(stage) && (
            <span style={{ display: "inline-block", animation: "pulse 1.5s infinite" }}>â³ </span>
          )}
          {statusMsg}
        </p>
      )}

      {error && (
        <div style={{ background: "#2a1020", border: "1px solid #ef4444", borderRadius: "8px", padding: "16px", margin: "16px 0" }}>
          <p style={{ color: "#ef4444", margin: 0, fontSize: "14px", whiteSpace: "pre-wrap" }}>{error}</p>
        </div>
      )}

      {stage === STAGES.DONE && people.length > 0 && (
        <div style={{ margin: "16px 0", display: "flex", gap: "12px", alignItems: "center", flexWrap: "wrap" }}>
          <button onClick={() => saveSearch(company, people)} style={{
            background: justSaved ? "#10b981" : "#1a1a1a",
            color: justSaved ? "#fff" : "#6366f1",
            border: justSaved ? "1px solid #10b981" : "1px solid #6366f1",
            borderRadius: "8px", padding: "10px 20px", fontSize: "14px", fontWeight: 700, cursor: "pointer",
          }}>{justSaved ? "âœ“ Saved!" : "ðŸ’¾ Save this search"}</button>
          <button onClick={searchJobs} disabled={jobsLoading} style={{
            background: jobsLoading ? "#333" : "#1a1a1a",
            color: "#60a5fa", border: "1px solid #60a5fa",
            borderRadius: "8px", padding: "10px 20px", fontSize: "14px", fontWeight: 700,
            cursor: jobsLoading ? "wait" : "pointer",
          }}>{jobsLoading ? "Searching jobs..." : "ðŸ“‹ Find open roles"}</button>
        </div>
      )}

      {showJobs && (
        <div style={{ background: "#1a1a1a", border: "1px solid #333", borderRadius: "12px", padding: "24px", margin: "16px 0" }}>
          <h3 style={{ margin: "0 0 16px", fontSize: "18px", color: "#fff" }}>
            ðŸ“‹ Open Roles at {company}
            {jobs.length > 0 && <span style={{ color: "#60a5fa", fontSize: "14px", fontWeight: 600, marginLeft: "8px" }}>({jobs.length})</span>}
          </h3>
          {jobsLoading && <p style={{ color: "#888", fontStyle: "italic", margin: 0 }}><span style={{ animation: "pulse 1.5s infinite" }}>â³</span> Searching careers pages...</p>}
          {!jobsLoading && jobs.length === 0 && <p style={{ color: "#666", margin: 0, fontSize: "14px" }}>No open roles found â€” try their careers page directly.</p>}
          {jobs.length > 0 && (
            <div style={{ display: "flex", flexDirection: "column", gap: "8px" }}>
              {jobs.map((job, i) => (
                <div key={i} style={{
                  background: "#111", border: "1px solid #333", borderRadius: "8px",
                  padding: "12px 16px", display: "flex", justifyContent: "space-between", alignItems: "center", flexWrap: "wrap", gap: "8px",
                }}>
                  <div>
                    <p style={{ margin: 0, color: "#fff", fontSize: "14px", fontWeight: 600 }}>{job.title}</p>
                    <p style={{ margin: "2px 0 0", color: "#666", fontSize: "12px" }}>
                      {[job.department, job.location, job.type].filter(Boolean).join(" Â· ")}
                    </p>
                  </div>
                  {job.url && (
                    <a href={job.url} target="_blank" style={{
                      color: "#60a5fa", fontSize: "12px", textDecoration: "none",
                      border: "1px solid #60a5fa", borderRadius: "4px", padding: "4px 10px",
                    }}>View â†’</a>
                  )}
                </div>
              ))}
            </div>
          )}
          <p style={{ color: "#444", fontSize: "11px", margin: "12px 0 0" }}>ðŸ’¡ Open roles are included when generating outreach messages</p>
        </div>
      )}

      <div style={{ margin: "16px 0 48px" }}>
        {people.map((p, i) => (
          <PersonCard key={i} person={p} company={company} onGenerateMessage={generateMessage} />
        ))}
      </div>

      {stage === STAGES.DONE && people.length > 0 && (
        <div style={{ background: "#1a1a1a", border: "1px solid #333", borderRadius: "12px", padding: "20px 24px", marginBottom: "48px", textAlign: "center" }}>
          <p style={{ color: "#888", margin: 0, fontSize: "14px" }}>ðŸŽ¯ Pick 1-3 people, generate a message, tweak it, and send.</p>
          <p style={{ color: "#555", margin: "8px 0 0", fontSize: "12px" }}>No email? Click "ðŸ”® Guess email patterns" on any card.</p>
        </div>
      )}

      <style>{`
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
      `}</style>
    </div>
  );
}

// Mount React component when prospect tab is shown
const prospectRoot = document.getElementById('prospect-root');
let prospectMounted = false;

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.dataset.tab === 'prospect' && !prospectMounted) {
      ReactDOM.createRoot(prospectRoot).render(<ProspectTool />);
      prospectMounted = true;
    }
  });
});
</script>
<!-- Toast Notification -->
<div id="toast" class="toast"></div>
</body>
</html>
